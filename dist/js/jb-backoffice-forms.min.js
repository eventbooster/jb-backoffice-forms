!function(e){"use strict";angular.module("jb.backofficeForms",["jb.formComponents"])}(),function(){"use strict";angular.module("jb.formComponents",["jb.fileDropComponent","jb.apiWrapper","pascalprecht.translate","jb.formEvents"])}(),function(){function e(e,t,n){this.registeredComponents=[],this.scope=n,this.optionsDataHandlers=[],this.getDataHandlers=[],this.$q=e,this.formEvents=t,this.unregistrationHandlers=[]}var t=angular.module("jb.formEvents",[]);t.provider("jbFormEvents",function(){var e={registerComponent:"jb.backoffice-form-event.registerComponent"};this.setEventKey=function(t,n){e[t]=n},this.hasEventKeyAt=function(t){return angular.isDefined(e[t])},this.getEventKeyAt=function(t){return e[t]},this.removeEventKey=function(t){delete e[t]},this.$get=[function(){return Object.freeze(e)}]}),e.prototype.listen=function(){return this.scope.$on(this.formEvents.registerComponent,function(e,t,n){console.log("REGISTRATION OF:",t),t!==this&&(e.stopPropagation(),n.$on("$destroy",function(){this.unregisterComponent(t)}.bind(this)),this.registerComponent(t))}.bind(this)),this},e.prototype.registerComponent=function(e){this.registeredComponents.push(e),e.registerAt(this)},e.prototype.onUnregistration=function(e){this.unregistrationHandlers.push(e)},e.prototype.unregisterComponent=function(e){var t=this.registeredComponents.indexOf(e);t>=0&&(angular.isFunction(e.unregisterAt)?e.unregisterAt(this):console.warn("JBFormComponentsRegistry: Component %o does not know how to react to unlinking",e),this.registeredComponents.splice(t,1),this.unregistrationHandlers.forEach(function(n){n(e,t)}))},e.prototype.getSaveCalls=function(){return this.registeredComponents.reduce(function(e,t){var n=t.getSaveCalls();return e.concat(n)},[])},e.prototype.isValid=function(){for(var e=0;e<this.registeredComponents.length;e++)if(this.registeredComponents[e].isValid()===!1)return!1;return!0},e.prototype.afterSaveTasks=function(e){return this.getAfterSaveTasks(e)},e.prototype.getAfterSaveTasks=function(e){var t=this.registeredComponents.reduce(function(t,n){return angular.isFunction(n.afterSaveTasks)?t.concat(n.afterSaveTasks(e)):t},[]);return this.$q.all(t).then(function(){return e})},e.prototype.beforeSaveTasks=function(e){return this.getBeforeSaveTasks(e)},e.prototype.getBeforeSaveTasks=function(e){var t=this.registeredComponents.reduce(function(t,n){return angular.isFunction(n.beforeSaveTasks)&&t.push(n.beforeSaveTasks(e)),t},[]);return this.$q.all(t).then(function(){return e})},e.prototype.getSelectFields=function(){return this.registeredComponents.reduce(function(e,t){return angular.isFunction(t.getSelectFields)?e.concat(t.getSelectFields()):angular.isDefined(t.select)?e.concat(t.select):e},[])},e.prototype.optionsDataHandler=function(e){return this.$q.all(this.optionsDataHandlers.map(function(t){return this.$q.when(t(e))},this)).then(function(){return e})},e.prototype.registerOptionsDataHandler=function(e){this.optionsDataHandlers.push(e)},e.prototype.registerGetDataHandler=function(e){this.getDataHandlers.push(e)},e.prototype.unregisterGetDataHandler=function(e){this.getDataHandlers.splice(this.getDataHandlers.indexOf(e),1)},e.prototype.unregisterOptionsDataHandler=function(e){this.optionsDataHandlers.splice(this.optionsDataHandlers.indexOf(e),1)},e.prototype.getDataHandler=function(e){this.getDataHandlers.forEach(function(t){t(e)})},e.prototype.distributeIndexed=function(e){this.getDataHandlers.forEach(function(t,n){t(e,n)})},e.prototype.registerYourself=function(e){var t=e||this.scope;t.$parent.$emit(this.formEvents.registerComponent,this,t)},e.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.optionsDataHandler.bind(this)),e.registerGetDataHandler(this.getDataHandler.bind(this))},e.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.optionsDataHandler),e.unregisterGetDataHandler(this.getDataHandler)},t.factory("JBFormComponentsService",["$q","jbFormEvents",function(t,n){return{registryFor:function(i){var o=new e(t,n,i);return o},registerComponent:function(e,t){e.$parent.$emit(n.registerComponent,t,e)}}}])}(),function(){"use strict";var e=angular.module("jb.formComponents");e.directive("jbFormImageComponent",[function(){return{controller:"jbFormImageComponentController",controllerAs:"backofficeImageComponent",bindToController:!0,require:"",link:function(e,t,n,i){i.init(e,t,n)},scope:{propertyName:"@for",pathField:"@",imageModel:"=model",label:"@"},template:'<div class="row"><label jb-form-label-component data-label-identifier="{{backofficeImageComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-component" ><div data-file-drop-component data-supported-file-types="[\'image/jpeg\']" data-model="backofficeImageComponent.images" data-error-handler="backofficeImageComponent.handleDropError(error)"><ol class="clearfix"><li data-ng-repeat="image in backofficeImageComponent.images"><a href="#" data-ng-click="backofficeImageComponent.openDetailView( $event, image )"><img data-ng-attr-src="{{image.url || image.fileData}}"/><button class="remove" data-ng-click="backofficeImageComponent.removeImage($event,image)">&times</button></a><span class="image-size-info" data-ng-if="!!image.width && !!image.height">{{image.width}}&times;{{image.height}} Pixels</span><span class="image-file-size-info" data-ng-if="!!image.fileSize">{{image.fileSize/1000/1000 | number: 1 }} MB</span><span class="focal-point-info" data-ng-if="!!image.focalPoint">Focal Point</span></li><li><button class="add-file-button" data-ng-click="backofficeImageComponent.uploadFile()">+</button></li></ol><input type="file" multiple/></div></div></div>'}}]),e.controller("jbFormImageComponentController",["$scope","$rootScope","$q","$state","APIWrapperService","JBFormComponentsService",function(e,t,n,i,o,r){function a(e){var t;try{t=JSON.parse(e.focalPoint)}catch(n){console.error("jbFormImageComponentController: Could not parse focalPoint JSON",e.focalPoint)}return{url:e[f.pathField],entityUrl:"/image/"+e.id,focalPoint:t,width:e.width,height:e.height,fileSize:e.size,mimeType:e.mimeType.mimeType,id:e.id}}function s(){if(!m||!m.length||f.images&&f.images.length){if(m&&m.length||!f.images||!f.images.length){if(m&&m.length&&f.images&&f.images.length&&m[0].id!==f.images[f.images.length-1].id){var e={};return e[p]=f.images[f.images.length-1].id,[{data:e}]}return console.log("jbFormImageComponentController: No changes made to a single relation image"),[]}var t={};return t[p]=f.images[0].id,[{data:t}]}var n={};return n[p]=null,[{data:n}]}function l(){var e=[],t=[],n=[];return m&&angular.isArray(m)&&m.forEach(function(e){t.push(e.id)}),f.images.forEach(function(e){n.push(e.id)}),t.forEach(function(t){n.indexOf(t)===-1&&e.push({method:"DELETE",url:"/image/"+t})}),n.forEach(function(n){t.indexOf(n)===-1&&e.push({method:"POST",url:"image/"+n})}),console.log("jbFormImageComponentController: Calls to be made are %o",e),e}function c(e){return console.log("jbFormImageComponentController: Upload file %o to /image through a POST request",e),o.request({method:"POST",data:{image:e.file},url:"/image"}).then(function(t){var n=f.images.indexOf(e),i=a(t);return f.images.splice(n,1,i),console.log("jbFormImageComponentController: Image uploaded, replace %o with %o",f.images[n],i),t})}var d,p,u,m,f=this;f.images=[],f.init=function(e,t,n,i){d=t,f.ensureSingleImageRelation(),r.registerComponent(e,f)},f.registerAt=function(e){e.registerOptionsDataHandler(f.updateOptionsData),e.registerGetDataHandler(f.updateData)},f.unregisterAt=function(e){e.unregisterOptionsDataHandler(f.updateOptionsData),e.unregisterGetDataHandler(f.updateData)},f.isValid=function(){return!0},f.ensureSingleImageRelation=function(){e.$watchCollection(function(){return f.images},function(){u&&f.images.length>1&&f.images.splice(0,f.images.length-1)})},f.updateData=function(e){f.images=[],e.image||(e.image=[]),angular.isArray(e.image)||(e.image=[e.image]),m=e.image.slice(),e.image.forEach(function(e){f.images.push(a(e))})},f.selectSpec=function(e){var t,n=e&&e.relations?e.relations:[];if(n.length){t=n.reduce(function(e,t){return"image"===t.remote.resource&&e.push(t),e},[]);for(var i=0;i<t.length;i++){var o=t[i];if(o.name===this.propertyName)return o}}},f.updateOptionsData=function(e){var t=f.selectSpec(e);return t?(u="hasOne"===t.type,void(u&&(p=t.property))):console.error("jbFormImageComponentController: Missing data for %o",f.propertyName)},f.getSelectFields=function(){return[f.propertyName+".*",f.propertyName+"."+f.pathField,f.propertyName+".mimeType.*"]},f.getSaveCalls=function(){return u?s():l()},f.beforeSaveTasks=function(){var e=[];return f.images.forEach(function(t){t.file&&t.file instanceof File&&(console.log("jbFormImageComponentController: New file %o",t),e.push(c(t)))}),console.log("jbFormImageComponentController: Upload %o",e),n.all(e)},f.removeImage=function(e,t){e.preventDefault(),f.images.splice(f.images.indexOf(t),1)},f.openDetailView=function(e,t){e.preventDefault(),t.id&&i.go("app.detail",{entityName:"image",entityId:t.id})},f.handleDropError=function(n){e.$apply(function(){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.imageDropError",variables:{errorMessage:n}})})},f.uploadFile=function(){d.find("input[type='file']").click()}}])}(),function(e){"use strict";var t=angular.module("jb.formComponents");t.directive("jbFormImageDetailComponent",[function(){return{controller:"JBFormImageDetailComponentController",controllerAs:"backofficeImageDetailComponent",bindToController:!0,link:function(e,t,n,i){i.init(e,t,n)},template:'<label data-backoffice-label data-label-identifier="{{backofficeImageDetailComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-detail-component"><div class="image-container"><img data-ng-attr-src="{{backofficeImageDetailComponent.image[ backofficeImageDetailComponent.pathField ]}}" data-ng-click="backofficeImageDetailComponent.setFocalPointClickHandler($event)"/><div class="focal-point-indicator" data-ng-if="backofficeImageDetailComponent.getFocalPoint()" data-ng-attr-style="top:{{backofficeImageDetailComponent.getFocalPointInPercent().y}}%;left:{{backofficeImageDetailComponent.getFocalPointInPercent().x}}%"></div></div><div data-ng-if="!backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPointNotSet" | translate }}</div><div data-ng-if="backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPoint" | translate }}: {{ backofficeImageDetailComponent.getFocalPoint().x }} / {{backofficeImageDetailComponent.getFocalPoint().y}} </div></div>',scope:{pathField:"@",label:"@"}}}]),t.controller("JBFormImageDetailComponentController",["$scope","JBFormComponentsService",function(e,t){var n,i=this;i.image={},i.init=function(e,n,o){t.registerComponent(e,i)},i.isValid=function(){return!0},i.registerAt=function(e){e.registerGetDataHandler(i.updateData)},i.unregisterAt=function(e){e.unregisterGetDataHandler(i.updateData)},i.updateData=function(e){if(i.image=e,e.focalPoint)try{var t=JSON.parse(e.focalPoint);if(!t.x||!t.y)throw new Error("Property x or y missing on "+e.focalPoint);if(t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),isNaN(t.x)||isNaN(t.y))throw new Error("x or y property on focalPoint not an integer (or castable).");i.image.focalPoint=t}catch(o){console.error("JBFormImageDetailComponentController: Could not parse focalPoint "+e.focalPoint+": "+o.message)}n=angular.copy(e.focalPoint)},i.getSelectFields=function(){return"*,mimeType.*,"+i.pathField},i.getSaveCalls=function(){if(!n&&!i.image.focalPoint)return!1;var e=n&&i.image.focalPoint&&n.x&&i.image.focalPoint.x&&i.image.focalPoint.x===n.x,t=n&&i.image.focalPoint&&n.y&&i.image.focalPoint.y&&i.image.focalPoint.y===n.y;if(e&&t)return!1;var o=[];return o.push({method:"PATCH",url:"",data:{focalPoint:JSON.stringify(i.image.focalPoint)}}),o},i.setFocalPointClickHandler=function(e){var t={x:Math.round(e.offsetX/e.target.width*i.image.width),y:Math.round(e.offsetY/e.target.height*i.image.height)};console.log("JBFormImageDetailComponentController: Set focal point to ",JSON.stringify(t)),i.image.focalPoint=t},i.getFocalPoint=function(){return!(!i.image||!i.image.focalPoint)&&i.image.focalPoint},i.getFocalPointInPercent=function(){var e=i.getFocalPoint();return!!e&&{x:Math.round(e.x/i.image.width*100),y:Math.round(e.y/i.image.height*100)}}}])}(),function(e){"use strict";var t=angular.module("jb.formComponents");t.controller("jbFormLabelController",["$scope",function(e){this.$scope=e}]),t.directive("jbFormLabelComponent",["$templateCache","$compile",function(e,t){return{link:function(n,i,o,r){var a=angular.element(e.get("backofficeLabelTemplate.html"));i.replaceWith(a),t(a)(n)},scope:{labelIdentifier:"@",isRequired:"&",isValid:"&"}}}]),t.run(function(e){e.put("backofficeLabelTemplate.html",'<div class="col-md-3"><label class="control-label" data-ng-class="{invalid: !isValid()}"><span data-ng-if="isRequired()||required" class="required-indicator">*</span><span data-translate="{{labelIdentifier}}"></span></label></div>')})}(),function(e){"use strict";function t(e,t,n,i,o,r,a){this.$scope=e,this.api=i,this.$q=t,this.$timeout=n,this.componentsService=o,this.options=null,this.fieldDefinitions=null,this.fields=[],this.selectedLanguages=[],this.locales=[],this.originalLocales=[],this.heightElement=null,this.heightElementInitialized=!1,this.boAPI=a,this.supportedLanguages=(r.get("supported-languages","local")||[]).map(function(e,t){var n=angular.copy(e.language);return n.selected=!1,n},this),this.element=null}var n=angular.module("jb.formComponents");n.directive("jbFormLocaleComponent",function(){return{controller:"JBFormLocaleComponentController",controllerAs:"$ctrl",bindToController:!0,scope:{fieldsExclude:"<",entityName:"@entity",relationName:"@relation"},template:'<div class="locale-component container"><!-- LOCALE-COMPONENT: way too many divs in here --><div class="row"><div class="col-md-12"><ul class="nav nav-tabs col-md-12"><li ng-repeat="language in $ctrl.getSupportedLanguages()" ng-class="{active:$ctrl.isSelected(language)}"><a href="#" ng-click="$ctrl.toggleLanguage($event, language)">{{language.code|uppercase}}<span data-ng-if="$ctrl.checkForTranslation(language)" class="fa fa-check"></span></a></li></ul></div></div><div class="locale-content"><div class="locale-col" ng-repeat="language in $ctrl.getSelectedLanguages()"><p>{{ language.code | uppercase }}</p><ul><li ng-repeat="field in $ctrl.getFields()"><label ng-attr-for="locale-{{language.code}}-{{field.name}}" ng-class="{ \'invalid\' : !$ctrl.fieldIsValid($ctrl.locales[ language.id ], field.name)}"><span data-translate="web.backoffice.{{$ctrl.entityName}}.{{field.name}}"></span><span class="required-indicator" data-ng-show="field.required">*</span></label><textarea ng-model="$ctrl.locales[ language.id ][ field.name ]" ng-attr-id="locale-{{language.code}}-{{field.name}}"class="form-control" ng-keyup="$ctrl.adjustHeight( $event )" ng-click="$ctrl.adjustHeight( $event )" /></textarea></li></ul></div></div></div>',link:{pre:function(e,t,n,i){i.preLink(e,t,n)},post:function(e,t,n,i){i.postLink(e,t,n)}}}}),t.prototype.preLink=function(){},t.prototype.postLink=function(e,t,n){this.componentsService.registerComponent(e,this),this.heightElement=angular.element("<div></div>"),this.heightElement=this.heightElement.attr("id","locale-height-container"),this.heightElement.css("position","absolute"),this.heightElement.css("left","-9999px"),this.heightElement.css("top","-9999px"),this.element=t,this.element.append(this.heightElement)},t.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},t.prototype.getSelectedLanguages=function(){for(var e=[],t=0;t<this.supportedLanguages.length;t++){var n=this.supportedLanguages[t];n.selected===!0&&e.push(n)}return e},t.prototype.getSupportedLanguages=function(){return this.supportedLanguages},t.prototype.fieldIsValid=function(e,t){var n=this.fieldDefinitions[t];return!e||(n.required!==!0||!this._localePropertyIsEmpty(e[t]))},t.prototype.adjustHeight=function(e){var t=angular.element(e.currentTarget);this.adjustElementHeight(t)},t.prototype.adjustElementHeight=function(e){var t,n=e[0].scrollHeight,i=e.val();this.heightElementInitialized||this.initializeHeightElement(e),e.height(n),t=e.width(),this.heightElement.width(t),i=i.replace(/(\n\r?)/g,"<br>").replace(/(\<br\>\s*)$/,"<br><br>"),""==i.trim()&&(i="empty"),this.heightElement.html(i),this.heightElement.width(t),e.height(this.heightElement.height())},t.prototype.adjustAllHeights=function(){this.element.find("textarea").each(function(e,t){this.adjustElementHeight(angular.element(t))}.bind(this))},t.prototype.initializeHeightElement=function(e){["font-size","font-family","font-weight","letter-spacing","line-height","padding-top","padding-left","padding-right","padding-bottom","border-radius","border"].forEach(function(t){this.heightElement.css(t,e.css(t))},this),this.heightElement.css("word-wrap","break-word"),this.heightElementInitialized=!0},t.prototype.toggleLanguage=function(e,t){e&&e.preventDefault();var n=this.getSelectedLanguages();t.selected&&1==n.length||(t.selected=t.selected!==!0,this.$timeout(this.adjustAllHeights.bind(this)))},t.prototype.isSelected=function(e){return e.selected===!0},t.prototype.checkForTranslation=function(e){return!(!this.locales||!angular.isDefined(this.locales[e.id]))},t.prototype.translationIsEmpty=function(e){return this.fields.reduce(function(t,n){return t&&!e[n]&&""!==e[n].trim()},!0)},t.prototype.selectSpec=function(e){var t=e&&e.relations?e.relations:[];if(t.length)for(var n=0;n<t.length;n++){var i=t[n];if("hasManyAndBelongsToMany"===i.type){if(this.entityName===i.remote.resource)return i;if(this.relationName===i.name)return i}}},t.prototype.handleOptionsData=function(e){var t=this.selectSpec(e);return t?(this.options=t,void this.loadFields().then(function(e){this.$timeout(function(){this.fieldDefinitions=this.filterFields(e),this.fields=Object.keys(this.fieldDefinitions)}.bind(this))}.bind(this),function(e){console.error(e)})):console.error("No OPTIONS data found in locale component.")},t.prototype.loadFields=function(){var e="/"+this.getLocaleProperty();return this.fieldDefinitions?this.$q.when(this.fieldDefinitions):this.api.getOptions(e).then(function(e){return e.properties}.bind(this),function(e){console.error(e)})},t.prototype.filterFields=function(e){return e?e.reduce(function(e,t){return this.fieldsExclude&&this.fieldsExclude.indexOf(t.name)!=-1||t.isPrimary===!0||(e[t.name]=t),e}.bind(this),{}):{}},t.prototype._localeIsEmpty=function(e){return this.fields.every(function(t){return this._localePropertyIsEmpty(e[t])},this)},t.prototype._localePropertyIsEmpty=function(e){return angular.isUndefined(e)||""==e.trim()},t.prototype._localeGetChanges=function(e,t){return angular.isDefined(t)?this.fields.reduce(function(n,i){return e[i]!=t[i]&&n.push(i),n}.bind(this),[]):this._localeIsEmpty(e)?[]:this.fields},t.prototype.getSaveCalls=function(){var e=[];return this.locales.forEach(function(t,n){var i=this.originalLocales[n],o=angular.isDefined(i);if(t){var r=this._localeGetChanges(t,i),a=o?"PATCH":"POST";if(r.length>0){var s={};s.data=r.reduce(function(e,n){return e[n]=t[n],e},{}),s.url={},s.url.path="language/"+n,s.url.mainEntity="prepend",s.method=a,e.push(s)}}},this),e},t.prototype.getLocaleProperty=function(){return this.options.via.resource},t.prototype.handleGetData=function(e){var t=e[this.getLocaleProperty()];return t&&(this.originalLocales=this.normalizeModel(t),this.locales=angular.copy(this.originalLocales)),0===this.getSelectedLanguages().length?this.$timeout(function(){this.toggleLanguage(null,this.supportedLanguages[0])}.bind(this)):void this.$timeout(this.adjustAllHeights.bind(this))},t.prototype.getFields=function(){return this.fieldDefinitions?this.fields.map(function(e){return this.fieldDefinitions[e]},this):[]},t.prototype.normalizeModel=function(e){return e.reduce(function(e,t){return e[t.language.id]=t,e},[])},t.prototype.getLocales=function(){return this.locales},t.prototype.getSelectFields=function(){var e=this.getLocaleProperty(),t=[e,"language","*"].join("."),n=[];return n.push([e,"*"].join(".")),n.push(t),n},t.prototype.isValid=function(){return this.locales.reduce(function(e,t,n){return angular.isUndefined(t)?e:angular.isUndefined(this.originalLocales[n])&&this._localeIsEmpty(t)?e:e&&this.fields.reduce(function(e,n){return e&&this.fieldIsValid(t,n)}.bind(this),!0)}.bind(this),!0)},n.controller("JBFormLocaleComponentController",["$scope","$q","$timeout","APIWrapperService","JBFormComponentsService","SessionService","BackofficeAPIWrapperService",t])}(),function(e){"use strict";function t(e){return function(){return{controller:e,controllerAs:"$ctrl",bindToController:!0,link:{pre:function(e,t,n,i){i.preLink(e,t,n)},post:function(e,t,n,i){i.postLink(e,t,n)}},scope:{propertyName:"@for",entityName:"@entity",relationName:"@relation",label:"@",suggestion:"@suggestionTemplate",searchField:"@",changeHandler:"&",filters:"<"}}}}function n(e,t,n,i,o,r){this.subcomponentsService=o,this.options=null,this.originalData=[],this.suggestion="",this.relationService=r,this.$scope=e,this.$compile=n,this.$templateCache=i,this.element=null,this.currentData=[],this.referencedPropertyName=null,this.relationTypes=["hasOne"],this.rendered=!1,this.isWatchingForCallback=!1}function i(e,t,i,o,r,a){n.call(this,e,t,i,o,r,a),this.relationTypes=["hasMany","hasManyAndBelongsToMany"]}var o=angular.module("jb.formComponents");o.directive("jbFormReferenceComponent",[t("JBFormReferenceController")]),o.directive("jbFormRelationComponent",[t("JBFormRelationController")]),n.prototype.preLink=function(){},n.prototype.postLink=function(e,t,n){this.subcomponentsService.registerComponent(e,this),this.element=t},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},n.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},n.prototype.getEndpoint=function(){return this.entityName},n.prototype.handleGetData=function(e){if(this.currentData=[],e&&e[this.relationName]){var t=e[this.relationName];angular.isArray(t)||(t=[t]),this.currentData=t}this.originalData=angular.copy(this.currentData),this.isWatchingForCallback||(this.$scope.$watch(function(){return this.currentData}.bind(this),function(e,t){this.changeHandler&&this.changeHandler({newValue:e,oldValue:t})}.bind(this)),this.isWatchingForCallback=!0),console.log("BackofficeReferenceComponentController: Model updated (updateData) to %o",this.currentData)},n.prototype.getSpec=function(e){var t=e&&e.relations?e.relations:[];if(t.length)for(var n=0;n<t.length;n++){var i=t[n];if(this.relationTypes.indexOf(i.type)!==-1){if(this.propertyName===i.property)return i;if(this.entityName===i.remote.resource)return i;if(this.relationName===i.name)return i}}},n.prototype.handleOptionsData=function(e){if(this.rendered!==!0){var t=this.getSpec(e);return angular.isDefined(t)?(this.propertyName=t.property,this.entityName=t.remote.resource,this.relationName=t.name,this.referencedPropertyName=t.remote.property,this.options=t,this.renderComponent()):console.error("JBFormReferenceController: No options data found for name %o referencing entity %o.",this.propertyName,this.entityName)}},n.prototype.isMultiSelect=function(){return!1},n.prototype.renderComponent=function(){var e=angular.element(this.$templateCache.get("referenceComponentTemplate.html"));e.find("[relation-input]").attr("relation-entity-endpoint",this.getEndpoint()).attr("relation-interactive",this.isInteractive()).attr("deletable","$ctrl.isDeletable()").attr("relation-entity-search-field",this.getSearchField()).attr("relation-suggestion-template",this.getSuggestionTemplate()).attr("multi-select",this.isMultiSelect()).attr("filters","$ctrl.filters").attr("ng-model","$ctrl.currentData"),this.$compile(e)(this.$scope),this.element.prepend(e),this.rendered=!0},n.prototype.addModelTransformations=function(e){return e.attr("sanitize-model",!0)},n.prototype.isInteractive=function(){return!0},n.prototype.isDeletable=function(){return!0},n.prototype.getLabel=function(){return this.label?this.label:this.propertyName},n.prototype.getSelectFields=function(){var e,t=this.relationService.extractSelectFields(this.getSuggestionTemplate());return e=t.map(function(e){return[this.relationName,e].join(".")},this),this.propertyName&&e.unshift(this.propertyName),e},n.prototype.isRequired=function(){return!this.options||this.options.nullable===!0},n.prototype.isMultiSelect=function(){return!1},n.prototype.getSuggestionTemplate=function(){return this.suggestion},n.prototype.getSearchField=function(){return this.searchField},n.prototype.isValid=function(){return!this.isRequired()||this.currentData.length>0},n.prototype.getSaveCalls=function(){var e,t,n=this.currentData[0],i=this.originalData[0];if(n&&(e=n[this.referencedPropertyName]),i&&(t=i[this.referencedPropertyName]),t!==e){var o={data:{}};return o.data[this.propertyName]=angular.isDefined(e)?e:"",[o]}return[]},i.prototype=Object.create(n.prototype),i.prototype.constructor=i,i.prototype.isMultiSelect=function(){return!0},i.prototype.getSaveCalls=function(){var e,t=this.mapProperties(this.currentData,this.propertyName);return e=this.originalData.reduce(function(e,n){var i=n[this.propertyName];return angular.isDefined(t[i])?delete t[i]:e.push({method:"DELETE",url:{path:[this.relationName,i].join("/"),mainEntity:"append"}}),e}.bind(this),[]),Object.keys(t).forEach(function(t){e.push({method:"POST",url:{path:[this.relationName,t].join("/"),mainEntity:"append"}})},this),e},i.prototype.getSelectFields=function(){var e,t=this.relationService.extractSelectFields(this.getSuggestionTemplate());return e=t.map(function(e){return[this.relationName,e].join(".")},this)},i.prototype.mapProperties=function(e,t){return e.reduce(function(e,n){return e[n[t]]=n,e},{})},o.controller("JBFormReferenceController",["$scope","$attrs","$compile","$templateCache","JBFormComponentsService","RelationInputService",n]),o.controller("JBFormRelationController",["$scope","$attrs","$compile","$templateCache","JBFormComponentsService","RelationInputService",i]),o.run(["$templateCache",function(e){e.put("referenceComponentTemplate.html",'<div class="form-group"><label jb-form-label-component label-identifier="{{$ctrl.getLabel()}}" is-required="$ctrl.isRequired()" is-valid="$ctrl.isValid()"></label><div relation-input class="relation-select col-md-9"></div></div>')}])}(),function(e){"use strict";function t(t,n,i,o){this.componentsService=t,this.componentsRegistry=null,this.$compile=n,this.$scope=i,this.type="JBFormRepeating",this.optionData=null,this.$timeout=o,this.entities=[e]}var n=angular.module("jb.formComponents");t.prototype.preLink=function(e){this.componentsRegistry=this.componentsService.registryFor(e),this.componentsRegistry.listen(),this.componentsRegistry.onUnregistration(function(e,t){this.entities.splice(t,1)}.bind(this))},t.prototype.postLink=function(e){this.componentsService.registerComponent(e,this)},t.prototype.getSelectFields=function(){return this.componentsRegistry.getSelectFields()},t.prototype.getSaveCalls=function(){return this.componentsRegistry.getSaveCalls()},t.prototype.afterSaveTasks=function(e){return this.componentsRegistry.afterSaveTasks(e)},t.prototype.beforeSaveTasks=function(e){return this.componentsRegistry.beforeSaveTasks(e)},t.prototype.isValid=function(){return this.componentsRegistry.isValid()},t.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},t.prototype.handleOptionsData=function(e){return this.optionData=e,this.componentsRegistry.optionsDataHandler(e)},t.prototype.handleGetData=function(e){this.$timeout(function(){this.entities.splice(0)}.bind(this),0).then(function(){if(e)return this.$timeout(function(){var t=e[this.entityName]||[];t.forEach(function(e){this.entities.push(e)},this)}.bind(this),0)}.bind(this)).then(function(){return this.$timeout(function(){this.componentsRegistry.optionsDataHandler(this.optionData).then(function(t){var n=this.componentsRegistry.distributeIndexed(e);return n}.bind(this),function(e){})}.bind(this),0)}.bind(this))},t.prototype.addElement=function(){this.entities.push({}),this.$timeout(function(){this.componentsRegistry.optionsDataHandler(this.optionData)}.bind(this))},n.controller("JBFormRepeatingViewController",["JBFormComponentsService","$compile","$scope","$timeout",t]),n.directive("jbFormRepeatingView",["$compile","$parse",function(e,t){return{scope:!0,bindToController:!0,controllerAs:"$ctrl",controller:"JBFormRepeatingViewController",link:{pre:function(e,t,n,i){i.preLink(e)},post:function(n,i,o,r){o.$observe("entityName",function(e){var i=t(e);n.$watch(function(){return i(n.$parent)},function(e){r.entityName=o.entityName})}),r.postLink(n),n.addElement=function(e){e&&(e.preventDefault(),e.stopPropagation()),r.addElement()};var a=angular.element('<div class="button-group"><button class="btn btn-sm btn-default pull-right" ng-click="addElement($event)">{{ "Add Element" | translate }}</button></div>');i.append(a),e(a)(n)}}}}])}(),function(e){"use strict";function t(e){this.formView=e,this.optionsData=null,this.initialId=null,this.parentOptionsData=null}function n(e){this.formView=e,this.optionsData=null,this.initialParentId=null,this.parentId=null,this.parentOptionsData=null,this.itemIndex=0,this.initialize(e)}function i(e,t){this.optionsData=null,this.$q=e,this.formView=t,this.strategy=null}var o=angular.module("jb.formComponents");t.prototype.handleOptionsData=function(e){return this.optionsData=this.formView.getSpecFromOptionsData(e),this.formView.getOptionsData()},t.prototype.beforeSaveTasks=function(){return this.formView.makeSaveRequest()},t.prototype.afterSaveTasks=function(){},t.prototype.getReferencingFieldName=function(){return this.optionsData.property},t.prototype.handleGetData=function(e){var t=e[this.getReferencingFieldName()],n=e[this.formView.getEntityName()];return this.initialId=t,this.formView.setEntityId(t),this.formView.distributeData(n)},t.prototype.getSelectFields=function(){var e=this.formView.getSelectParameters().map(function(e){return[this.formView.getEntityName(),e].join(".")}.bind(this));return[this.getReferencingFieldName()].concat(e)},t.prototype.isValid=function(){return this.formView.isValid()},t.prototype.getSaveCalls=function(){var e=this.formView.generateSaveCalls(),t={};return this.initialId==this.formView.getEntityId()?e:(t.data={},t.data[this.getReferencingFieldName()]=this.formView.getEntityId(),[t].concat(e))},n.prototype.initialize=function(e){var t=this;e.registerComponent({registerAt:function(e){},unregisterAt:function(e){},isValid:function(){},getSaveCalls:function(){var e={data:{}};return t.initialParentId==t.parentId&&angular.isDefined(t.formView.getEntityId())?[]:(e.data[t.getReferencingFieldName()]=t.parentId,[e])}})},n.prototype.handleOptionsData=function(e){return this.optionsData=this.formView.getSpecFromOptionsData(e),this.parentOptionsData=e,this.formView.getOptionsData()},n.prototype.afterSaveTasks=function(e){return this.parentId=e,this.formView.makeSaveRequest()},n.prototype.beforeSaveTasks=function(){},n.prototype.getReferencingFieldName=function(){return this.optionsData.remote.property},n.prototype.handleGetData=function(e,t){var n,i,o,r=e?e[this.formView.getEntityName()]:e;return angular.isDefined(t)&&(this.itemIndex=t),r&&(r.length&&(r=this.getEntityFromData(r)),
o=this.formView.getIdFieldFrom(this.parentOptionsData),n=this.formView.getOwnId(r),i=e[o]),this.initialParentId=i,this.formView.setEntityId(n),this.formView.distributeData(r)},n.prototype.getEntityFromData=function(e){return e[this.itemIndex]},n.prototype.getSelectFields=function(){var e=this.formView.getSelectParameters().map(function(e){return[this.formView.getEntityName(),e].join(".")}.bind(this));return e},n.prototype.isValid=function(){return this.formView.isValid()},n.prototype.getSaveCalls=function(){return[]},i.prototype.getSaveCalls=function(){return this.strategy.getSaveCalls()},i.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},i.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},i.prototype.handleOptionsData=function(e){var t=this.formView.getSpecFromOptionsData(e);return t?(this.strategy=this.createViewAdapterStrategy(t),this.strategy.handleOptionsData(e)):console.error("No options data found for form-view %o",this.formView)},i.prototype.createViewAdapterStrategy=function(e){switch(e.type){case"hasManyAndBelongsToMany":return new JBFormViewMappingStrategy(this.formView);case"hasMany":return new n(this.formView);case"hasOne":default:return new t(this.formView)}},i.prototype.handleGetData=function(e){return this.strategy.handleGetData(e)},i.prototype.beforeSaveTasks=function(){return this.strategy.beforeSaveTasks()},i.prototype.afterSaveTasks=function(e){return this.strategy.afterSaveTasks(e)},i.prototype.getSelectFields=function(){return this.strategy.getSelectFields()},i.prototype.isValid=function(){return this.strategy&&this.strategy.isValid()},o.factory("JBFormViewAdapterService",["$q",function(e){return{getAdapter:function(t){return new i(e,t)}}}])}(),angular.module("jb.formComponents").controller("JBFormViewLoaderController",["$scope","$location","$http","$q","$compile",function(e,t,n,i,o){var r=this,a=t.path(),s=a.split("/");if(!s.length)return void alert("no path provided");var l=s[1],c=s[2];console.log("DetailViewLoader: entity name is %o, id %o",l,c),r.getControllerAndTemplate=function(e,t){if(!e)return!1;var n,i,o=e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),r="src/app/"+o+"/";return t?"new"!==t&&isNaN(parseInt(t,10))?console.error("unknown entity id: %o",t):n=r+o+"-detail.tpl.html":(i="backoffice"+e.substring(0,1).toUpperCase()+e.substring(1)+"ListController",n=r+o+"-list.tpl.html"),{controllerName:i,templateUrl:n}},r.getTemplate=function(e){return n({method:"GET",url:e,headers:{accept:"text/html"}}).then(function(e){return console.log("DetailViewLoader: got template %o",e),e.data},function(e){return i.reject(e)})},r.renderTemplate=function(t,n){var i=$("[ng-view], [data-ng-view]"),r=$("<div></div>");n&&r.attr("data-ng-controller",n),r.html(t),console.log("DetailViewLoader: render Template %o with controller %o",r,n),i.empty().append(r),o(r)(e)},r.init=function(){var e=r.getControllerAndTemplate(l,c);if(!e)return void r.renderTemplate("404 â€“ Page could not be found",!1);var t=e.templateUrl,n=e.controllerName;r.getTemplate(t).then(function(e){r.renderTemplate(e,n)},function(e){var n=$("[ng-view], [data-ng-view]");n.text("Template "+t+" not found. Entity can't be edited")})},r.init()}]),function(e){"use strict";var t=angular.module("jb.formComponents");t.directive("jbFormView",["$compile",function(e){return{link:{pre:function(e,t,n,i){angular.isFunction(i.preLink)&&i.preLink(e,t,n)},post:function(e,t,n,i,o){angular.element('<h1 ng-if="$ctrl.error">{{$ctrl.error}}</h1>');t.addClass("jb-form-view"),i.init(e,t,n)}},controller:"DetailViewController",bindToController:!0,controllerAs:"$ctrl",scope:!0}}]),t.controller("DetailViewController",["$scope","$rootScope","$q","$attrs","$filter","$state","APIWrapperService","JBFormComponentsService","BackofficeAPIWrapperService","JBFormViewAdapterService",function(t,n,i,o,r,a,s,l,c,d){var p,u=this;u.componentsService=l,u.componentsRegistry=null,u.adapterService=d,u.index=0,u.optionData=null,t.$watchGroup(["$ctrl.entityName","$ctrl.entityId"],function(){u.setTitle()}),u.preLink=function(e,t,n){u.componentsRegistry=u.componentsService.registryFor(e),u.componentsRegistry.listen()},u.parseUrl=function(){return{name:a.params.entityName,id:!(!a.params.entityId||"new"===a.params.entityId)&&a.params.entityId,isNew:"new"===a.params.entityId}},u.getEntityId=function(){return t.entityId},u.getEntityName=function(){return t.entityName},u.getEntityUrl=function(){var e="/"+u.getEntityName();return u.getEntityId()&&(e+="/"+u.getEntityId()),e},u.setTitle=function(){var e=u.getEntityName(),n=r("translate")("web.backoffice.create");u.entityId&&(n=r("translate")("web.backoffice.edit"),e=e+" #"+u.entityId),t.title=[n,e].join(": ")},u.init=function(t,n,o){var r=[];if(p=n,u.setEntityId(e),u.isRoot=o.hasOwnProperty("isRoot"),u.hasEntityName=o.hasOwnProperty("entityName"),u.hasEntityId=o.hasOwnProperty("entityId"),u.hasEntityName){var a=i.defer();r.push(a.promise),t.$watch(function(){return o.entityName},function(e){console.info(e),e&&(u.setEntityName(e),a.resolve())})}if(u.hasEntityId){var s=i.defer();r.push(s.promise),t.$watch(function(){return o.entityId},function(e){u.setEntityId(e),s.resolve()})}if(!u.hasEntityName&&!u.hasEntityId){var l=u.parseUrl();u.setEntityName(l.name),u.setEntityId(l.id)}u.componentsService.registerComponent(t,u.adapterService.getAdapter(this)),i.all(r).then(function(){u.isRoot&&u.getOptionData().then(u.checkAccessRights).then(u.getData)["catch"](function(e){console.error(e)})})},u.isNew=function(){return!this.getEntityId()&&0!==this.getEntityId()},u.checkAccessRights=function(e){return e},u.setEntityName=function(e){u.entityName=e,t.entityName=e},u.setEntityId=function(e){u.entityId=e,t.entityId=e},u.internallyHandleOptionsData=function(e){return u.optionData=e,u.componentsRegistry.optionsDataHandler(e)},u.getOptionsData=function(){return u.getOptionData()},u.getSpecFromOptionsData=function(e){for(var t=e&&e.relations&&e.relations.length?e.relations:[],n=0;n<t.length;n++){var i=t[n];if(i.remote.resource===this.entityName)return i}},u.getOptionData=function(){return console.log("DetailView: Make OPTIONS call for %o",u.getEntityName()),u.makeOptionRequest("/"+u.getEntityName()).then(u.internallyHandleOptionsData,function(e){n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.optionsLoadingError",variables:{errorMessage:e}})})},u.makeOptionRequest=function(e){return s.getOptions(e)},u.register=function(e){throw new Error("DEPRECATED")},u.registerComponent=function(e){this.componentsRegistry.registerComponent(e)},u.getSelectParameters=function(){return[this.getOwnIdField()].concat(u.componentsRegistry.getSelectFields())},u.distributeData=function(e){u.componentsRegistry.getDataHandler(e)},u.getData=function(){return u.makeGetRequest().then(u.distributeData,function(e){u.error="Unable to load!!",n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})})},u.updateData=function(){return u.getData()},u.makeGetRequest=function(){var e=u.getEntityUrl(),t=u.getSelectParameters();return console.log("DetailView: Get Data from %o with select %o",e,t),s.request({url:e,headers:{select:t},method:"GET"}).then(function(e){return e}.bind(this),function(e){return i.reject(e)})},t.save=function(e,t,o){return e&&angular.isFunction(e.preventDefault)&&(e.preventDefault(),e.stopPropagation()),u.makeSaveRequest(u.registeredComponents,u.getEntityName()).then(function(e){return u.parseUrl().isNew&&!t&&a.go("app.detail",{entityName:u.getEntityName(),entityId:u.getEntityId()}),t?console.log("DetailViewController: Don't show any message or redirect"):(console.log("DetailViewController: Show success message on %o",n),n.$broadcast("notification",{type:"success",message:"web.backoffice.detail.saveSuccess"})),u.updateData(),e||null})["catch"](function(e){return n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.saveError",variables:{errorMessage:e.message}}),i.reject(e)})},u.isValid=function(){return u.componentsRegistry&&u.componentsRegistry.isValid()},u.makeSaveRequest=function(){return u.isValid()?u.executePreSaveTasks().then(function(e){return u.makeMainSaveCall()}).then(function(e){return u.executePostSaveTasks(e)}):i.reject(new Error("Not all required fields filled out."))},u.executePreSaveTasks=function(){var e={};return e.meta={},u.componentsRegistry.getBeforeSaveTasks(e)},u.beforeSaveTasks=function(e){var t=u.makeSaveRequest();return t},u.executePostSaveTasks=function(e){return u.componentsRegistry.getAfterSaveTasks(e)},u.getIdFieldFrom=function(e){return e&&e.primaryKeys?e.primaryKeys[0]:null},u.getOwnIdField=function(){return this.getIdFieldFrom(this.optionData)},u.getOwnId=function(e){var t;return e?(t=this.getOwnIdField(),t?e[t]:null):null},u.makeMainSaveCall=function(){var e=u.generateSaveCalls();console.log("DetailView: Save calls for %o are %o",this.entityName,e);for(var t,n,o=[],r=0;r<e.length;r++)angular.isObject(e[r].url)||e[r].url&&0!==e[r].url.indexOf("/"+u.getEntityName())?o.push(e[r]):t=e[r];t||u.getEntityId()||(t={method:"POST",url:"/"+u.getEntityName()}),console.log("DetailView: Main save call is %o, other calls are %o",t,o);var a=null;return u.executeSaveRequest(t).then(function(e){n=e,console.log("DetailView: Made main save call; got back %o",n),a=u.getOwnId(n),a&&u.setEntityId(a);var t=[];return o.forEach(function(e){t.push(u.executeSaveRequest(e))}),i.all(t)}).then(function(){return u.getEntityId()})},u.addCall=function(e,t){e.url||(e.url=u.getEntityUrl()),e.method||(/\/\d*\/?$/.test(e.url)?e.method="PATCH":e.method="POST");var n=this.getSaveCall(t,e.method,e.url);if(e.hasOwnProperty("headers")&&(n=!1),n){if(e.data)for(var i in e.data)n.data[i]=e.data[i]}else n={method:e.method,url:e.url,data:e.data,headers:e.headers||{}},t.push(n)},u.getSaveCall=function(e,t,n){var i=!1;return e.some(function(e){var o=e.url===n||!e.url&&!n,r=e.method.toLowerCase()===t.toLowerCase();if(r&&o)return i=e,!0}),i},u.executeSaveRequest=function(e){if(!e)return console.log("DetailView: No call to be made"),i.when(e);var t;if(angular.isObject(e.url)){if(!e.url.path)return console.error("DetailViewController: url property is missing on path on %o",e),i.reject("Got invalid call data, path property missing on url for "+JSON.stringify(e));var n=u.getEntityId()?u.getEntityName()+"/"+u.getEntityId():u.getEntityName(),o=e.url.path.replace(/^\/*/,"").replace(/\/*$/,"");t="prepend"===e.url.mainEntity?"/"+n+"/"+o:"append"===e.url.mainEntity?"/"+o+"/"+n:e.url.path}else e.url&&0===e.url.indexOf("/")?t=e.url:(t="/"+u.getEntityName(),u.getEntityId()&&(t+="/"+u.getEntityId()),e.url&&(t+="/"+e.url));return console.log("DetailView: Make %s call to %s with %o. Call is %o, entityName is %o.",e.method,t,e.data,e,u.getEntityName()),e.data||(e.data={}),s.request({url:t,data:e.data,method:e.method,headers:e.headers})},u.generateSaveCalls=function(){var e=u.componentsRegistry.getSaveCalls().reduce(function(e,t){return u.addCall(t,e),e},[]);return e},t["delete"]=function(e,t){e&&(e.preventDefault(),e.stopPropagation()),console.log("DetailView: Delete");var o=!1,s=r("translate")("web.backoffice.detail.confirmDeletion");if(s+="\n"+u.getEntityName()+"("+u.getEntityId()+")",o=confirm(s))return u.makeDeleteRequest().then(function(e){return t||(a.go("app.list",{entityName:u.getEntityName()}),n.$broadcast("notification",{type:"success",message:"web.backoffice.detail.deleteSuccess"})),!0},function(e){return t||n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.deleteError",variables:{errorMessage:e}}),i.reject(e)})},u.makeDeleteRequest=function(){console.log("DetailView: Make DELETE request");var e=i.when();return u.isNew()||(e=s.request({url:"/"+u.getEntityName()+"/"+u.getEntityId(),method:"DELETE"})),e.then(function(){return t.$destroy()})}}])}(),function(){"use strict";function e(e,t,n,i,o){this.$scope=e,this.$attrs=t,this.$compile=n,this.fieldTypes=i,this.name=t["for"],this.label=this.name,this.subcomponentsService=o,this.registry=null}var t="jb.formAutoInputTypes",n=angular.module("jb.formComponents");n.value(t,{text:"text",number:"text",string:"text","boolean":"checkbox",datetime:"date-time",date:"date-time"}),n.directive("jbFormAutoInput",["$compile",function(e){return{controllerAs:"$ctrl",bindToController:!0,restrict:"E",link:{post:function(e,t,n,i){i.init(e,t,n)},pre:function(e,t,n,i){i.preLink(e,t,n)}},controller:"JBFormAutoInputController",scope:{label:"@"}}}]),e.prototype.preLink=function(e,t,n){this.registry=this.subcomponentsService.registryFor(e),this.registry.listen()},e.prototype.init=function(e,t,n){this.element=t,this.registry.registerOptionsDataHandler(this.updateElement.bind(this)),this.registry.registerYourself()},e.prototype.selectOptions=function(e){var t=e?e.properties:e;if(t&&t.length)for(var n=0;n<t.length;n++)if(t[n].name==this.name)return t[n]},e.prototype.updateElement=function(e){var t,n=this.selectOptions(e);if(!n||!n.type)return void console.error("AutoFormElement: fieldSpec %o is missing type for field %o",e,this.name);if(t=this.fieldTypes[n.type],!t)return console.error("AutoFormElement: Unknown type %o",e.type),void console.error("AutoFormElement: elementType missing for element %o",this.element);console.log("AutoFormElement: Create new %s from %o",t,e);var i=t.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),o=angular.element("<div jb-form-"+i+'-input for="'+this.name+'" label="'+this.label+'"></div>');return this.element.replaceWith(o),this.registry.unregisterOptionsDataHandler(this.updateElement),this.$compile(o)(this.$scope),this.registry.optionsDataHandler(e)},n.controller("JBFormAutoInputController",["$scope","$attrs","$compile",t,"JBFormComponentsService",e])}(),function(e){"use strict";var t=function(e,t,n){this.$attrs=t,this.$scope=e,this.name=t["for"],this.label=this.name,t.$observe("label",function(e){this.label=e}.bind(this)),this.subcomponentsService=n};t.prototype.updateData=function(e){this.originalData=this.$scope.data.value=e[this.name]},t.prototype.getSelectFields=function(){return this.name},t.prototype.getSaveCalls=function(){if(this.originalData===this.$scope.data.value)return[];var e={};return e[this.$scope.data.name]=this.$scope.data.value===!0,[{data:e}]},t.prototype.preLink=function(t,n,i){t.data={value:e,name:this.name,valid:!0}},t.prototype.isValid=function(){return!0},t.prototype.isRequired=function(){return!1},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterGetDataHandler(this.updateData)},t.prototype.init=function(e,t,n){this.subcomponentsService.registerComponent(e,this)};var n=angular.module("jb.formComponents");n.directive("jbFormCheckboxInput",[function(){return{scope:!0,controller:"JBFormCheckboxInputController",bindToController:!0,controllerAs:"$ctrl",link:{pre:function(e,t,n,i){i.preLink(e,t,n,i)},post:function(e,t,n,i){i.init(e,t,n)}},template:'<div class="form-group"><label jb-form-label-component data-label-identifier="{{$ctrl.label}}" data-is-valid="$ctrl.isValid()" data-is-required="$ctr.isRequired()"></label><div class="col-md-9"><div class="checkbox"><input type="checkbox" data-ng-model="data.value"/></div></div></div>'}}]),n.controller("JBFormCheckboxInputController",["$scope","$attrs","JBFormComponentsService",t])}(),function(e){"use strict";function t(e){return e<10?"0"+e:e}var n=function(t,n,i){this.$attrs=n,this.$scope=t,this.subcomponentsService=i,this.originalData=e,this.date=e,this.time=!1,this.required=!0};n.prototype.getSelectFields=function(){return[this.name]},n.prototype.isRequired=function(){return this.required===!0},n.prototype.isValid=function(){return!this.isRequired()||!!this.date},n.prototype.updateData=function(t){var n=t?t[this.name]:t;this.date=n?new Date(n):e,this.originalData=this.date},n.prototype.getSaveCalls=function(){var e=this.date,n=this.originalData,i={data:{}},o="";return e||n?e&&n&&e.getTime()==n.getTime()?[]:(e&&(o=e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())),i.data[this.name]=o,[i]):[]},n.prototype.init=function(e){this.subcomponentsService.registerComponent(e,this)},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.updateData.bind(this))},n.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.updateData)},n.prototype.selectSpec=function(e){var t=e&&e.properties?e.properties:[];if(t.length)for(var n=0;n<t.length;n++){var i=t[n];if(i.name===this.name)return i}},n.prototype.handleOptionsData=function(e){var t=this.selectSpec(e);return t?(this.required=t.nullable===!1,this.time="datetime"===t.type,void(this.showDate="time"!==t.type)):console.error("JBFormDateTimeInputController: No field spec for %o",this.name)},n.prototype.showTime=function(){return this.time};var i=angular.module("jb.formComponents");i.directive("jbFormDateTimeInput",[function(){return{scope:{label:"@",name:"@for"},controller:"JBFormDateTimeInputController",bindToController:!0,controllerAs:"$ctrl",link:function(e,t,n,i){i.init(e,t,n)},template:'<div class="form-group form-group-sm"><label jb-form-label-component data-label-identifier="{{$ctrl.label}}" data-is-required="$ctrl.isRequired()" data-is-valid="$ctrl.isValid()"></label><div data-ng-class="{ \'col-md-9\': !$ctrl.showTime(), \'col-md-5\': $ctrl.showTime() }"><input type="date" class="form-control input-sm input-date" data-ng-model="$ctrl.date"></div><div class="col-md-4" data-ng-if="$ctrl.showTime()"><input type="time" class="form-control input-sm input-time" data-ng-model="$ctrl.date" /></div></div>'}}]),i.controller("JBFormDateTimeInputController",["$scope","$attrs","JBFormComponentsService",n])}(),function(e){"use strict";angular.module("jb.backofficeHiddenInput",[]).directive("hiddenInput",[function(){return{controller:"HiddenInputController",link:function(e,t,n,i){i.init(e,t,n,i)},scope:!0}}]).controller("HiddenInputController",["$scope","$attrs","JBFormComponentsService",function(e,t,n){var i,o,r=this;r.init=function(e,t,o){i=t,n.registerComponent(e,r)},r.isValid=function(){return!0},r.registerAt=function(e){},console.log("HiddenInput: for is %o, read %o (hasProperty %o) evals to %o",t["for"],t.read,t.hasOwnProperty("read"),e.$parent.$eval(t.read)),r.getSelectFields=function(){return!t.hasOwnProperty("read")||e.$parent.$eval(t.read)?[t["for"]]:[]},r.getSaveCalls=function(){var n=!t.hasOwnProperty("write")||e.$parent.$eval(t.write);if(console.log("HiddenInput: Get save calls; $attrs.data is %o, writeData is %o, data-write is %o and evals to %o",t.data,n,t.write,e.$parent.$eval(t.write)),n&&t.data){var i=t["for"]&&t["for"].indexOf(".")>-1;if(i){var r=t["for"].substring(0,t["for"].lastIndexOf(".")),a=r+"/"+t.data;return console.log("HiddenInput: Store relation %o",a),{url:a,method:"POST"}}var s={};return s[t["for"]]=t.data,console.log("HiddenInput: Store data %o",s),{url:"",data:s,method:o.getEntityId()?"PATCH":"POST"}}return!1}}])}(),function(e){"use strict";var t=function(t,n,i,o){this.$scope=t,this.$attrs=n,this.name=n["for"],this.$q=i,this.label=this.name,this.select=this.name,this.componentsService=o,this.originalData=e,this.required=!0,this.options};t.prototype.isRequired=function(){return this.required===!0},t.prototype.isValid=function(){return!this.isRequired()||!!this.$scope.data.value},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this)),e.registerOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterGetDataHandler(this.updateData.bind(this)),e.unregisterOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.selectOptions=function(e){var t=e?e.properties:e;if(t&&t.length)for(var n=0;n<t.length;n++)if(t[n].name==this.name)return t[n]},t.prototype.handleOptionsData=function(e){var t=this.selectOptions(e);return angular.isDefined(t)?(this.options=t,void(this.required=t.nullable===!1)):console.error("No options data available for text-field %o",this.name)},t.prototype.init=function(e){this.componentsService.registerComponent(e,this)},t.prototype.preLink=function(t){t.data={name:this.name,value:e,valid:!1}},t.prototype.updateData=function(e){e&&(this.originalData=this.$scope.data.value=e[this.name])},t.prototype.getSaveCalls=function(){if(this.originalData===this.$scope.data.value)return[];var e={};return e[this.name]=this.$scope.data.value,[{data:e}]};var n=angular.module("jb.formComponents");n.controller("JBFormTextInputController",["$scope","$attrs","$q","JBFormComponentsService",t]),n.directive("jbFormTextInput",[function(){return{scope:{label:"@",name:"@for"},controllerAs:"$ctrl",bindToController:!0,link:{post:function(e,t,n,i){i.init(e,t,n)},pre:function(e,t,n,i){i.preLink(e,t,n)}},controller:"JBFormTextInputController",template:'<div class="form-group form-group-sm"><label jb-form-label-component data-label-identifier="{{$ctrl.label}}" data-is-valid="$ctrl.isValid()" data-is-required="$ctrl.isRequired()"></label><div class="col-md-9"><input type="text" data-ng-attr-id="data.name" class="form-control input-sm" data-ng-attrs-required="$ctrl.isRequired()" data-ng-model="data.value"/></div></div>'}}])}(),angular.module("jb.fileDropComponent",[]).directive("fileDropComponent",[function(){return{require:["fileDropComponent"],controller:"FileDropComponentController",controllerAs:"fileDropComponent",bindToController:!0,link:function(e,t,n,i){i[0].init(t)},scope:{supportedFileTypes:"=",files:"=model",errorHandler:"&",maxFileCount:"@"}}}]).controller("FileDropComponentController",["$scope",function(e){function t(e){p.errorHandler&&angular.isFunction(p.errorHandler)&&p.errorHandler({error:e})}function n(){d.bind("drop",o).bind("dragover",i).bind("dragenter",i).bind("dragleave",r)}function i(e){return e.preventDefault(),e.originalEvent.dataTransfer.effectAllowed="copy",!1}function o(e){e.preventDefault();var t=e.originalEvent.dataTransfer.files;return s(t),!1}function r(e){}function a(){d.find("input[type='file']").change(function(e){return e.target.files&&e.target.files.length?void s(e.target.files):void console.log("BackofficeImageComponentController: files field on ev.target missing: %o",e.target)})}function s(e){for(var n=[],i=0;i<e.length;i++){var o=e[i];l(o)?c(o):n.push(o.name)}n.length&&(console.warn("FileDropComponentController: Invalid file ",JSON.stringify(n)),t(new Error("Tried to upload files with invalid file type: "+n.join(", ")+". Allowed are "+p.supportedFileTypes.join(", "))+"."))}function l(e){return!p.supportedFileTypes||!angular.isArray(p.supportedFileTypes)||p.supportedFileTypes.indexOf(e.type)>-1}function c(t){var n=new FileReader;n.onload=function(i){var o={file:t,fileSize:t.size,mimeType:t.type,height:void 0,width:void 0,fileData:i.target.result};try{var r=new Image;r.src=n.result,r.onload=function(){var t=this;e.$apply(function(){o.width=t.width,o.height=t.height})}}catch(a){console.error("FileDropComponentController: Error reading file: %o",a)}e.$apply(function(){p.files.push(o)})},n.readAsDataURL(t)}var d,p=this;p.files=[],p.state="undefined",p.init=function(e,t){d=e,n(),a()}}]),function(){"use strict";angular.module("jb.formComponents").directive("jbFormDataComponent",[function(){return{require:["backofficeDataComponent","^detailView"],controller:"JBFormDataComponentController",controllerAs:"backofficeDataComponent",bindToController:!0,templateUrl:"backofficeDataComponentTemplate.html",link:function(e,t,n,i){i[0].init(t,i[1])},scope:{propertyName:"@for",fields:"="}}}]).controller("JBFormDataComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,i){var o,r,a=this,s={};a.init=function(e,t){o=e,r=t,r.registerOptionsDataHandler(a.updateOptionsData),r.registerGetDataHandler(a.updateData)},a.checkFields=function(){if(!angular.isArray(a.fields))throw new Error("JBFormDataComponentController: fields passed is not an array: "+JSON.stringify(a.fields));return a.fields.forEach(function(e){if(!angular.isObject(e))throw new Error("JBFormDataComponentController: field passed is not an object: "+JSON.stringify(e));if(!e.name)throw new Error("JBFormDataComponentController: field is missing name property: "+JSON.stringify(e))}),!0},a.updateData=function(e){if(a.checkFields()){if(e[a.propertyName])try{angular.isString(e[a.propertyName])?s=JSON.parse(e[a.propertyName]):angular.isObject(e[a.propertyName])?s=angular.copy(e[a.propertyName]):e[a.propertyName]||(s={})}catch(t){console.error("JBFormDataComponentController: Could not parse data "+e[a.propertyName])}a.fields.forEach(function(e){e.values.indexOf(void 0)===-1&&e.values.push(void 0),s[e.name]&&(e.selected=s[e.name])})}},a.updateOptionsData=function(e){return e[a.propertyName]?void r.register(a):void console.error("JBFormDataComponentController: Missing OPTIONS data for %o in %o",a.propertyName,e)},a.getSelectFields=function(){return[a.propertyName]},a.getSaveCalls=function(){var e=!1;if(a.fields.forEach(function(t){s[t.name]!==t.selected&&(e=!0)}),!e)return console.log("JBFormDataComponentController: No changes made."),!1;var t=s?angular.copy(s):{};return a.fields.forEach(function(e){void 0===e.selected&&t[e.name]?delete t[e.name]:void 0!==e.selected&&(t[e.name]=e.selected)}),console.log("JBFormDataComponentController: Store changes %o",t),{data:{data:JSON.stringify(t)}}}}]).run(["$templateCache",function(e){e.put("backofficeDataComponentTemplate.html","<div class='form-group form-group-sm' data-ng-repeat=\"field in backofficeDataComponent.fields\"><label data-backoffice-label data-label-identifier='{{field.name}}' data-is-required='false' data-is-valid='true'></label><div class='col-md-8'><select class='form-control' data-ng-options='value for value in field.values' data-ng-model='field.selected'></select></div><div class='col-md-1'></div></div>")}])}(),function(){"use strict";angular.module("jb.formComponents").directive("jbFormMediaGroupComponent",[function(){return{require:["backofficeMediaGroupComponent","^detailView"],controller:"JBFormMediaGroupComponentController",controllerAs:"backofficeMediaGroupComponent",bindToController:!0,templateUrl:"backofficeMediaGroupComponentTemplate.html",link:function(e,t,n,i){i[0].init(t,i[1])},scope:{propertyName:"@for"}}}]).controller("JBFormMediaGroupComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,i){function o(e,t){var n=e.mediumGroup_medium[0].sortOrder,i=t.mediumGroup_medium[0].sortOrder;return n<i?-1:1}function r(){var e=-1;return l.media.forEach(function(t){t.mediumGroup_medium&&t.mediumGroup_medium.length&&(e=Math.max(e,t.mediumGroup_medium[0].sortOrder))}),e}var a,s,l=this,c=[],d=["*","video.*","video.videoType.*","image.*","mediumGroup_medium.*","mediumGroup.*"];l.media=[],l.addMediumModel=[],l.init=function(e,t){a=e,s=t,s.registerOptionsDataHandler(l.updateOptionsData),s.registerGetDataHandler(l.updateData),l.setupAddMediumModelWatcher(),l.setupOrderChangeListener()},l.updateData=function(e){if(e[l.propertyName]){var t=e[l.propertyName]||[];try{l.media=t.sort(o)}catch(n){console.error("JBFormMediaGroupComponentController: Properties mediumGroup_medium, it's items or sortOrder missing"),l.media=t}c=angular.copy(l.media)}},l.setupOrderChangeListener=function(){a[0].addEventListener("orderChange",function(e){l.media.splice(e.detail.newOrder,0,l.media.splice(e.detail.oldOrder,1)[0])})},l.setupAddMediumModelWatcher=function(){e.$watch(function(){return l.addMediumModel},function(e){1===l.addMediumModel.length&&(l.addMedium(e[0].id),l.addMediumModel=[])},!0)},l.addMedium=function(e){return l.media.filter(function(t){return t.id===e}).length>0?void console.error("JBFormMediaGroupComponentController: Trying to add duplicate with id",e):void i.request({url:"/"+l.propertyName+"/"+e,method:"GET",headers:{select:l.getSelectFields()}}).then(function(e){l.media.push(e)},function(n){console.error("JBFormMediaGroupComponentController: Could not get data for medium with id %o: %o",e,n),t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:n}})})},l.updateOptionsData=function(e){s.register(l)},l.getSelectFields=function(){return d.map(function(e){return l.propertyName+"."+e})},l.getSaveCalls=function(){console.error(c);var e=c.map(function(e){return e.id}),t=l.media.map(function(e){return e.id}),n=[],i=[];t.forEach(function(t){e.indexOf(t)===-1&&n.push(t)}),e.forEach(function(e){t.indexOf(e)===-1&&i.push(e)});var o=[];return i.forEach(function(e){o.push({method:"DELETE",url:l.propertyName+"/"+e})}),n.forEach(function(e){o.push({method:"POST",url:l.propertyName+"/"+e})}),o},l.afterSaveTasks=function(){var e=r(),t=[];return l.media.forEach(function(n){t.push(i.request({url:"/mediumGroup/"+s.getEntityId()+"/medium/"+n.id,method:"PATCH",data:{sortOrder:++e}}))}),n.all(t)},l.isValid=function(){return!0},l.isRequired=function(){return!1},l.removeMedium=function(e){l.media.splice(l.media.indexOf(e),1)}}]).run(["$templateCache",function(e){e.put("backofficeMediaGroupComponentTemplate.html","<div class='backoffice-media-group-component'><div class='row'><div class='col-md-12'><ol class='clearfix' data-drag-drop-list><li data-ng-repeat='medium in backofficeMediaGroupComponent.media' draggable='true'><div data-ng-if='medium.image'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='{{medium.image.url}}'></div><div data-ng-if='medium.video && medium.video.videoType.identifier === \"youtube\"'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='http://img.youtube.com/vi/{{medium.video.uri}}/0.jpg'></div></li></ol></div></div><div class='row'><div class='col-md-12'><div class=\"relation-select\" data-relation-input data-ng-attr-data-relation-entity-endpoint=\"{{backofficeMediaGroupComponent.propertyName}}\" data-relation-interactive=\"false\" data-deletable=\"false\" data-relation-entity-search-field=\"title\" data-relation-suggestion-template=\"[[title]] <img src='[[image.url]]'/>\" data-ng-model=\"backofficeMediaGroupComponent.addMediumModel\" data-multi-select=\"true\"></div></div></div></div>")}])}(),angular.module("jb.formComponents").directive("jbFormTreeComponent",[function(){return{require:["^detailView","backofficeTreeComponent"],controller:"JBFormJBFormTreeComponentController",link:function(e,t,n,i){i[1].init(t,i[0])},templateUrl:"treeTemplate.html",scope:{filter:"=treeComponentFilter",labelName:"@treeComponentLabel",entityName:"@for",maxDepth:"@"},bindToController:!0,controllerAs:"treeComponentController"}}]).controller("JBFormTreeComponentController",["$scope","$rootScope","$attrs","$location","$q","APIWrapperService",function(e,t,n,i,o,r){var a,s,l=this;n.maxDepth||10;l.dataTree=void 0,l.labelName&&l.entityName||console.warn("JBFormTreeComponentController: labelName or entityName (for) attribute missing"),l.editEntity=function(e,t){e.preventDefault(),i.path("/"+n["for"]+"/"+t)},l.init=function(e,t){a=e,s=t,s.register(l),l.getData()},l.getData=function(){var e={range:"0-0"};if(l.filter){var n="";for(var i in l.filter)n=i+"="+l.filter[i];e.filter=n}r.request({method:"GET",url:"/"+l.entityName,headers:e}).then(function(e){l.updateData(e)},function(e){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})})},l.updateData=function(e){l.dataTree=c(e),console.log("JBFormTreeComponentController: dataTree is %o",l.dataTree),setTimeout(function(){a.addClass("dd"),a.nestable({dragClass:"dd-dragelement",placeClass:"dd-placeholder",maxDepth:l.maxDepth})},500)},l.getSaveCalls=function(){var e=a.nestable("serialize");console.log("JBFormTreeComponentController: Store data %o",e);
var t=l.cleanTreeData(e);return console.log("JBFormTreeComponentController: Cleaned data %o, got %o",e,t),{method:"POST",headers:{"Content-Type":"application/json"},url:"/"+l.entityName,data:t}},l.cleanTreeData=function(e,t){t||(t=[]);for(var n in e){var i=e[n],o={};if(o.id=i.id,l.filter)for(var r in l.filter)o[r]=l.filter[r];i.children&&(o.children=[],l.cleanTreeData(i.children,o.children)),t.push(o)}return t};var c=function(e){var t={};return e.sort(function(e,t){return e.left-t.left}),d(t,e),t.children},d=function(e,t){var n,i="right",o=0,r=[];e.children||(e.children=[]),t.forEach(function(t){t[i]>o?(o=t[i],r=[],e.children.push(t),n=t):t[i]+1===o?(r.push(t),d(n,r)):r.push(t)})}}]).run(function(e){e.put("treeBranchTemplate.html","<div class='dd-handle'><span data-ng-if='branch[ treeComponentController.labelName ]'>{{ branch[ treeComponentController.labelName ] }}</span><span data-ng-if='!branch[ treeComponentController.labelName ]'>N/A</span></div><button class='fa fa-pencil btn btn-link edit' data-ng-click='treeComponentController.editEntity($event,branch.id)'></button><ol data-ng-if='branch.children' class='dd-list'><li data-ng-repeat='branch in branch.children' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>"),e.put("treeTemplate.html","<ol><li data-ng-repeat='branch in treeComponentController.dataTree' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>")}),function(e){"use strict";function t(e){this.api=e,this.fieldTypeMapping={string:"text",decimal:"number",integer:"number","boolean":"boolean",json:"json",datetime:"datetime",date:"datetime"}}var n=angular.module("jb.backofficeAPIWrapper",["jb.apiWrapper"]);t.prototype.request=function(e,t,n){var i=n!==!1&&e?angular.copy(t):t;return i.method=e,this.api.request(i)},t.prototype.getOptions=function(e,t){var n=angular.copy(t)||{};return n.url=e,this.request("OPTIONS",n,!1).then(this.normalizeOptions.bind(this))},t.prototype.normalizeMappings=function(e,t){Object.keys(e).forEach(function(n){var i=e[n],o={};o.type="relation",o.entity=i.modelName,o.relationKey=i.key,o.relatedKey=i.primaryKey,o.relation=i.hasAlias?i.name:i.modelName,o.alias=!!i.hasAlias&&i.name,o.relationType="multiple",o.originalRelation="hasMany",o.tableName=i.table.name,"language"===o.entity&&(o.type="language"),"image"===o.entity&&(o.type="image"),t[n]=o,t.internalMappings=t.internalMappings||{},t.internalMappings[o.relation]=o})},t.prototype.normalizeReferences=function(e,t){Object.keys(e).forEach(function(n){var i=e[n],o={};o.type="relation",o.entity=i.referencedModelName,o.relation=i.hasAlias?i.name:i.referencedModelName,o.alias=!!i.hasAlias&&i.name,o.relationType="single",o.required=i.nullable===!1,o.originalRelation="hasOne",o.relationKey=i.key,o.relatedKey=i.referencedColumn,t[n]=o,t.internalReferences=t.internalReferences||{},t.internalReferences[o.relationKey]=o,"image"==o.entity&&(o.type="image")})},t.prototype.normalizeInverseReferences=function(e,t){Object.keys(e).forEach(function(n){var i=e[n];t[n]={type:"relation",entity:i.modelName,relation:i.hasAlias?i.name:i.modelName,relatedKey:i.referencedColumn,relationKey:i.targetColumn,alias:!!i.hasAlias&&i.name,relationType:"multiple",required:!1,originalRelation:"belongsTo"}})},t.prototype.normalizeFields=function(e,t){Object.keys(e).forEach(function(n){var i=e[n];if(i.name&&i.type){var o=this.fieldTypeMapping[i.type];if(angular.isDefined(o)){var r={type:o,required:!i.nullable,isPrimary:i.name===e.primaryKey,name:i.name};"datetime"==o&&(r.time="datetime"===i.type),t[n]=r,angular.isUndefined(t.internalFields)&&(t.internalFields={}),t.internalFields[i.name]=r}else console.error("DetailViewController: unknown field type %o",i.type)}},this),angular.isUndefined(t.internalFields[e.primaryKey])&&(t.internalFields[e.primaryKey]={type:"",required:!0,isPrimary:!0,name:e.primaryKey})},t.prototype.normalizeOptions=function(e){var t={},n=angular.copy(e),i=n.hasMany,o=n.belongsTo,r=n.hasOne;return delete n.hasMany,delete n.belongsTo,delete n.hasOne,this.normalizeReferences(r,t),this.normalizeInverseReferences(o,t),this.normalizeMappings(i,t),this.normalizeFields(n,t),console.log("BackofficeAPIWrapperService: parsed options are %o",t),t},n.service("BackofficeAPIWrapperService",["APIWrapperService",t])}(),function(){"use strict";angular.module("jb.formComponents").directive("dragDropList",[function(){return{link:function(t,n,i,o){var r,a=new MutationObserver(function(t){var i=0;[].forEach.call(t,function(e){e.addedNodes&&e.addedNodes.length&&(i+=e.addedNodes.length)}),i>0&&(r.destroy(),r=new e(n[0].querySelectorAll('[draggable="true"]')))});a.observe(n[0],{childList:!0}),t.$on("$destroy",function(){a.disconnect()}),r=new e(n[0].querySelectorAll('[draggable="true"]'))},scope:{}}}]);var e;!function(){function t(e){e.removeEventListener("dragstart",i)}function n(e){e.addEventListener("dragstart",i),e.addEventListener("dragenter",o),e.addEventListener("dragover",a),e.addEventListener("dragleave",r),e.addEventListener("drop",s),e.addEventListener("dragend",c)}function i(e){e.currentTarget.style.opacity="0.4",p=e.currentTarget,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.currentTarget.outerHTML)}function o(e){e.target.classList.add("drag-over")}function r(e){e.target.classList.remove("drag-over")}function a(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}function s(e){e.stopPropagation&&e.stopPropagation();var t=l(p);if(p!==e.currentTarget){console.log("dragDropList: Drop: %o after %o",p,e.currentTarget),angular.element(e.currentTarget).after(p);var n=new CustomEvent("orderChange",{bubbles:!0,detail:{oldOrder:t,newOrder:l(e.currentTarget)+1}});e.currentTarget.dispatchEvent(n)}return!1}function l(e){for(var t=e.parentNode.childNodes,n=0,i=0;i<t.length;i++){if(e===t[i])return n;1===t[i].nodeType&&n++}return-1}function c(e){p.style.opacity="1",p=void 0,[].forEach.call(d,function(e){e.classList.remove("drag-over")})}var d,p;e=function(e){d=e,console.log("DragDropList: Initialize for elements %o",e),[].forEach.call(e,function(e){e.setAttribute("draggable",!0),n(e)})},e.prototype.destroy=function(){console.log("DragDropList: Destroy event handlers on %o elements",d.length),[].forEach.call(d,function(e){t(e)})}}()}(),function(e,t,n,i){function o(t,i){this.w=e(n),this.el=e(t),this.options=e.extend({},s,i),this.init()}var r="ontouchstart"in n,a=function(){var e=n.createElement("div"),i=n.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",i.appendChild(e);var o=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return i.removeChild(e),!!o}(),s={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};o.prototype={init:function(){var n=this;n.reset(),n.el.data("nestable-group",this.options.group),n.placeEl=e('<div class="'+n.options.placeClass+'"/>'),e.each(this.el.find(n.options.itemNodeName),function(t,i){n.setParent(e(i))}),n.el.on("click","button",function(t){if(!n.dragEl){var i=e(t.currentTarget),o=i.data("action"),r=i.parent(n.options.itemNodeName);"collapse"===o&&n.collapseItem(r),"expand"===o&&n.expandItem(r)}});var i=function(t){var i=e(t.target);if(!i.hasClass(n.options.handleClass)){if(i.closest("."+n.options.noDragClass).length)return;i=i.closest("."+n.options.handleClass)}i.length&&!n.dragEl&&(n.isTouch=/^touch/.test(t.type),n.isTouch&&1!==t.touches.length||(t.preventDefault(),n.dragStart(t.touches?t.touches[0]:t)))},o=function(e){n.dragEl&&(e.preventDefault(),n.dragMove(e.touches?e.touches[0]:e))},a=function(e){n.dragEl&&(e.preventDefault(),n.dragStop(e.touches?e.touches[0]:e))};r&&(n.el[0].addEventListener("touchstart",i,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",a,!1),t.addEventListener("touchcancel",a,!1)),n.el.on("mousedown",i),n.w.on("mousemove",o),n.w.on("mouseup",a)},serialize:function(){var t,n=0,i=this,o=function(t,n){var r=[],a=t.children(i.options.itemNodeName);return a.each(function(){var t=e(this),a=e.extend({},t.data()),s=t.children(i.options.listNodeName);s.length&&(a.children=o(s,n+1)),r.push(a)}),r};return t=o(i.el.find(i.options.listNodeName).first(),n)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var o=this.mouse,r=e(t.target),a=r.closest(this.options.itemNodeName);this.placeEl.css("height",a.height()),o.offsetX=t.offsetX!==i?t.offsetX:t.pageX-r.offset().left,o.offsetY=t.offsetY!==i?t.offsetY:t.pageY-r.offset().top,o.startX=o.lastX=t.pageX,o.startY=o.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=e(n.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",a.width()),a.after(this.placeEl),a[0].parentNode.removeChild(a[0]),a.appendTo(this.dragEl),e(n.body).append(this.dragEl),this.dragEl.css({left:t.pageX-o.offsetX,top:t.pageY-o.offsetY});var s,l,c=this.dragEl.find(this.options.itemNodeName);for(s=0;s<c.length;s++)l=e(c[s]).parents(this.options.listNodeName).length,l>this.dragDepth&&(this.dragDepth=l)},dragStop:function(e){var t=this.dragEl.children(this.options.itemNodeName).first();t[0].parentNode.removeChild(t[0]),this.placeEl.replaceWith(t),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(i){var o,r,s,l,c,d=this.options,p=this.mouse;this.dragEl.css({left:i.pageX-p.offsetX,top:i.pageY-p.offsetY}),p.lastX=p.nowX,p.lastY=p.nowY,p.nowX=i.pageX,p.nowY=i.pageY,p.distX=p.nowX-p.lastX,p.distY=p.nowY-p.lastY,p.lastDirX=p.dirX,p.lastDirY=p.dirY,p.dirX=0===p.distX?0:p.distX>0?1:-1,p.dirY=0===p.distY?0:p.distY>0?1:-1;var u=Math.abs(p.distX)>Math.abs(p.distY)?1:0;if(!p.moving)return p.dirAx=u,void(p.moving=!0);p.dirAx!==u?(p.distAxX=0,p.distAxY=0):(p.distAxX+=Math.abs(p.distX),0!==p.dirX&&p.dirX!==p.lastDirX&&(p.distAxX=0),p.distAxY+=Math.abs(p.distY),0!==p.dirY&&p.dirY!==p.lastDirY&&(p.distAxY=0)),p.dirAx=u,p.dirAx&&p.distAxX>=d.threshold&&(p.distAxX=0,s=this.placeEl.prev(d.itemNodeName),p.distX>0&&s.length&&!s.hasClass(d.collapsedClass)&&(o=s.find(d.listNodeName).last(),c=this.placeEl.parents(d.listNodeName).length,c+this.dragDepth<=d.maxDepth&&(o.length?(o=s.children(d.listNodeName).last(),o.append(this.placeEl)):(o=e("<"+d.listNodeName+"/>").addClass(d.listClass),o.append(this.placeEl),s.append(o),this.setParent(s)))),p.distX<0&&(l=this.placeEl.next(d.itemNodeName),l.length||(r=this.placeEl.parent(),this.placeEl.closest(d.itemNodeName).after(this.placeEl),r.children().length||this.unsetParent(r.parent()))));var m=!1;if(a||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(n.elementFromPoint(i.pageX-n.body.scrollLeft,i.pageY-(t.pageYOffset||n.documentElement.scrollTop))),a||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(d.handleClass)&&(this.pointEl=this.pointEl.parent(d.itemNodeName)),this.pointEl.hasClass(d.emptyClass))m=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(d.itemClass))return;var f=this.pointEl.closest("."+d.rootClass),h=this.dragRootEl.data("nestable-id")!==f.data("nestable-id");if(!p.dirAx||h||m){if(h&&d.group!==f.data("nestable-group"))return;if(c=this.dragDepth-1+this.pointEl.parents(d.listNodeName).length,c>d.maxDepth)return;var g=i.pageY<this.pointEl.offset().top+this.pointEl.height()/2;r=this.placeEl.parent(),m?(o=e(n.createElement(d.listNodeName)).addClass(d.listClass),o.append(this.placeEl),this.pointEl.replaceWith(o)):g?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),r.children().length||this.unsetParent(r.parent()),this.dragRootEl.find(d.itemNodeName).length||this.dragRootEl.append('<div class="'+d.emptyClass+'"/>'),h&&(this.dragRootEl=f,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},e.fn.nestable=function(t){var n=this,i=this;return n.each(function(){var n=e(this).data("nestable");n?"string"==typeof t&&"function"==typeof n[t]&&(i=n[t]()):(e(this).data("nestable",new o(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),i||n}}(window.jQuery||window.Zepto,window,document);