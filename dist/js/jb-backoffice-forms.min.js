"use strict";var AutoInputController=function(e,t){this.$attrs=t,this.$scope=e,this.$scope.entityName=void 0,this.$scope.entityUrl=void 0,e.data={value:void 0,name:t["for"],valid:!0},this.element=void 0,this.detailViewController=void 0};AutoInputController.prototype.init=function(e,t){this.element=e,this.detailViewController=t,this.$scope.entityName=t.getEntityName(),this.$scope.entityId=t.getEntityId(),this.detailViewController.register(this),this.afterInit&&angular.isFunction(this.afterInit)&&this.afterInit(),this.updateData?this.detailViewController.registerGetDataHandler(this.updateData.bind(this)):console.error("AutoInputController: updateData method missing in %o %o",this,e)},function(){angular.module("jb.backofficeFormComponents",["jb.fileDropComponent","jb.backofficeShared","ui.router","jb.backofficeAPIWrapper"])}(),function(){function e(e,t,n,o,a,i){this.$scope=e,this.$attrs=t,this.$compile=n,this.$rootScope=o,this.fieldTypes=a,this.name=t["for"],this.label=this.name,this.$attrs.$observe("label",function(e){this.label=e}.bind(this)),this.subcomponentsService=i,this.registry=null}var t="jb.backofficeAutoFormElement.types",n=angular.module("jb.backofficeAutoFormElement",["jb.backofficeFormEvents"]);n.value(t,{text:"text",number:"text","boolean":"checkbox",relation:"relation",language:"language",image:"image",datetime:"dateTime",date:"dateTime"}),n.directive("autoFormElement",["$compile",function(e){return{controllerAs:"$ctrl",bindToController:!0,link:{post:function(e,t,n,o){o.init(e,t,n)},pre:function(e,t,n,o){o.preLink(e,t,n)}},controller:"AutoFormElementController",scope:!0}}]),e.prototype.preLink=function(e,t,n){this.registry=this.subcomponentsService.registryFor(e),this.registry.listen()},e.prototype.init=function(e,t,n){this.element=t,this.registry.registerYourself(),this.registry.registerOptionsDataHandler(this.updateElement.bind(this))},e.prototype.updateElement=function(e){var t,n=e[this.name];if(!n||!n.type)return void console.error("AutoFormElement: fieldSpec %o is missing type for field %o",e,this.name);if(t=this.fieldTypes[n.type],!t)return console.error("AutoFormElement: Unknown type %o",e.type),void console.error("AutoFormElement: elementType missing for element %o",this.element);console.log("AutoFormElement: Create new %s from %o",t,e);var o=t.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()});this.$scope.originalAttributes=this.$attrs;var a=angular.element("<div data-auto-"+o+'-input data-for="'+this.name+'" label="'+this.label+'"></div>');this.element.replaceWith(a),this.registry.unregisterOptionsDataHandler(this.updateElement),this.$compile(a)(this.$scope),this.registry.optionsDataHandler(e)},n.controller("AutoFormElementController",["$scope","$attrs","$compile","$rootScope",t,"backofficeSubcomponentsService",e])}(),function(e){var t=function(e,t,n){this.$attrs=t,this.$scope=e,this.name=t["for"],this.label=this.name,t.$observe("label",function(e){this.label=e}.bind(this)),this.subcomponentsService=n};t.prototype.constructor=t,t.prototype.updateData=function(e){this.originalData=this.$scope.data.value=e[this.name]},t.prototype.getSelectFields=function(){return this.name},t.prototype.getSaveCalls=function(){if(this.originalData===this.$scope.data.value)return[];var e={};return e[this.$scope.data.name]=this.$scope.data.value===!0,[{data:e}]},t.prototype.preLink=function(t,n,o){t.data={value:e,name:this.name,valid:!0}},t.prototype.isValid=function(){return!0},t.prototype.isRequired=function(){return!1},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this))},t.prototype.init=function(e,t,n){this.subcomponentsService.registerComponent(e,this)};var n;n=angular.module("jb.backofficeAutoFormElement"),n.directive("autoCheckboxInput",[function(){return{scope:!0,controller:"AutoCheckboxInputController",bindToController:!0,controllerAs:"$ctrl",link:{pre:function(e,t,n,o){o.preLink(e,t,n,o)},post:function(e,t,n,o){o.init(e,t,n)}},template:'<div class="form-group"><label data-backoffice-label data-label-identifier="{{$ctrl.label}}" data-is-valid="$ctrl.isValid()" data-is-required="$ctr.isRequired()"></label><div class="col-md-9"><div class="checkbox"><input type="checkbox" data-ng-model="data.value"/></div></div></div>'}}]),n.controller("AutoCheckboxInputController",["$scope","$attrs","backofficeSubcomponentsService",t])}(),function(e){function t(e){return e<10?"0"+e:e}var n=function(t,n,o){this.$attrs=n,this.$scope=t,this.subcomponentsService=o,this.originalData=e,this.date=e,this.time=!1,this.required=!0};n.prototype.getSelectFields=function(){return[this.name]},n.prototype.isRequired=function(){return this.required===!0},n.prototype.isValid=function(){return!this.isRequired()||!!this.date},n.prototype.updateData=function(t){var n=t[this.name];this.date=n?new Date(n):e,this.originalData=this.date},n.prototype.getSaveCalls=function(){var e=this.date,n=this.originalData,o={data:{}},a="";return e||n?e&&n&&e.getTime()==n.getTime()?[]:(e&&(a=e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())),o.data[this.name]=a,[o]):[]},n.prototype.init=function(e){this.subcomponentsService.registerComponent(e,this)},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.updateData.bind(this))},n.prototype.handleOptionsData=function(e){var t=e[this.name];return t?(this.required=t.required===!0,void(this.time=t.time===!0)):console.error("AutoDateTimeInput: No field spec for %o",this.name)},n.prototype.showTime=function(){return this.time};var o=angular.module("jb.dateTime",[]);o.directive("autoDateTimeInput",[function(){return{scope:{label:"@",name:"@for"},controller:"AutoDateTimeInputController",bindToController:!0,controllerAs:"$ctrl",link:function(e,t,n,o){o.init(e,t,n)},template:'<div class="form-group form-group-sm"><label data-backoffice-label data-label-identifier="{{$ctrl.label}}" data-is-required="$ctrl.isRequired()" data-is-valid="$ctrl.isValid()"></label><div data-ng-class="{ \'col-md-9\': !$ctrl.showTime(), \'col-md-5\': $ctrl.showTime() }"><input type="date" class="form-control input-sm input-date" data-ng-model="$ctrl.date"></div><div class="col-md-4" data-ng-if="$ctrl.showTime()"><input type="time" class="form-control input-sm input-time" data-ng-model="$ctrl.date" /></div></div>'}}]),o.controller("AutoDateTimeInputController",["$scope","$attrs","backofficeSubcomponentsService",n])}(),function(e){var t=function(t,n,o){var a=!0;AutoInputController.call(this,t,n),console.log("AUTO LANGUAGE INPUT CONTROLLER: ",this.$scope.optionData),this.select=this.$scope.optionData.tableName+".*",console.log("AutoLanguageInputController: select is %o",this.select),this.formEvents=formEvents,this.originalData=e,this.registeredComponents=[],this.subcomponentsService=o,this.$scope.locales={},t.fields=t.$eval(this.$scope.originalAttributes.fields),t.tableName=this.$scope.optionData.tableName,this.$scope.$on("dataUpdate",function(e,t){var n=t[this.$scope.optionData.tableName];this.setData(n)}.bind(this)),this.isValid=function(){return a},t.isValid=this.isValid,t.setValidity=function(e){a=e}};t.prototype=Object.create(AutoInputController.prototype),t.prototype.constructor=t,t.isValid=function(){},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this))},t.prototype.getSaveCalls=function(){var e=[];for(var t in this.$scope.locales){var n=(this.$scope.locales[t],t),o="language/"+n;if(this.originalData&&this.originalData[n]){for(var a={},i=!1,r=0;r<this.$scope.fields.length;r++){var l=this.$scope.fields[r];this.$scope.locales[t][l]!==this.originalData[t][l]&&(a[l]=this.$scope.locales[t][l],i=!0)}if(i){var s=this.originalData[n]?"PATCH":"POST";e.push({method:s,data:a,url:o})}}else e.push({method:"POST",url:o,data:this.$scope.locales[n]})}return e},t.prototype.updateData=function(e){if(console.log("AutoLanguageInput: updateData got %o for tableName %o",e,e[this.$scope.optionData.tableName]),e){var t=e[this.$scope.optionData.tableName];if(!t||!angular.isArray(t))return void console.error("AutoLanguageInput: data missing for locale. Key is %o, data is %o",this.$scope.optionData.tableName,e);t.forEach(function(e){var t=e.id_language;this.$scope.locales[t]||(this.$scope.locales[t]={});for(var n in e)"id_"!==n.substring(0,3)&&(this.$scope.locales[t][n]=e[n])},this),this.originalData=angular.copy(this.$scope.locales)}},t.prototype.init=function(e,t){this.element=e,this.detailViewController=t,this.$scope.entityName=t.getEntityName(),this.$scope.entityId=t.getEntityId(),this.afterInit&&angular.isFunction(this.afterInit)&&this.afterInit(),this.updateData?this.detailViewController.registerGetDataHandler(this.updateData.bind(this)):console.error("AutoInputController: updateData method missing in %o %o",this,e)},t.prototype.afterInit=function(){console.log("SCOPE OF LANGUAGE:",this.$scope),this.$scope.$emit(this.formEvents.registerComponent,this)};var n;n=angular.module("jb.backofficeAutoFormElement"),n.directive("autoLanguageInput",[function(){return{scope:!0,require:["autoLanguageInput","^detailView"],controller:"AutoLanguageInputController",link:function(e,t,n,o){o[0].init(t,o[1])},template:'<div class="row"><div data-locale-component class="col-md-12" data-fields="fields" data-table-name="tableName" data-model="locales" data-set-validity="setValidity(validity)" data-entity-name="entityName"></div></div>'}}]),n.controller("AutoLanguageInputController",["$scope","$attrs","backofficeSubcomponentsService",t])}(),function(e){var t=function(t,n,o){this.$scope=t,this.$attrs=n,this.name=n["for"],this.label=this.name,this.select=this.name,this.componentsService=o,this.originalData=e,this.required=!0,n.$observe("label",function(e){this.label=e}.bind(this))};t.prototype.isRequired=function(){return this.required===!0},t.prototype.isValid=function(){return!this.isRequired()||!!this.$scope.data.value},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this)),e.registerOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.handleOptionsData=function(e){var t=e[this.name];return angular.isDefined(t)?void(this.required=t.required===!0):console.error("No options data available for text-field %o",this.name)},t.prototype.init=function(e){this.componentsService.registerComponent(e,this)},t.prototype.preLink=function(t){t.data={name:this.name,value:e,valid:!1}},t.prototype.updateData=function(e){this.originalData=this.$scope.data.value=e[this.name]},t.prototype.getSaveCalls=function(){if(this.originalData===this.$scope.data.value)return[];var e={};return e[this.name]=this.$scope.data.value,[{data:e}]};var n=angular.module("jb.backofficeAutoFormElement");n.controller("AutoTextInputController",["$scope","$attrs","backofficeSubcomponentsService",t]),n.directive("autoTextInput",[function(){return{scope:!0,controllerAs:"$ctrl",link:{post:function(e,t,n,o){o.init(e,t,n)},pre:function(e,t,n,o){o.preLink(e,t,n)}},controller:"AutoTextInputController",template:'<div class=\'form-group form-group-sm\'><label data-backoffice-label data-label-identifier="{{$ctrl.label}}" data-is-valid="$ctrl.isValid()" data-is-required="$ctrl.isRequired()"></label><div class="col-md-9"><input type="text" data-ng-attr-id="data.name" class="form-control input-sm" data-ng-attrs-required="$ctrl.isRequired()" data-ng-model="data.value"/></div></div>'}}])}(),function(){angular.module("jb.backofficeFormComponents").directive("backofficeDataComponent",[function(){return{require:["backofficeDataComponent","^detailView"],controller:"BackofficeDataComponentController",controllerAs:"backofficeDataComponent",bindToController:!0,templateUrl:"backofficeDataComponentTemplate.html",link:function(e,t,n,o){o[0].init(t,o[1])},scope:{propertyName:"@for",fields:"="}}}]).controller("BackofficeDataComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,o){var a,i,r=this,l={};r.init=function(e,t){a=e,i=t,i.registerOptionsDataHandler(r.updateOptionsData),i.registerGetDataHandler(r.updateData)},r.checkFields=function(){if(!angular.isArray(r.fields))throw new Error("BackofficeDataComponentController: fields passed is not an array: "+JSON.stringify(r.fields));return r.fields.forEach(function(e){if(!angular.isObject(e))throw new Error("BackofficeDataComponentController: field passed is not an object: "+JSON.stringify(e));if(!e.name)throw new Error("BackofficeDataComponentController: field is missing name property: "+JSON.stringify(e))}),!0},r.updateData=function(e){if(r.checkFields()){if(e[r.propertyName])try{angular.isString(e[r.propertyName])?l=JSON.parse(e[r.propertyName]):angular.isObject(e[r.propertyName])?l=angular.copy(e[r.propertyName]):e[r.propertyName]||(l={})}catch(t){console.error("BackofficeDataComponentController: Could not parse data "+e[r.propertyName])}r.fields.forEach(function(e){e.values.indexOf(void 0)===-1&&e.values.push(void 0),l[e.name]&&(e.selected=l[e.name])})}},r.updateOptionsData=function(e){return e[r.propertyName]?void i.register(r):void console.error("BackofficeDataComponentController: Missing OPTIONS data for %o in %o",r.propertyName,e)},r.getSelectFields=function(){return[r.propertyName]},r.getSaveCalls=function(){var e=!1;if(r.fields.forEach(function(t){l[t.name]!==t.selected&&(e=!0)}),!e)return console.log("BackofficeDataComponentController: No changes made."),!1;var t=l?angular.copy(l):{};return r.fields.forEach(function(e){void 0===e.selected&&t[e.name]?delete t[e.name]:void 0!==e.selected&&(t[e.name]=e.selected)}),console.log("BackofficeDataComponentController: Store changes %o",t),{data:{data:JSON.stringify(t)}}}}]).run(["$templateCache",function(e){e.put("backofficeDataComponentTemplate.html","<div class='form-group form-group-sm' data-ng-repeat=\"field in backofficeDataComponent.fields\"><label data-backoffice-label data-label-identifier='{{field.name}}' data-is-required='false' data-is-valid='true'></label><div class='col-md-8'><select class='form-control' data-ng-options='value for value in field.values' data-ng-model='field.selected'></select></div><div class='col-md-1'></div></div>")}])}(),function(){angular.module("jb.backofficeFormComponents").directive("backofficeDateComponent",[function(){return{require:["backofficeDateComponent","^detailView"],controller:"BackofficeDateComponentController",controllerAs:"backofficeDateComponent",bindToController:!0,templateUrl:"backofficeDateComponentTemplate.html",link:function(e,t,n,o){o[0].init(t,o[1])},scope:{propertyName:"@for"}}}]).controller("BackofficeDateComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,o){var a,i,r,l,s,c=this;c.date=void 0,c.init=function(e,t){a=e,i=t,i.registerOptionsDataHandler(c.updateOptionsData),i.registerGetDataHandler(c.updateData)},c.updateData=function(e){e[c.propertyName]&&(r=new Date(e[c.propertyName]),c.date=new Date(e[c.propertyName]))},c.updateOptionsData=function(e){return e[c.propertyName]?(e[c.propertyName].required&&(l=!0),e[c.propertyName].time&&(s=!0),void i.register(c)):void console.error("BackofficeDateComponentController: Missing OPTIONS data for %o",c.propertyName)},c.getSelectFields=function(){return[c.propertyName]},c.getSaveCalls=function(){function e(e){return e<10?"0"+e:e}if(!r&&c.date||r&&!c.date||r.getTime()!==c.date.getTime()){var t={};return t[c.propertyName]=c.date.getFullYear()+"-"+e(c.date.getMonth()+1)+"-"+e(c.date.getDate())+" "+e(c.date.getHours())+":"+e(c.date.getMinutes())+":"+e(c.date.getSeconds()),{method:i.getEntityId()?"PATCH":"POST",data:t}}return!1},c.isValid=function(){return!l||l&&c.date},c.isRequired=function(){return l},c.showTime=function(){return s}}]).run(["$templateCache",function(e){e.put("backofficeDateComponentTemplate.html","<div class='form-group form-group-sm'><label data-backoffice-label data-label-identifier='{{backofficeDateComponent.propertyName}}' data-is-required='backofficeDateComponent.isRequired()' data-is-valid='backofficeDateComponent.isValid()'></label><div data-ng-class='{ \"col-md-9\": !backofficeDateComponent.showTime(), \"col-md-5\": backofficeDateComponent.showTime()}'><input type='date' class='form-control input-sm' data-ng-model='backofficeDateComponent.date'></div><div class='col-md-4' data-ng-if='backofficeDateComponent.showTime()'><input type='time' class='form-control input-sm' data-ng-model='backofficeDateComponent.date' /></div></div>")}])}(),function(){angular.module("jb.backofficeFormComponents").directive("backofficeImageComponent",[function(){return{controller:"BackofficeImageComponentController",controllerAs:"backofficeImageComponent",bindToController:!0,link:function(e,t,n,o){o.init(e,t,n)},scope:{propertyName:"@for",pathField:"@",imageModel:"=model",label:"@"},template:'<div class="row"><label data-backoffice-label data-label-identifier="{{backofficeImageComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-component" ><div data-file-drop-component data-supported-file-types="[\'image/jpeg\']" data-model="backofficeImageComponent.images" data-error-handler="backofficeImageComponent.handleDropError(error)"><ol class="clearfix"><li data-ng-repeat="image in backofficeImageComponent.images"><a href="#" data-ng-click="backofficeImageComponent.openDetailView( $event, image )"><img data-ng-attr-src="{{image.url || image.fileData}}"/><button class="remove" data-ng-click="backofficeImageComponent.removeImage($event,image)">&times</button></a><span class="image-size-info" data-ng-if="!!image.width && !!image.height">{{image.width}}&times;{{image.height}} Pixels</span><span class="image-file-size-info" data-ng-if="!!image.fileSize">{{image.fileSize/1000/1000 | number: 1 }} MB</span><span class="focal-point-info" data-ng-if="!!image.focalPoint">Focal Point</span></li><li><button class="add-file-button" data-ng-click="backofficeImageComponent.uploadFile()">+</button></li></ol><input type="file" multiple/></div></div></div>'}}]).controller("BackofficeImageComponentController",["$scope","$rootScope","$q","$state","APIWrapperService","backofficeSubcomponentsService",function(e,t,n,o,a,i){function r(e){var t;try{t=JSON.parse(e.focalPoint)}catch(n){console.error("BackofficeImageComponentController: Could not parse focalPoint JSON",e.focalPoint)}return{url:e[g.pathField],entityUrl:"/image/"+e.id,focalPoint:t,width:e.width,height:e.height,fileSize:e.size,mimeType:e.mimeType.mimeType,id:e.id}}function l(){if(!m||!m.length||g.images&&g.images.length){if(!m&&g.images&&g.images.length){var e={};return e[p]=g.images[0].id,{method:u.getEntityId()?"PATCH":"POST",data:e}}if(m&&m.length&&g.images&&g.images.length&&m[0].id!==g.images[g.images.length-1].id){var t={};return t[p]=g.images[g.images.length-1].id,{method:"PATCH",data:t}}return console.log("BackofficeImageComponentController: No changes made to a single relation image"),!1}var n={};return n[p]=null,{method:"PATCH",data:n}}function s(){var e=[],t=[],n=[];return m&&angular.isArray(m)&&m.forEach(function(e){t.push(e.id)}),g.images.forEach(function(e){n.push(e.id)}),t.forEach(function(t){n.indexOf(t)===-1&&e.push({method:"DELETE",url:"/image/"+t})}),n.forEach(function(n){t.indexOf(n)===-1&&e.push({method:"POST",url:"image/"+n})}),console.log("BackofficeImageComponentController: Calls to be made are %o",e),e}function c(e){return console.log("BackofficeImageComponentController: Upload file %o to /image through a POST request",e),a.request({method:"POST",data:{image:e.file},url:"/image"}).then(function(t){var n=g.images.indexOf(e),o=r(t);return g.images.splice(n,1,o),console.log("BackofficeImageComponentController: Image uploaded, replace %o with %o",g.images[n],o),t})}var d,u,p,f,m,g=this;g.images=[],g.init=function(e,t,n){d=t,g.ensureSingleImageRelation(),i.registerComponent(e,g)},g.registerAt=function(e){e.registerOptionsDataHandler(g.updateOptionsData),e.registerGetDataHandler(g.updateData)},g.ensureSingleImageRelation=function(){e.$watchCollection(function(){return g.images},function(){f&&g.images.length>1&&g.images.splice(0,g.images.length-1)})},g.updateData=function(e){g.images=[],e.image||(e.image=[]),angular.isArray(e.image)||(e.image=[e.image]),m=e.image.slice(),e.image.forEach(function(e){g.images.push(r(e))})},g.updateOptionsData=function(e){return e[g.propertyName]&&angular.isObject(e[g.propertyName])?void(e[g.propertyName].relationKey?(p=e[g.propertyName].relationKey,f=!0):f=!1):void console.error("BackofficeImageComponentController: Missing data for %o",g.propertyName)},g.getSelectFields=function(){return[g.propertyName+".*",g.propertyName+"."+g.pathField,g.propertyName+".mimeType.*"]},g.getSaveCalls=function(){return f?l():s()},g.beforeSaveTasks=function(){var e=[];return g.images.forEach(function(t){t.file&&t.file instanceof File&&(console.log("BackofficeImageComponentController: New file %o",t),e.push(c(t)))}),console.log("BackofficeImageComponentController: Upload %o",e),n.all(e)},g.removeImage=function(e,t){e.preventDefault(),g.images.splice(g.images.indexOf(t),1)},g.openDetailView=function(e,t){e.preventDefault(),t.id&&o.go("app.detail",{entityName:"image",entityId:t.id})},g.handleDropError=function(n){e.$apply(function(){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.imageDropError",variables:{errorMessage:n}})})},g.uploadFile=function(){d.find("input[type='file']").click()}}])}(),function(e){var t=angular.module("jb.backofficeFormComponents");t.directive("backofficeImageDetailComponent",[function(){return{controller:"BackofficeImageDetailComponentController",controllerAs:"backofficeImageDetailComponent",bindToController:!0,link:function(e,t,n,o){o.init(e,t,n)},template:'<label data-backoffice-label data-label-identifier="{{backofficeImageDetailComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-detail-component"><div class="image-container"><img data-ng-attr-src="{{backofficeImageDetailComponent.image[ backofficeImageDetailComponent.pathField ]}}" data-ng-click="backofficeImageDetailComponent.setFocalPointClickHandler($event)"/><div class="focal-point-indicator" data-ng-if="backofficeImageDetailComponent.getFocalPoint()" data-ng-attr-style="top:{{backofficeImageDetailComponent.getFocalPointInPercent().y}}%;left:{{backofficeImageDetailComponent.getFocalPointInPercent().x}}%"></div></div><div data-ng-if="!backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPointNotSet" | translate }}</div><div data-ng-if="backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPoint" | translate }}: {{ backofficeImageDetailComponent.getFocalPoint().x }} / {{backofficeImageDetailComponent.getFocalPoint().y}} </div></div>',scope:{pathField:"@",label:"@"}}}]),t.controller("BackofficeImageDetailComponentController",["$scope","backofficeSubcomponentsService",function(e,t){var n,o=this;o.image={},o.init=function(e,n,a){t.registerComponent(e,o)},o.registerAt=function(e){e.registerGetDataHandler(o.updateData)},o.updateData=function(e){if(o.image=e,e.focalPoint)try{var t=JSON.parse(e.focalPoint);if(!t.x||!t.y)throw new Error("Property x or y missing on "+e.focalPoint);if(t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),isNaN(t.x)||isNaN(t.y))throw new Error("x or y property on focalPoint not an integer (or castable).");o.image.focalPoint=t}catch(a){console.error("BackofficeImageDetailComponentController: Could not parse focalPoint "+e.focalPoint+": "+a.message)}n=angular.copy(e.focalPoint)},o.getSelectFields=function(){return"*,mimeType.*,"+o.pathField},o.getSaveCalls=function(){if(!n&&!o.image.focalPoint)return!1;var e=n&&o.image.focalPoint&&n.x&&o.image.focalPoint.x&&o.image.focalPoint.x===n.x,t=n&&o.image.focalPoint&&n.y&&o.image.focalPoint.y&&o.image.focalPoint.y===n.y;if(e&&t)return!1;var a=[];return a.push({method:"PATCH",url:"",data:{focalPoint:JSON.stringify(o.image.focalPoint)}}),a},o.setFocalPointClickHandler=function(e){var t={x:Math.round(e.offsetX/e.target.width*o.image.width),y:Math.round(e.offsetY/e.target.height*o.image.height)};console.log("BackofficeImageDetailComponentController: Set focal point to ",JSON.stringify(t)),o.image.focalPoint=t},o.getFocalPoint=function(){return!(!o.image||!o.image.focalPoint)&&o.image.focalPoint},o.getFocalPointInPercent=function(){var e=o.getFocalPoint();return!!e&&{x:Math.round(e.x/o.image.width*100),y:Math.round(e.y/o.image.height*100)}}}])}(),function(e){function t(e,t,n,o,a,i,r){this.$scope=e,this.api=o,this.$q=t,this.$timeout=n,this.componentsService=a,this.options=null,this.fieldDefinitions=null,this.selectedLanguages=[],this.locales=[],this.originalLocales=[],this.heightElement=null,this.heightElementInitialized=!1,this.boAPI=r,this.supportedLanguages=(i.get("supported-languages","local")||[]).map(function(e,t){var n=angular.copy(e.language);return n.selected=!1,n},this),this.element=null}var n=angular.module("jb.backofficeFormComponents");n.directive("entityLocale",function(){return{controller:"BackofficeEntityLocaleController",controllerAs:"$ctrl",bindToController:!0,scope:{fields:"<",entityName:"@entity",relationName:"@relation"},template:'<div class="locale-component row"><div><ul class="nav nav-tabs"><li ng-repeat="language in $ctrl.getSupportedLanguages()" ng-class="{active:$ctrl.isSelected(language)}"><a href="#" ng-click="$ctrl.toggleLanguage($event, language)">{{language.code|uppercase}}<span data-ng-if="$ctrl.checkForTranslation(language)" class="fa fa-check"></span></a></li></ul></div><div class="locale-content clearfix"><div class="locale-col" ng-repeat="language in $ctrl.getSelectedLanguages()"><p>{{ language.code | uppercase }}</p><ul><li ng-repeat="field in $ctrl.getFields()"><label ng-attr-for="locale-{{language.code}}-{{field.name}}" ng-class="{ \'invalid\' : !$ctrl.fieldIsValid($ctrl.locales[ language.id ], field.name)}"><span data-translate="web.backoffice.{{$ctrl.entityName}}.{{field.name}}"></span><span class="required-indicator" data-ng-show="field.required">*</span></label><textarea ng-model="$ctrl.locales[ language.id ][ field.name ]" ng-attr-id="locale-{{language.code}}-{{field.name}}"class="form-control" ng-keyup="$ctrl.adjustHeight( $event )" ng-click="$ctrl.adjustHeight( $event )" /></textarea></li></ul></div></div></div>',link:{pre:function(e,t,n,o){o.preLink(e,t,n)},post:function(e,t,n,o){o.postLink(e,t,n)}}}}),t.prototype.preLink=function(){},t.prototype.postLink=function(e,t,n){this.componentsService.registerComponent(e,this),this.heightElement=angular.element("<div></div>"),this.heightElement=this.heightElement.attr("id","locale-height-container"),this.heightElement.css("position","absolute"),this.heightElement.css("left","-9999px"),this.heightElement.css("top","-9999px"),this.element=t,this.element.append(this.heightElement)},t.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},t.prototype.getSelectedLanguages=function(){for(var e=[],t=0;t<this.supportedLanguages.length;t++){var n=this.supportedLanguages[t];n.selected===!0&&e.push(n)}return e},t.prototype.getSupportedLanguages=function(){return this.supportedLanguages},t.prototype.fieldIsValid=function(e,t){var n=this.fieldDefinitions[t];return!e||(n.required!==!0||!this._localePropertyIsEmpty(e[t]))},t.prototype.adjustHeight=function(e){var t=angular.element(e.currentTarget);this.adjustElementHeight(t)},t.prototype.adjustElementHeight=function(e){var t=e[0].scrollHeight,n=e[0].clientHeight,o=t>n,a=e.width(),i=o?"scroll":"auto",r=e.val();this.heightElementInitialized||this.initializeHeightElement(e),this.heightElement.width(a),this.heightElement.css("overflow-y",i),r=r.replace(/(\n\r?)/g,"<br>").replace(/(\<br\>\s*)$/,"<br><br>"),""==r.trim()&&(r="empty"),this.heightElement.html(r),e.height(this.heightElement.height())},t.prototype.adjustAllHeights=function(){this.element.find("textarea").each(function(e,t){this.adjustElementHeight(angular.element(t))}.bind(this))},t.prototype.initializeHeightElement=function(e){["font-size","font-family","font-weight","letter-spacing","line-height","padding-top","padding-left","padding-right","padding-bottom","border-radius","border"].forEach(function(t){this.heightElement.css(t,e.css(t))},this),this.heightElementInitialized=!0},t.prototype.toggleLanguage=function(e,t){e&&e.preventDefault();var n=this.getSelectedLanguages();t.selected&&1==n.length||(t.selected=t.selected!==!0,this.$timeout(this.adjustAllHeights.bind(this)))},t.prototype.isSelected=function(e){return e.selected===!0},t.prototype.checkForTranslation=function(e){return!(!this.locales||!angular.isDefined(this.locales[e.id]))},t.prototype.translationIsEmpty=function(e){return this.fields.reduce(function(t,n){return t&&!e[n]},!0)},t.prototype.handleOptionsData=function(e){var t;return e||angular.isDefined(e[this.relationName])?(t=e[this.relationName],this.options=t,void this.loadFields().then(function(e){this.$timeout(function(){this.fieldDefinitions=e}.bind(this))}.bind(this),function(e){console.error(e)})):console.error("No OPTIONS data found in locale component.")},t.prototype.loadFields=function(){var e="/"+this.options.tableName;return this.fieldDefinitions?this.$q.when(this.fieldDefinitions):this.boAPI.getOptions(e).then(function(e){return this.fields.reduce(function(t,n){return t[n]=e[n],t}.bind(this),{})}.bind(this),function(e){console.error(e)})},t.prototype._localeIsEmpty=function(e){return this.fields.every(function(t){return this._localePropertyIsEmpty(e[t])},this)},t.prototype._localePropertyIsEmpty=function(e){return angular.isUndefined(e)||""==e.trim()},t.prototype._localeGetChanges=function(e,t){return angular.isDefined(t)?this.fields.reduce(function(n,o){return e[o]!=t[o]&&n.push(o),n}.bind(this),[]):this._localeIsEmpty(e)?[]:this.fields},t.prototype.getSaveCalls=function(){var e=[];return this.locales.forEach(function(t,n){var o=this.originalLocales[n],a=angular.isDefined(o);if(t){var i=this._localeGetChanges(t,o),r=a?"PATCH":"POST";if(i.length>0){var l={};l.data=i.reduce(function(e,n){return e[n]=t[n],e},{}),l.url={},l.url.path="language/"+n,l.url.mainEntity="prepend",l.method=r,e.push(l)}}},this),e},t.prototype.handleGetData=function(e){var t=e[this.options.tableName];return this.originalLocales=this.normalizeModel(t),this.locales=angular.copy(this.originalLocales),0===this.getSelectedLanguages().length?this.$timeout(function(){this.toggleLanguage(null,this.supportedLanguages[0])}.bind(this)):void this.$timeout(this.adjustAllHeights.bind(this))},t.prototype.getFields=function(){return this.fieldDefinitions?Object.keys(this.fieldDefinitions).map(function(e){return this.fieldDefinitions[e]},this):[]},t.prototype.normalizeModel=function(e){return e.reduce(function(e,t){return e[t.language.id]=t,e},[])},t.prototype.getLocales=function(){return this.locales},t.prototype.getSelectFields=function(){var e,t=this.options.tableName,n=[t,"language","*"].join(".");return e=this.fields.map(function(e){return[t,e].join(".")},this),e.push(n),e},t.prototype.isValid=function(){return this.locales.reduce(function(e,t,n){return angular.isUndefined(t)?e:angular.isUndefined(this.originalLocales[n])&&this._localeIsEmpty(t)?e:e&&this.fields.reduce(function(e,n){return e&&this.fieldIsValid(t,n)}.bind(this),!0)}.bind(this),!0)},n.controller("BackofficeEntityLocaleController",["$scope","$q","$timeout","APIWrapperService","backofficeSubcomponentsService","SessionService","BackofficeAPIWrapperService",t])}(),function(){angular.module("jb.backofficeFormComponents").directive("backofficeMarkdownComponent",[function(){return{require:["backofficeMarkdownComponent","^detailView"],controller:"BackofficeMarkdownComponentController",controllerAs:"backofficeMarkdownComponent",bindToController:!0,templateUrl:"backofficeMarkdownComponentTemplate.html",link:function(e,t,n,o){o[0].init(t,o[1])},scope:{suggestionTemplate:"@",searchField:"@",propertyName:"@for"}}}]).controller("BackofficeMarkdownComponentController",["$scope",function(e){
var t,n,o=this;o.init=function(e,o){t=e,n=o}}]).run(["$templateCache",function(e){e.put("backofficeMarkdownComponentTemplate.html","<div><div data-language-menu-component data-selected-languages='selectedLanguages' data-is-multi-select='false' data-has-translation='hasTranslation(languageId)'></div></div>")}])}(),function(){angular.module("jb.backofficeFormComponents").directive("backofficeMediaGroupComponent",[function(){return{require:["backofficeMediaGroupComponent","^detailView"],controller:"BackofficeMediaGroupComponentController",controllerAs:"backofficeMediaGroupComponent",bindToController:!0,templateUrl:"backofficeMediaGroupComponentTemplate.html",link:function(e,t,n,o){o[0].init(t,o[1])},scope:{propertyName:"@for"}}}]).controller("BackofficeMediaGroupComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,o){function a(e,t){var n=e.mediumGroup_medium[0].sortOrder,o=t.mediumGroup_medium[0].sortOrder;return n<o?-1:1}function i(){var e=-1;return s.media.forEach(function(t){t.mediumGroup_medium&&t.mediumGroup_medium.length&&(e=Math.max(e,t.mediumGroup_medium[0].sortOrder))}),e}var r,l,s=this,c=[],d=["*","video.*","video.videoType.*","image.*","mediumGroup_medium.*","mediumGroup.*"];s.media=[],s.addMediumModel=[],s.init=function(e,t){r=e,l=t,l.registerOptionsDataHandler(s.updateOptionsData),l.registerGetDataHandler(s.updateData),s.setupAddMediumModelWatcher(),s.setupOrderChangeListener()},s.updateData=function(e){if(e[s.propertyName]){var t=e[s.propertyName]||[];try{s.media=t.sort(a)}catch(n){console.error("BackofficeMediaGroupComponentController: Properties mediumGroup_medium, it's items or sortOrder missing"),s.media=t}c=angular.copy(s.media)}},s.setupOrderChangeListener=function(){r[0].addEventListener("orderChange",function(e){s.media.splice(e.detail.newOrder,0,s.media.splice(e.detail.oldOrder,1)[0])})},s.setupAddMediumModelWatcher=function(){e.$watch(function(){return s.addMediumModel},function(e){1===s.addMediumModel.length&&(s.addMedium(e[0].id),s.addMediumModel=[])},!0)},s.addMedium=function(e){return s.media.filter(function(t){return t.id===e}).length>0?void console.error("BackofficeMediaGroupComponentController: Trying to add duplicate with id",e):void o.request({url:"/"+s.propertyName+"/"+e,method:"GET",headers:{select:s.getSelectFields()}}).then(function(e){s.media.push(e)},function(n){console.error("BackofficeMediaGroupComponentController: Could not get data for medium with id %o: %o",e,n),t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:n}})})},s.updateOptionsData=function(e){l.register(s)},s.getSelectFields=function(){return d.map(function(e){return s.propertyName+"."+e})},s.getSaveCalls=function(){console.error(c);var e=c.map(function(e){return e.id}),t=s.media.map(function(e){return e.id}),n=[],o=[];t.forEach(function(t){e.indexOf(t)===-1&&n.push(t)}),e.forEach(function(e){t.indexOf(e)===-1&&o.push(e)});var a=[];return o.forEach(function(e){a.push({method:"DELETE",url:s.propertyName+"/"+e})}),n.forEach(function(e){a.push({method:"POST",url:s.propertyName+"/"+e})}),a},s.afterSaveTasks=function(){var e=i(),t=[];return s.media.forEach(function(n){t.push(o.request({url:"/mediumGroup/"+l.getEntityId()+"/medium/"+n.id,method:"PATCH",data:{sortOrder:++e}}))}),n.all(t)},s.isValid=function(){return!0},s.isRequired=function(){return!1},s.removeMedium=function(e){s.media.splice(s.media.indexOf(e),1)}}]).run(["$templateCache",function(e){e.put("backofficeMediaGroupComponentTemplate.html","<div class='backoffice-media-group-component'><div class='row'><div class='col-md-12'><ol class='clearfix' data-drag-drop-list><li data-ng-repeat='medium in backofficeMediaGroupComponent.media' draggable='true'><div data-ng-if='medium.image'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='{{medium.image.url}}'></div><div data-ng-if='medium.video && medium.video.videoType.identifier === \"youtube\"'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='http://img.youtube.com/vi/{{medium.video.uri}}/0.jpg'></div></li></ol></div></div><div class='row'><div class='col-md-12'><div class=\"relation-select\" data-relation-input data-ng-attr-data-relation-entity-endpoint=\"{{backofficeMediaGroupComponent.propertyName}}\" data-relation-interactive=\"false\" data-deletable=\"false\" data-relation-entity-search-field=\"title\" data-relation-suggestion-template=\"[[title]] <img src='[[image.url]]'/>\" data-ng-model=\"backofficeMediaGroupComponent.addMediumModel\" data-multi-select=\"true\"></div></div></div></div>")}])}(),function(e){function t(e){return function(){return{controller:e,controllerAs:"$ctrl",bindToController:!0,link:{pre:function(e,t,n,o){o.preLink(e,t,n)},post:function(e,t,n,o){o.postLink(e,t,n)}},scope:{propertyName:"@for",entityName:"@entity",relationName:"@relation",label:"@",suggestion:"@suggestionTemplate",searchField:"@"}}}}function n(e,t,n,o,a,i){this.subcomponentsService=a,this.options=null,this.originalData=[],this.suggestion="",this.relationService=i,this.$scope=e,this.$compile=n,this.$templateCache=o,this.element=null,this.currentData=[],this.referencedPropertyName=null}function o(e,t,o,a,i,r){n.call(this,e,t,o,a,i,r)}var a=angular.module("jb.backofficeFormComponents");a.directive("referenceComponent",[t("BackofficeReferenceController")]),a.directive("relationComponent",[t("BackofficeRelationController")]),n.prototype.preLink=function(){},n.prototype.postLink=function(e,t,n){this.subcomponentsService.registerComponent(e,this),this.element=t},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},n.prototype.getEndpoint=function(){return this.relationName},n.prototype.handleGetData=function(e){if(this.currentData=[],e&&e[this.relationName]){var t=e[this.relationName];angular.isArray(t)||(t=[t]),this.currentData=t}this.originalData=angular.copy(this.currentData),console.log("BackofficeReferenceComponentController: Model updated (updateData) to %o",this.currentData)},n.prototype.getSpec=function(e){var t,n;if(!e)return t;if(n=angular.isDefined(e.internalReferences),this.propertyName&&n)return e.internalReferences[this.propertyName];if(this.entityName&&n){for(var o=Object.keys(e.internalReferences),a=0;a<o.length;a++)if(e.internalReferences[a].entity==this.entityName)return e.internalReferences[a];return t}return this.relationName?e[this.relationName]:t},n.prototype.handleOptionsData=function(e){var t=this.getSpec(e);return angular.isDefined(t)?(this.propertyName=t.relationKey,this.entityName=t.entity,this.relationName=t.relation,this.referencedPropertyName=t.relatedKey,this.options=t,void this.renderComponent()):console.error("BackofficeReferenceController: No options data found for name %o referencing entity %o.",this.propertyName,this.entityName)},n.prototype.isMultiSelect=function(){return!1},n.prototype.renderComponent=function(){var e=angular.element(this.$templateCache.get("referenceComponentTemplate.html"));e.find("[relation-input]").attr("relation-entity-endpoint",this.getEndpoint()).attr("relation-interactive",this.isInteractive()).attr("deletable","$ctrl.isDeletable()").attr("relation-entity-search-field",this.getSearchField()).attr("relation-suggestion-template",this.getSuggestionTemplate()).attr("ng-model","$ctrl.currentData").attr("multi-select",this.isMultiSelect()),this.$compile(e)(this.$scope),this.element.prepend(e)},n.prototype.isInteractive=function(){return!0},n.prototype.isDeletable=function(){return!0},n.prototype.getLabel=function(){return this.label?this.label:this.propertyName},n.prototype.getSelectFields=function(){var e=this.relationService.extractSelectFields(this.getSuggestionTemplate()),t=e.map(function(e){return[this.relationName,e].join(".")},this);return this.propertyName&&t.unshift(this.propertyName),t},n.prototype.isRequired=function(){return!this.options||this.options.required===!0},n.prototype.isMultiSelect=function(){return!1},n.prototype.getSuggestionTemplate=function(){return this.suggestion},n.prototype.getSearchField=function(){return this.searchField},n.prototype.isValid=function(){return!this.isRequired()||this.currentData.length>0},n.prototype.getSaveCalls=function(){var e,t,n=this.currentData[0],o=this.originalData[0];if(n&&(e=n[this.referencedPropertyName]),o&&(t=o[this.referencedPropertyName]),t!==e){var a={data:{}};return a.data[this.propertyName]=angular.isDefined(e)?e:"",[a]}return[]},o.prototype=Object.create(n.prototype),o.prototype.constructor=o,o.prototype.isMultiSelect=function(){return!0},o.prototype.getSpec=function(e){if(e)return this.relationName?e[this.relationName]:e[this.entityName]},o.prototype.getSaveCalls=function(){var e,t=this.mapProperties(this.currentData,this.referencedPropertyName);return e=this.originalData.reduce(function(e,n){var o=n[this.referencedPropertyName];return angular.isDefined(t[o])?delete t[o]:e.push({method:"DELETE",url:{path:[this.relationName,o].join("/"),mainEntity:"append"}}),e}.bind(this),[]),Object.keys(t).forEach(function(t){e.push({method:"POST",url:{path:[this.relationName,t].join("/"),mainEntity:"append"}})},this),e},o.prototype.mapProperties=function(e,t){return e.reduce(function(e,n){return e[n[t]]=n,e},{})},a.controller("BackofficeReferenceController",["$scope","$attrs","$compile","$templateCache","backofficeSubcomponentsService","RelationInputService",n]),a.controller("BackofficeRelationController",["$scope","$attrs","$compile","$templateCache","backofficeSubcomponentsService","RelationInputService",o]),a.run(["$templateCache",function(e){e.put("referenceComponentTemplate.html",'<div class="form-group"><label backoffice-label label-identifier="{{$ctrl.getLabel()}}" is-required="$ctrl.isRequired()" is-valid="$ctrl.isValid()"></label><div relation-input class="relation-select col-md-9"></div></div>')}])}(),function(){angular.module("jb.backofficeFormComponents").directive("backofficeRelationComponent",[function(){return{require:["backofficeRelationComponent","^detailView"],controller:"BackofficeRelationComponentController",controllerAs:"backofficeRelationComponent",bindToController:!0,link:function(e,t,n,o){o[0].init(e,t,n,o[1])},scope:{suggestionTemplate:"@",searchField:"@",propertyName:"@for"}}}]).controller("BackofficeRelationComponentController",["$scope","$compile","$templateCache","RelationInputService","backofficeFormEvents",function(e,t,n,o,a){var i,r,l,s,c,d,u,p=this;p.relationModel=void 0,p.formEvents=a,p.init=function(e,t,n,o){i=t,r=o,e.$emit(p.formEvents.registerComponent,p)},p.registerAt=function(e){e.registerOptionsDataHandler(p.updateOptionsData),e.registerGetDataHandler(p.updateData)},p.updateData=function(e){var t;t=e&&e[p.propertyName]?angular.isArray(e[p.propertyName])?e[p.propertyName]:[e[p.propertyName]]:[],p.relationModel=t,u=angular.copy(t),console.log("BackofficeRelationComponentController: Model updated (updateData) to %o",p.relationModel)},p.updateOptionsData=function(e){console.log("BackofficeRelationComponentController: Got options data %o",e[p.propertyName]);var t=e[p.propertyName];s="belongsTo"!==t.originalRelation,l=t.required,c="single"!==t.relationType,d=t.alias?t.relation:p.propertyName,p.replaceElement(c,s)},p.getSelectFields=function(){var e=o.extractSelectFields(p.suggestionTemplate),t=[];return e.forEach(function(e){t.push(p.propertyName+"."+e)}),t},p.replaceElement=function(o,a){var r=$(n.get("backofficeRelationComponentTemplate.html"));r.find("[data-relation-input]").attr("data-relation-entity-endpoint",d).attr("data-relation-interactive",!0).attr("data-deletable",a).attr("data-relation-entity-search-field",p.searchField).attr("data-relation-suggestion-template",p.suggestionTemplate).attr("data-ng-model","backofficeRelationComponent.relationModel").attr("data-multi-select",o),i.replaceWith(r),t(r)(e)},p.isRequired=function(){return l},p.isValid=function(){var e=!(l&&!(l&&p.relationModel&&p.relationModel.length));return console.log("BackofficeRelationComponentController: isValid? %o",e),e},p.getSaveCalls=function(){var e=c?p.getMultiSelectSaveCalls():p.getSingleSelectSaveCalls();return console.log("BackofficeRelationComponentController: saveCalls are %o",e),e},p.getSingleSelectSaveCalls=function(){if(!p.relationModel)return console.log("AutoRelationInputController: relationModel empty"),!1;if(l){if(p.relationModel&&u){if(0===p.relationModel.length&&0===u.length)return console.log("BackofficeRelationComponentController: No changes and no relations for required relation %o",p.propertyName),!1;if(p.relationModel.length&&u.length&&p.relationModel[0]&&u[0]&&p.relationModel[0].id===u[0].id)return console.log("BackofficeRelationComponentController: No changes on required relation %o",p.propertyName),!1}var e={};return e["id_"+p.propertyName]=p.relationModel[0].id,r.getEntityId()?{url:!1,method:"PATCH",data:e}:{url:!1,method:"POST",data:e}}if(0===p.relationModel.length&&u&&0!==u.length)return{url:{path:"/"+p.propertyName+"/"+u[0].id,mainEntity:"append"},method:"DELETE"};if(p.relationModel.length&&(!u||!u.length||u.length&&p.relationModel[0].id!==u[0].id)){var t={};return t[r.fields[p.propertyName].relationKey]=p.relationModel[0].id,{url:{path:"/"+p.propertyName+"/"+p.relationModel[0].id,mainEntity:"append"},method:"POST"}}return!1},p.getMultiSelectSaveCalls=function(){var e=[],t=[],n=[],o=[],a=[];return p.relationModel&&p.relationModel.length&&p.relationModel.forEach(function(e){o.push(e.id)}),u&&u.length&&u.forEach(function(e){n.push(e.id)}),n.forEach(function(t){o.indexOf(t)===-1&&(e.push(t),a.push({method:"DELETE",url:{path:p.propertyName+"/"+t,mainEntity:"append"}}))}.bind(this)),o.forEach(function(e){n.indexOf(e)===-1&&(t.push(e),a.push({method:"POST",url:{path:"/"+p.propertyName+"/"+e,mainEntity:"append"}}))}.bind(this)),console.log("BackofficeRelationComponentController: Added %o, deleted %o – calls: %o",t,e,a),0!==a.length&&a}}]).run(["$templateCache",function(e){e.put("backofficeRelationComponentTemplate.html","<div class='form-group'><label data-backoffice-label data-label-identifier='{{backofficeRelationComponent.propertyName}}' data-is-required='backofficeRelationComponent.isRequired()' data-is-valid='backofficeRelationComponent.isValid()'></label><div data-relation-input class='relation-select col-md-9'></div></div>")}])}(),angular.module("jb.backofficeFormComponents").directive("backofficeTreeComponent",[function(){return{require:["^detailView","backofficeTreeComponent"],controller:"TreeComponentController",link:function(e,t,n,o){o[1].init(t,o[0])},templateUrl:"treeTemplate.html",scope:{filter:"=treeComponentFilter",labelName:"@treeComponentLabel",entityName:"@for",maxDepth:"@"},bindToController:!0,controllerAs:"treeComponentController"}}]).controller("TreeComponentController",["$scope","$rootScope","$attrs","$location","$q","APIWrapperService",function(e,t,n,o,a,i){var r,l,s=this;n.maxDepth||10;s.dataTree=void 0,s.labelName&&s.entityName||console.warn("TreeComponentController: labelName or entityName (for) attribute missing"),s.editEntity=function(e,t){e.preventDefault(),o.path("/"+n["for"]+"/"+t)},s.init=function(e,t){r=e,l=t,l.register(s),s.getData()},s.getData=function(){var e={range:"0-0"};if(s.filter){var n="";for(var o in s.filter)n=o+"="+s.filter[o];e.filter=n}i.request({method:"GET",url:"/"+s.entityName,headers:e}).then(function(e){s.updateData(e)},function(e){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})})},s.updateData=function(e){s.dataTree=c(e),console.log("TreeComponentController: dataTree is %o",s.dataTree),setTimeout(function(){r.addClass("dd"),r.nestable({dragClass:"dd-dragelement",placeClass:"dd-placeholder",maxDepth:s.maxDepth})},500)},s.getSaveCalls=function(){var e=r.nestable("serialize");console.log("TreeComponentController: Store data %o",e);var t=s.cleanTreeData(e);return console.log("TreeComponentController: Cleaned data %o, got %o",e,t),{method:"POST",headers:{"Content-Type":"application/json"},url:"/"+s.entityName,data:t}},s.cleanTreeData=function(e,t){t||(t=[]);for(var n in e){var o=e[n],a={};if(a.id=o.id,s.filter)for(var i in s.filter)a[i]=s.filter[i];o.children&&(a.children=[],s.cleanTreeData(o.children,a.children)),t.push(a)}return t};var c=function(e){var t={};return e.sort(function(e,t){return e.left-t.left}),d(t,e),t.children},d=function(e,t){var n,o="right",a=0,i=[];e.children||(e.children=[]),t.forEach(function(t){t[o]>a?(a=t[o],i=[],e.children.push(t),n=t):t[o]+1===a?(i.push(t),d(n,i)):i.push(t)})}}]).run(function(e){e.put("treeBranchTemplate.html","<div class='dd-handle'><span data-ng-if='branch[ treeComponentController.labelName ]'>{{ branch[ treeComponentController.labelName ] }}</span><span data-ng-if='!branch[ treeComponentController.labelName ]'>N/A</span></div><button class='fa fa-pencil btn btn-link edit' data-ng-click='treeComponentController.editEntity($event,branch.id)'></button><ol data-ng-if='branch.children' class='dd-list'><li data-ng-repeat='branch in branch.children' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>"),e.put("treeTemplate.html","<ol><li data-ng-repeat='branch in treeComponentController.dataTree' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>")}),function(){angular.module("jb.backofficeFormComponents").directive("backofficeVideoComponent",[function(){return{require:["backofficeVideoComponent","^detailView"],controller:"BackofficeVideoComponentController",controllerAs:"backofficeVideoComponent",bindToController:!0,templateUrl:"backofficeVideoComponentTemplate.html",link:function(e,t,n,o){o[0].init(t,o[1])},scope:{propertyName:"@for"}}}]).controller("BackofficeVideoComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,o){var a,i,r=this;r.images=[],r.init=function(e,t){a=e,i=t,i.registerOptionsDataHandler(r.updateOptionsData),i.registerGetDataHandler(r.updateData)},r.updateData=function(e){console.error(e)},r.updateOptionsData=function(e){i.register(r)},r.getSelectFields=function(){return[r.propertyName+".*"]},r.getSaveCalls=function(){return!1},r.beforeSaveTasks=function(){}}]).run(["$templateCache",function(e){e.put("backofficeVideoComponentTemplate.html","<div class='row'><label data-backoffice-label data-label-identifier='{{backofficeImageComponent.propertyName}}' data-is-required='false' data-is-valid='true'></label>VIDEO</div>")}])}(),function(){function e(e,t,n){this.registeredComponents=[],this.scope=n,this.optionsDataHandlers=[],this.getDataHandlers=[],this.$q=e,this.formEvents=t}var t=angular.module("jb.backofficeFormEvents",[]);t.provider("backofficeFormEvents",function(){var e={registerComponent:"jb.backoffice-form-event.registerComponent"};this.setEventKey=function(t,n){e[t]=n},this.hasEventKeyAt=function(t){return angular.isDefined(e[t])},this.getEventKeyAt=function(t){return e[t]},this.removeEventKey=function(t){delete e[t]},this.$get=[function(){return Object.freeze(e)}]}),e.prototype.listen=function(){return this.scope.$on(this.formEvents.registerComponent,function(e,t){console.log("REGISTRATION OF:",t),t!==this&&(e.stopPropagation(),this.registerComponent(t))}.bind(this)),this},e.prototype.registerComponent=function(e){this.registeredComponents.push(e),e.registerAt(this)},e.prototype.getSaveCalls=function(){return this.registeredComponents.reduce(function(e,t){return e.concat(t.getSaveCalls())},[])},e.prototype.isValid=function(){for(var e=0;e<this.registeredComponents.length;e++)if(this.registeredComponents[e].isValid()===!1)return!1;return!0},e.prototype.getAfterSaveTasks=function(){var e=this.registeredComponents.reduce(function(e,t){return angular.isFunction(t.afterSaveTasks)?e.concat(t.afterSaveTasks()):e});return this.$q.all(e)},e.prototype.getBeforeSaveTasks=function(){var e=this.registeredComponents.reduce(function(e,t){return angular.isFunction(t.beforeSaveTasks)?e.concat(t.beforeSaveTasks()):e});return this.$q.all(e)},e.prototype.getSelectFields=function(){return this.registeredComponents.reduce(function(e,t){return angular.isFunction(t.getSelectFields)?e.concat(t.getSelectFields()):angular.isDefined(t.select)?e.concat(t.select):e},[])},e.prototype.optionsDataHandler=function(e){this.optionsDataHandlers.forEach(function(t){t(e)})},e.prototype.registerOptionsDataHandler=function(e){this.optionsDataHandlers.push(e)},e.prototype.registerGetDataHandler=function(e){this.getDataHandlers.push(e)},e.prototype.unregisterGetDataHandler=function(e){this.getDataHandlers.splice(this.getDataHandlers.indexOf(e),1)},e.prototype.unregisterOptionsDataHandler=function(e){this.optionsDataHandlers.splice(this.optionsDataHandlers.indexOf(e),1)},e.prototype.getDataHandler=function(e){this.getDataHandlers.forEach(function(t){t(e)})},e.prototype.registerYourself=function(e){(e||this.scope).$emit(this.formEvents.registerComponent,this)},e.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.optionsDataHandler.bind(this)),e.registerGetDataHandler(this.getDataHandler.bind(this))},t.factory("backofficeSubcomponentsService",["$q","backofficeFormEvents",function(t,n){return{registryFor:function(o){var a=new e(t,n,o);return a},registerComponent:function(e,t){e.$emit(n.registerComponent,t)}}}])}(),function(e){var t=angular.module("jb.backofficeAutoFormElement");t.controller("backofficeLabelController",["$scope",function(e){this.$scope=e}]),t.directive("backofficeLabel",["$templateCache","$compile",function(e,t){return{link:function(n,o,a,i){var r=angular.element(e.get("backofficeLabelTemplate.html"));o.replaceWith(r),t(r)(n)},scope:{labelIdentifier:"@",isRequired:"&",isValid:"&"}}}]),t.run(function(e){e.put("backofficeLabelTemplate.html",'<div class="col-md-3"><label class="control-label" data-ng-class="{invalid: !isValid()}"><span data-ng-if="isRequired()||required" class="required-indicator">*</span><span data-translate="{{labelIdentifier}}"></span></label></div>')})}(),function(e){angular.module("jb.backofficeDetailView",["jb.apiWrapper","pascalprecht.translate","jb.backofficeFormEvents"]).directive("detailView",[function(){return{link:{pre:function(e,t,n,o){angular.isFunction(o.preLink)&&o.preLink(e,t,n)},post:function(e,t,n,o){e.detailViewController=o,o.init(e,t,n)}},controller:"DetailViewController",scope:!0}}]).controller("DetailViewController",["$scope","$rootScope","$q","$attrs","$filter","$state","APIWrapperService","backofficeFormEvents","BackofficeAPIWrapperService",function(t,n,o,a,i,r,l,s,c){var d,u=(t.$new(),this),p=0,f=[],m=[];u.registeredComponents=[],u.fields=e,u.data=e,t.entityId=e,t.entityName=e,t.title=e,u.preLink=function(e,t,n){console.info("PRE LINK"),e.$on(s.registerComponent,function(e,t){t!==u&&(console.log("REGISTER: ",t),e.stopPropagation(),u.register(t),t.registerAt(u))})},u.parseUrl=function(){return{name:r.params.entityName,id:!(!r.params.entityId||"new"===r.params.entityId)&&r.params.entityId,isNew:"new"===r.params.entityId}},t.$watch(a.entityId,function(e){console.log("DetailViewController: $attrs.entityId changed to %o; if val exists, update $scope.entityId",e),e&&(t.entityId=e,u.getData())}),t.$parent.$eval(a.entityId)?t.entityId=t.$parent.$eval(a.entityId):t.entityId=u.parseUrl().id,t.$watch(a.entityName,function(e){console.log("DetailViewController: $attrs.entityName changed to %o; if val exists, update $scope.entityName",e),e&&(t.entityName=e,u.getData())}),t.$parent.$eval(a.entityName)?t.entityName=t.$parent.$eval(a.entityName):t.entityName=u.parseUrl().name,u.getEntityId=function(){return t.entityId},u.getEntityName=function(){return t.entityName},u.getEntityUrl=function(){var e="/"+u.getEntityName();return u.getEntityId()&&(e+="/"+u.getEntityId()),e},u.setTitle=function(){u.parseUrl().isNew?t.title=i("translate")("web.backoffice.create")+": ":t.title=i("translate")("web.backoffice.edit")+": ",t.title+=u.getEntityName(),u.getEntityId()&&(t.title+=" #"+u.getEntityId())},t.$watchGroup(["entityName","entityId"],function(){u.setTitle()}),u.init=function(e,t,n){d=t;var o=d.find("[data-auto-form-element], [data-hidden-input], [data-backoffice-tree-component], [data-backoffice-relation-component], [data-backoffice-component], [data-backoffice-image-component], [data-backoffice-image-detail-component], [data-backoffice-video-component], [data-backoffice-date-component], [data-backoffice-media-group-component], [data-backoffice-data-component]");return o.each(function(){var e=$(this).closest("[data-detail-view]");e.get(0)===d.get(0)&&p++}),p=this.registeredComponents.length,console.info("DETAIL VIEW POST LINK",p),a.hasOwnProperty("entityId")?void a.$observe("entityId",u.getOptionData.bind(u)):u.getOptionData()},u.getOptionData=function(){console.log("DetailView: Make OPTIONS call for %o",u.getEntityName()),u.makeOptionRequest("/"+u.getEntityName()).then(function(e){u.fields=e;var t=f.slice(0);t.forEach(function(t){t(e)}),u.getData()},function(e){n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.optionsLoadingError",variables:{errorMessage:e}})})},u.registerOptionsDataHandler=function(e){f.push(e)},u.removeOptionsDataHandler=function(e){f.splice(f.indexOf(e),1)},u.makeOptionRequest=function(e){return c.getOptions(e).then(function(t){return console.log("DetailView: Got OPTIONS data for %o %o",e,t),u.fields=t,u.fields},function(e){return o.reject(e)})},u.resolveAlias=function(e){return e.hasAlias?e.name:e.modelName},u.fieldTypeMapping={string:"text",decimal:"number",integer:"number","boolean":"boolean",json:"json",datetime:"datetime",date:"datetime"},u.register=function(e){u.registeredComponents.push(e)},u.getData=function(){return 0===p?void console.info("DetailViewController: No subcomponents components found!"):u.registeredComponents.length<p?void console.log("DetailViewController: Can't get data, not all autoFormElements registered yet: %o vs %o",u.registeredComponents.length,p):u.registeredComponents.length>p?void console.error("DetailViewController: More components registered than detected in the DOM: %o vs %o. Registered: %o.",u.registeredComponents.length,p,u.registeredComponents):u.getEntityId()?void u.makeGetRequest().then(function(e){u.data=e,u.distributeData(e)},function(e){n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})}):void console.log("DetailViewController: Can't get data, entity ID is not set.")},u.registerGetDataHandler=function(e){m.push(e)},u.getSelectParameters=function(){for(var e=[],t=0;t<u.registeredComponents.length;t++){var n=u.registeredComponents[t];n.getSelectFields&&angular.isFunction(n.getSelectFields)?e=e.concat(n.getSelectFields()):n.select&&(e=e.concat(n.select))}return console.log("DetailView %o: getSelectParameters returns %o",u.getEntityName(),e),e},u.distributeData=function(e){t.$emit("dataUpdate",{entity:u.getEntityName(),data:e}),m.forEach(function(t){t(e)})},u.updateData=function(){return u.makeGetRequest().then(function(e){return u.distributeData(e),e},function(e){return n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.saveError",variables:{errorMessage:e}}),o.reject(e)})},u.makeGetRequest=function(){var e=u.getEntityUrl(),t=u.getSelectParameters();return console.log("DetailView: Get Data from %o with select %o",e,t),l.request({url:e,headers:{select:t},method:"GET"}).then(function(e){return e}.bind(this),function(e){return o.reject(e)})},t.save=function(e,t,a){return t&&angular.isFunction(t.preventDefault)&&t.preventDefault(),u.makeSaveRequest(u.registeredComponents,u.getEntityName()).then(function(t){return u.parseUrl().isNew&&!e&&r.go("app.detail",{entityName:u.getEntityName(),entityId:u.getEntityId()}),e?console.log("DetailViewController: Don't show any message or redirect"):(console.log("DetailViewController: Show success message on %o",n),n.$broadcast("notification",{type:"success",message:"web.backoffice.detail.saveSuccess"})),u.updateData(),t||null},function(e){return n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.saveError",variables:{errorMessage:e.message}}),o.reject(e)})},u.makeSaveRequest=function(){for(var e=0;e<u.registeredComponents.length;e++)if(angular.isFunction(u.registeredComponents[e].isValid)&&!u.registeredComponents[e].isValid())return o.reject(new Error("Not all required fields filled out."));return u.executePreSaveTasks().then(function(){return u.makeMainSaveCall()}).then(function(){return u.executePostSaveTasks()})},u.executePreSaveTasks=function(){for(var e=[],t=0;t<u.registeredComponents.length;t++){var n=u.registeredComponents[t];n.beforeSaveTasks&&angular.isFunction(n.beforeSaveTasks)&&e.push(n.beforeSaveTasks())}return console.log("DetailView: executePreSaveTasks has %o tasks",e.length),o.all(e)},u.executePostSaveTasks=function(){var e=[];return u.registeredComponents.forEach(function(t){t.afterSaveTasks&&angular.isFunction(t.afterSaveTasks)&&e.push(t.afterSaveTasks())}),console.log("DetailView: executePostSaveTasks has %o tasks",e.length),o.all(e)},u.makeMainSaveCall=function(){var e=u.generateSaveCalls();console.log("DetailView: Save calls are %o",e);for(var n,a,i=[],r=0;r<e.length;r++)angular.isObject(e[r].url)||e[r].url&&0!==e[r].url.indexOf("/"+u.getEntityName())?i.push(e[r]):n=e[r];return n||u.getEntityId()||(n={method:"POST",url:"/"+u.getEntityName()}),console.log("DetailView: Main save call is %o, other calls are %o",n,i),u.executeSaveRequest(n).then(function(e){a=e,console.log("DetailView: Made main save call; got back %o",a),a&&a.id&&(t.entityId=a.id);var n=[];return i.forEach(function(e){n.push(u.executeSaveRequest(e))}),o.all(n)}).then(function(){return a&&a.id?(console.log("DetailView: Made call to the main entity; return it's id %o",a.id),a.id):null})},u.addCall=function(e,t){e.url||(e.url=u.getEntityUrl()),e.method||(/\/\d*\/?$/.test(e.url)?e.method="PATCH":e.method="POST");var n=this.getSaveCall(t,e.method,e.url);if(e.hasOwnProperty("headers")&&(n=!1),n){if(e.data)for(var o in e.data)n.data[o]=e.data[o]}else n={method:e.method,url:e.url,data:e.data,headers:e.headers||{}},t.push(n)},u.getSaveCall=function(e,t,n){var o=!1;return e.some(function(e){var a=e.url===n||!e.url&&!n,i=e.method.toLowerCase()===t.toLowerCase();if(i&&a)return o=e,!0}),o},u.executeSaveRequest=function(e){if(!e){console.log("DetailView: No call to be made");var t=o.defer();return t.resolve(),t.promise}var n;if(angular.isObject(e.url)){if(!e.url.path)return console.error("DetailViewController: url property is missing on path on %o",e),o.reject("Got invalid call data, path property missing on url for "+JSON.stringify(e));var a=u.getEntityId()?u.getEntityName()+"/"+u.getEntityId():u.getEntityName(),i=e.url.path.replace(/^\/*/,"").replace(/\/*$/,"");n="prepend"===e.url.mainEntity?"/"+a+"/"+i:"append"===e.url.mainEntity?"/"+i+"/"+a:e.url.path}else e.url&&0===e.url.indexOf("/")?n=e.url:(n="/"+u.getEntityName(),u.getEntityId()&&(n+="/"+u.getEntityId()),e.url&&(n+="/"+e.url));return console.log("DetailView: Make %s call to %s with %o. Call is %o, entityName is %o.",e.method,n,e.data,e,u.getEntityName()),e.data||(e.data={}),l.request({url:n,data:e.data,method:e.method,headers:e.headers})},u.generateSaveCalls=function(){var e=[];console.log("DetailView: Generate calls for %o registered components",u.registeredComponents.length);for(var t=0;t<u.registeredComponents.length;t++){var n=u.registeredComponents[t];if(n.getSaveCalls&&angular.isFunction(n.getSaveCalls)){var o=n.getSaveCalls();o!==!1?(angular.isArray(o)||(o=[o]),console.log("DetailView: componentCalls are %o for %o",o,n),o.forEach(function(t){u.addCall(t,e)})):console.log("DetailView: No save calls for %o",n)}else console.error("DetailView: Missing getSaveCalls on component %o",n[t])}return console.log("DetailView: calls are %o",e),e},t["delete"]=function(e){console.log("DetailView: Delete");
var t=confirm(i("translate")("web.backoffice.detail.confirmDeletion"));if(t)return u.makeDeleteRequest().then(function(t){return e||(r.go("app.list",{entityName:u.getEntityName()}),n.$broadcast("notification",{type:"success",message:"web.backoffice.detail.deleteSuccess"})),!0},function(t){return e||n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.deleteError",variables:{errorMessage:t}}),o.reject(t)})},u.makeDeleteRequest=function(){return console.log("DetailView: Make DELETE request"),l.request({url:"/"+u.getEntityName()+"/"+u.getEntityId(),method:"DELETE"})}}])}(),angular.module("jb.backofficeDetailView").controller("DetailViewLoaderController",["$scope","$location","$http","$q","$compile",function(e,t,n,o,a){var i=this,r=t.path(),l=r.split("/");if(!l.length)return void alert("no path provided");var s=l[1],c=l[2];console.log("DetailViewLoader: entity name is %o, id %o",s,c),i.getControllerAndTemplate=function(e,t){if(!e)return!1;var n,o,a=e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),i="src/app/"+a+"/";return t?"new"!==t&&isNaN(parseInt(t,10))?console.error("unknown entity id: %o",t):n=i+a+"-detail.tpl.html":(o="backoffice"+e.substring(0,1).toUpperCase()+e.substring(1)+"ListController",n=i+a+"-list.tpl.html"),{controllerName:o,templateUrl:n}},i.getTemplate=function(e){return n({method:"GET",url:e,headers:{accept:"text/html"}}).then(function(e){return console.log("DetailViewLoader: got template %o",e),e.data},function(e){return o.reject(e)})},i.renderTemplate=function(t,n){var o=$("[ng-view], [data-ng-view]"),i=$("<div></div>");n&&i.attr("data-ng-controller",n),i.html(t),console.log("DetailViewLoader: render Template %o with controller %o",i,n),o.empty().append(i),a(i)(e)},i.init=function(){var e=i.getControllerAndTemplate(s,c);if(!e)return void i.renderTemplate("404 – Page could not be found",!1);var t=e.templateUrl,n=e.controllerName;i.getTemplate(t).then(function(e){i.renderTemplate(e,n)},function(e){var n=$("[ng-view], [data-ng-view]");n.text("Template "+t+" not found. Entity can't be edited")})},i.init()}]),angular.module("jb.backofficeHiddenInput",[]).directive("hiddenInput",[function(){return{require:["hiddenInput","^detailView"],controller:"HiddenInputController",link:function(e,t,n,o){o[0].init(t,o[1])},scope:!0}}]).controller("HiddenInputController",["$scope","$attrs",function(e,t){var n,o,a=this;a.init=function(e,t){n=e,o=t,o.register(a)},a.isValid=function(){return!0},console.log("HiddenInput: for is %o, read %o (hasProperty %o) evals to %o",t["for"],t.read,t.hasOwnProperty("read"),e.$parent.$eval(t.read)),t.hasOwnProperty("read")&&!e.$parent.$eval(t.read)||(a.select=t["for"]),a.getSaveCalls=function(){var n=!t.hasOwnProperty("write")||e.$parent.$eval(t.write);if(console.log("HiddenInput: Get save calls; $attrs.data is %o, writeData is %o, data-write is %o and evals to %o",t.data,n,t.write,e.$parent.$eval(t.write)),n&&t.data){var a=t["for"]&&t["for"].indexOf(".")>-1;if(a){var i=t["for"].substring(0,t["for"].lastIndexOf(".")),r=i+"/"+t.data;return console.log("HiddenInput: Store relation %o",r),{url:r,method:"POST"}}var l={};return l[t["for"]]=t.data,console.log("HiddenInput: Store data %o",l),{url:"",data:l,method:o.getEntityId()?"PATCH":"POST"}}return!1}}]),angular.module("jb.fileDropComponent",[]).directive("fileDropComponent",[function(){return{require:["fileDropComponent"],controller:"FileDropComponentController",controllerAs:"fileDropComponent",bindToController:!0,link:function(e,t,n,o){o[0].init(t)},scope:{supportedFileTypes:"=",files:"=model",errorHandler:"&",maxFileCount:"@"}}}]).controller("FileDropComponentController",["$scope",function(e){function t(e){u.errorHandler&&angular.isFunction(u.errorHandler)&&u.errorHandler({error:e})}function n(){d.bind("drop",a).bind("dragover",o).bind("dragenter",o).bind("dragleave",i)}function o(e){return e.preventDefault(),e.originalEvent.dataTransfer.effectAllowed="copy",!1}function a(e){e.preventDefault();var t=e.originalEvent.dataTransfer.files;return l(t),!1}function i(e){}function r(){d.find("input[type='file']").change(function(e){return e.target.files&&e.target.files.length?void l(e.target.files):void console.log("BackofficeImageComponentController: files field on ev.target missing: %o",e.target)})}function l(e){for(var n=[],o=0;o<e.length;o++){var a=e[o];s(a)?c(a):n.push(a.name)}n.length&&(console.warn("FileDropComponentController: Invalid file ",JSON.stringify(n)),t(new Error("Tried to upload files with invalid file type: "+n.join(", ")+". Allowed are "+u.supportedFileTypes.join(", "))+"."))}function s(e){return!u.supportedFileTypes||!angular.isArray(u.supportedFileTypes)||u.supportedFileTypes.indexOf(e.type)>-1}function c(t){var n=new FileReader;n.onload=function(o){var a={file:t,fileSize:t.size,mimeType:t.type,height:void 0,width:void 0,fileData:o.target.result};try{var i=new Image;i.src=n.result,i.onload=function(){var t=this;e.$apply(function(){a.width=t.width,a.height=t.height})}}catch(r){console.error("FileDropComponentController: Error reading file: %o",r)}e.$apply(function(){u.files.push(a)})},n.readAsDataURL(t)}var d,u=this;u.files=[],u.state="undefined",u.init=function(e,t){d=e,n(),r()}}]),function(){angular.module("jb.localeComponent",["jb.apiWrapper","jb.backofficeShared"]).directive("localeComponent",[function(){return{link:function(e,t,n,o){o.init(t)},controller:"LocaleComponentController",templateUrl:"localeComponentTemplate.html",scope:{fields:"=",model:"=",entityName:"=",tableName:"=",setValidity:"&"}}}]).controller("LocaleComponentController",["$scope","APIWrapperService","backofficeFormEvents",function(e,t,n){var o,a=this;this.formEvents=n,e.languages=[],e.selectedLanguages=void 0,e.fieldDefinitions=[],a.init=function(t,i){o=t,setTimeout(function(){a.adjustHeightOfAllAreas()},1e3),a.setupFieldDefinitionWatcher(),a.setupValidityWatcher(),a.setupSelectedLanguagesWatcher(),e.$emit(n.registerComponents,a)},a.setupSelectedLanguagesWatcher=function(){e.$watch("selectedLanguages",function(e){if(e&&angular.isArray(e)&&0!==e.length){var t=Math.floor(100/e.length)+"%";o.find(".locale-col").css("width",t),setTimeout(function(){a.adjustHeightOfAllAreas()})}},!0)},a.setupValidityWatcher=function(){e.$watch("model",function(t){if(e.setValidity&&angular.isFunction(e.setValidity)){if(!angular.isObject(t)||!Object.keys(t))return void e.setValidity({validity:!0});var n=a.getRequiredFields(),o=!0;Object.keys(t).forEach(function(e){var a=t[e],i=Object.keys(a);console.log("LocaleComponentController: used fields %o, required %o in %o",i,n,a),n.some(function(e){i.indexOf(e)===-1&&(o=!1,console.log("LocaleComponentController: Required field %o missing in %o",e,a))})}),e.setValidity({validity:o})}},!0)},a.isFieldValid=function(t,n){var o=a.getRequiredFields(),i=e.model[t];return!i||!angular.isObject(i)||(o.indexOf(n)===-1||!(!i[n]&&""!==i[n]))},e.isFieldValid=function(e,t){return a.isFieldValid(e,t)},a.getRequiredFields=function(){var t=[];return e.fieldDefinitions.forEach(function(e){e.required&&t.push(e.name)}),t},e.adjustHeight=function(e){a.adjustHeight($(e.currentTarget))},a.adjustHeightOfAllAreas=function(){o.find("textarea").each(function(){a.adjustHeight($(this))})},a.adjustHeight=function(e){var t=e,n=$(document.createElement("div")),o=["font-size","font-family","font-weight","lineHeight","width","padding-top","padding-left","padding-right"];o.forEach(function(e){n.css(e,t.css(e))}),n.css("position","relative").css("top","-10000px").text(t.val()).appendTo("body");var a=Math.min(n.height(),200);n.remove(),t.height(Math.max(a,parseInt(t.css("lineHeight"),10)))},e.isSelected=function(t){return e.selectedLanguages.indexOf(t)>-1},e.hasTranslation=function(t){if(!e.model[t])return!1;var n=0;for(var o in e.model[t])e.model[t][o]&&n++;return n>0},a.setupFieldDefinitionWatcher=function(){e.$watchGroup(["tableName","fields"],function(){a.getFieldDefinitions()})},a.getFieldDefinitions=function(){return e.fields&&e.tableName?void t.request({url:"/"+e.tableName,method:"OPTIONS"}).then(function(e){a.parseOptionData(e)},function(t){console.error("LocaleComponentController: Could not get OPTION data for table %o: %o",e.tableName,t)}):void console.log("LocaleComponentController: fields or tableName not yet ready")},a.parseOptionData=function(t){console.log("LocaleComponentController: Parse OPTIONS data %o",t),e.fieldDefinitions=[],e.fields.forEach(function(n){e.fieldDefinitions.push({name:n,required:!t[n].nullable,valid:!0})})}}]).run(function(e){e.put("localeComponentTemplate.html","<div class='locale-component'><div data-language-menu-component data-selected-languages='selectedLanguages' data-is-multi-select='true' data-has-translation='hasTranslation(languageId)'></div><div class='locale-content clearfix'><div class='locale-col' data-ng-repeat='lang in selectedLanguages'><p>{{ lang.code | uppercase }}</p><div data-ng-repeat='fieldDefinition in fieldDefinitions'><label data-ng-attr-for='locale-{{lang.id}}-{{fielDefinition.name}}' data-ng-class='{ \"invalid\": !isFieldValid(lang.id, fieldDefinition.name)}'><span data-translate='web.backoffice.{{entityName}}.{{fieldDefinition.name}}' ></span> <span class='required-indicator'data-ng-show='fieldDefinition.required'>*</span></label><textarea data-ng-model='model[ lang.id ][ fieldDefinition.name ]' data-ng-attr-id='locale-{{lang.id}}-{{fieldDefinition.name}}' class='form-control' data-ng-keyup='adjustHeight( $event )' data-ng-focus='adjustHeight( $event )' /></textarea></div></div></div></div>")})}(),function(e){function t(e){this.api=e,this.fieldTypeMapping={string:"text",decimal:"number",integer:"number","boolean":"boolean",json:"json",datetime:"datetime",date:"datetime"}}var n=angular.module("jb.backofficeAPIWrapper",["jb.apiWrapper"]);t.prototype.request=function(e,t,n){var o=n!==!1&&e?angular.copy(t):t;return o.method=e,this.api.request(o)},t.prototype.getOptions=function(e,t){var n=angular.copy(t)||{};return n.url=e,this.request("OPTIONS",n,!1).then(this.normalizeOptions.bind(this))},t.prototype.normalizeMappings=function(e,t){Object.keys(e).forEach(function(n){var o=e[n],a={};a.type="relation",a.entity=o.modelName,a.relationKey=o.key,a.relatedKey=o.primaryKey,a.relation=o.hasAlias?o.name:o.modelName,a.alias=!!o.hasAlias&&o.name,a.relationType="multiple",a.originalRelation="hasMany",a.tableName=o.table.name,"language"===a.entity&&(a.type="language"),"image"===a.entity&&(a.type="image"),t[n]=a})},t.prototype.normalizeReferences=function(e,t){Object.keys(e).forEach(function(n){var o=e[n],a={};a.type="relation",a.entity=o.referencedModelName,a.relation=o.hasAlias?o.name:o.referencedModelName,a.alias=!!o.hasAlias&&o.name,a.relationType="single",a.required=o.nullable===!1,a.originalRelation="hasOne",a.relationKey=o.key,a.relatedKey=o.referencedColumn,t[n]=a,t.internalReferences=t.internalReferences||{},t.internalReferences[a.relationKey]=a,"image"==a.entity&&(a.type="image")})},t.prototype.normalizeInverseReferences=function(e,t){Object.keys(e).forEach(function(n){var o=e[n];t[n]={type:"relation",entity:o.modelName,relation:o.hasAlias?o.name:o.modelName,relatedKey:o.referencedColumn,alias:!!o.hasAlias&&o.name,relationType:"multiple",required:!1,originalRelation:"belongsTo"}})},t.prototype.normalizeFields=function(e,t){Object.keys(e).forEach(function(n){var o=e[n];if(o.name&&o.type){var a=this.fieldTypeMapping[o.type];if(angular.isDefined(a)){var i={type:a,required:!o.nullable,isPrimary:o.name===e.primaryKey,name:o.name};"datetime"==a&&(i.time="datetime"===o.type),t[n]=i,angular.isUndefined(t.internalFields)&&(t.internalFields={}),t.internalFields[o.name]=i}else console.error("DetailViewController: unknown field type %o",o.type)}},this)},t.prototype.normalizeOptions=function(e){var t={},n=angular.copy(e),o=n.hasMany,a=n.belongsTo,i=n.hasOne;return delete n.hasMany,delete n.belongsTo,delete n.hasOne,this.normalizeReferences(i,t),this.normalizeInverseReferences(a,t),this.normalizeMappings(o,t),this.normalizeFields(n,t),console.log("DetailView: parsed options are %o",t),t},n.service("BackofficeAPIWrapperService",["APIWrapperService",t])}(),function(){angular.module("jb.backofficeShared",[]).directive("dragDropList",[function(){return{link:function(t,n,o,a){var i,r=new MutationObserver(function(t){var o=0;[].forEach.call(t,function(e){e.addedNodes&&e.addedNodes.length&&(o+=e.addedNodes.length)}),o>0&&(i.destroy(),i=new e(n[0].querySelectorAll('[draggable="true"]')))});r.observe(n[0],{childList:!0}),t.$on("$destroy",function(){r.disconnect()}),i=new e(n[0].querySelectorAll('[draggable="true"]'))},scope:{}}}]);var e;!function(){function t(e){e.removeEventListener("dragstart",o)}function n(e){e.addEventListener("dragstart",o),e.addEventListener("dragenter",a),e.addEventListener("dragover",r),e.addEventListener("dragleave",i),e.addEventListener("drop",l),e.addEventListener("dragend",c)}function o(e){e.currentTarget.style.opacity="0.4",u=e.currentTarget,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.currentTarget.outerHTML)}function a(e){e.target.classList.add("drag-over")}function i(e){e.target.classList.remove("drag-over")}function r(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}function l(e){e.stopPropagation&&e.stopPropagation();var t=s(u);if(u!==e.currentTarget){console.log("dragDropList: Drop: %o after %o",u,e.currentTarget),angular.element(e.currentTarget).after(u);var n=new CustomEvent("orderChange",{bubbles:!0,detail:{oldOrder:t,newOrder:s(e.currentTarget)+1}});e.currentTarget.dispatchEvent(n)}return!1}function s(e){for(var t=e.parentNode.childNodes,n=0,o=0;o<t.length;o++){if(e===t[o])return n;1===t[o].nodeType&&n++}return-1}function c(e){u.style.opacity="1",u=void 0,[].forEach.call(d,function(e){e.classList.remove("drag-over")})}var d,u;e=function(e){d=e,console.log("DragDropList: Initialize for elements %o",e),[].forEach.call(e,function(e){e.setAttribute("draggable",!0),n(e)})},e.prototype.destroy=function(){console.log("DragDropList: Destroy event handlers on %o elements",d.length),[].forEach.call(d,function(e){t(e)})}}()}(),function(){angular.module("jb.getQuery",[])}(),function(){angular.module("jb.backofficeShared").directive("languageMenuComponent",[function(){return{require:["languageMenuComponent"],controller:"LanguageMenuComponentController",controllerAs:"languageMenuComponent",bindToController:!0,templateUrl:"languageMenuComponentTemplate.html",link:function(e,t,n,o){o[0].init(t)},scope:{selectedLanguages:"=",isMultiSelect:"=",hasTranslation:"&"}}}]).controller("LanguageMenuComponentController",["SessionService",function(e){var t,n=this;n.languages=[],n.selectedLanguages=[],n.init=function(e){t=e,n.getLanguages()},n.toggleLanguage=function(e,t){if(e&&e.originalEvent&&e.originalEvent instanceof Event&&e.preventDefault(),!n.isMultiSelect)return void(n.selectedLanguages=[t]);if(1!==n.selectedLanguages.length||n.selectedLanguages[0].id!==t.id){var o=!1;n.selectedLanguages.some(function(e,n){if(e.id===t.id)return o=n,!0}),o!==!1?n.selectedLanguages.splice(o,1):n.selectedLanguages.push(t)}},n.isSelected=function(e){var t=!1;return n.selectedLanguages.some(function(n){if(e.id===n.id)return t=!0,!0}),t},n.getLanguages=function(){var t=e.get("supported-languages","local");return console.log("languageMenuComponent: Got languages %o",t),t?void t.forEach(function(e){n.languages.push({id:e.language.id,code:e.language.code}),0===n.selectedLanguages.length&&n.toggleLanguage(null,n.languages[0]),console.log("LanguageMenuComponentController: supported languages are %o, selected is %o",n.languages,n.selectedLanguages)}):void console.error("LanguageMenuComponentController: supported-languages cannot be retrieved from Session")},n.checkForTranslation=function(e){return n.hasTranslation&&angular.isFunction(n.hasTranslation)||console.warn("LanguageMenuComponentController: No hasTranslation function was passed"),n.hasTranslation({languageId:e})}}]).run(["$templateCache",function(e){e.put("languageMenuComponentTemplate.html","<ul class='nav nav-tabs'><li data-ng-repeat='lang in languageMenuComponent.languages' data-ng-class='{active:languageMenuComponent.isSelected(lang)}'><a href='#' data-ng-click='languageMenuComponent.toggleLanguage( $event, lang )'>{{lang.code|uppercase}}<span data-ng-if='languageMenuComponent.checkForTranslation(lang.id)' class='fa fa-check'></span></a></li></ul>")}])}(),function(e,t,n,o){function a(t,o){this.w=e(n),this.el=e(t),this.options=e.extend({},l,o),this.init()}var i="ontouchstart"in n,r=function(){var e=n.createElement("div"),o=n.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",o.appendChild(e);var a=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return o.removeChild(e),!!a}(),l={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};a.prototype={init:function(){var n=this;n.reset(),n.el.data("nestable-group",this.options.group),n.placeEl=e('<div class="'+n.options.placeClass+'"/>'),e.each(this.el.find(n.options.itemNodeName),function(t,o){n.setParent(e(o))}),n.el.on("click","button",function(t){if(!n.dragEl){var o=e(t.currentTarget),a=o.data("action"),i=o.parent(n.options.itemNodeName);"collapse"===a&&n.collapseItem(i),"expand"===a&&n.expandItem(i)}});var o=function(t){var o=e(t.target);if(!o.hasClass(n.options.handleClass)){if(o.closest("."+n.options.noDragClass).length)return;o=o.closest("."+n.options.handleClass)}o.length&&!n.dragEl&&(n.isTouch=/^touch/.test(t.type),n.isTouch&&1!==t.touches.length||(t.preventDefault(),n.dragStart(t.touches?t.touches[0]:t)))},a=function(e){n.dragEl&&(e.preventDefault(),n.dragMove(e.touches?e.touches[0]:e))},r=function(e){n.dragEl&&(e.preventDefault(),n.dragStop(e.touches?e.touches[0]:e))};i&&(n.el[0].addEventListener("touchstart",o,!1),t.addEventListener("touchmove",a,!1),t.addEventListener("touchend",r,!1),t.addEventListener("touchcancel",r,!1)),n.el.on("mousedown",o),n.w.on("mousemove",a),n.w.on("mouseup",r)},serialize:function(){var t,n=0,o=this,a=function(t,n){var i=[],r=t.children(o.options.itemNodeName);return r.each(function(){var t=e(this),r=e.extend({},t.data()),l=t.children(o.options.listNodeName);l.length&&(r.children=a(l,n+1)),i.push(r)}),i};return t=a(o.el.find(o.options.listNodeName).first(),n)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var a=this.mouse,i=e(t.target),r=i.closest(this.options.itemNodeName);this.placeEl.css("height",r.height()),a.offsetX=t.offsetX!==o?t.offsetX:t.pageX-i.offset().left,a.offsetY=t.offsetY!==o?t.offsetY:t.pageY-i.offset().top,a.startX=a.lastX=t.pageX,a.startY=a.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=e(n.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",r.width()),r.after(this.placeEl),r[0].parentNode.removeChild(r[0]),r.appendTo(this.dragEl),e(n.body).append(this.dragEl),this.dragEl.css({left:t.pageX-a.offsetX,top:t.pageY-a.offsetY});var l,s,c=this.dragEl.find(this.options.itemNodeName);for(l=0;l<c.length;l++)s=e(c[l]).parents(this.options.listNodeName).length,s>this.dragDepth&&(this.dragDepth=s)},dragStop:function(e){var t=this.dragEl.children(this.options.itemNodeName).first();t[0].parentNode.removeChild(t[0]),this.placeEl.replaceWith(t),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(o){var a,i,l,s,c,d=this.options,u=this.mouse;this.dragEl.css({left:o.pageX-u.offsetX,top:o.pageY-u.offsetY}),u.lastX=u.nowX,u.lastY=u.nowY,u.nowX=o.pageX,u.nowY=o.pageY,u.distX=u.nowX-u.lastX,u.distY=u.nowY-u.lastY,u.lastDirX=u.dirX,u.lastDirY=u.dirY,u.dirX=0===u.distX?0:u.distX>0?1:-1,u.dirY=0===u.distY?0:u.distY>0?1:-1;var p=Math.abs(u.distX)>Math.abs(u.distY)?1:0;if(!u.moving)return u.dirAx=p,void(u.moving=!0);u.dirAx!==p?(u.distAxX=0,u.distAxY=0):(u.distAxX+=Math.abs(u.distX),0!==u.dirX&&u.dirX!==u.lastDirX&&(u.distAxX=0),u.distAxY+=Math.abs(u.distY),0!==u.dirY&&u.dirY!==u.lastDirY&&(u.distAxY=0)),u.dirAx=p,u.dirAx&&u.distAxX>=d.threshold&&(u.distAxX=0,l=this.placeEl.prev(d.itemNodeName),u.distX>0&&l.length&&!l.hasClass(d.collapsedClass)&&(a=l.find(d.listNodeName).last(),c=this.placeEl.parents(d.listNodeName).length,c+this.dragDepth<=d.maxDepth&&(a.length?(a=l.children(d.listNodeName).last(),a.append(this.placeEl)):(a=e("<"+d.listNodeName+"/>").addClass(d.listClass),a.append(this.placeEl),l.append(a),this.setParent(l)))),u.distX<0&&(s=this.placeEl.next(d.itemNodeName),s.length||(i=this.placeEl.parent(),this.placeEl.closest(d.itemNodeName).after(this.placeEl),i.children().length||this.unsetParent(i.parent()))));var f=!1;if(r||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(n.elementFromPoint(o.pageX-n.body.scrollLeft,o.pageY-(t.pageYOffset||n.documentElement.scrollTop))),r||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(d.handleClass)&&(this.pointEl=this.pointEl.parent(d.itemNodeName)),this.pointEl.hasClass(d.emptyClass))f=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(d.itemClass))return;var m=this.pointEl.closest("."+d.rootClass),g=this.dragRootEl.data("nestable-id")!==m.data("nestable-id");if(!u.dirAx||g||f){if(g&&d.group!==m.data("nestable-group"))return;if(c=this.dragDepth-1+this.pointEl.parents(d.listNodeName).length,c>d.maxDepth)return;var h=o.pageY<this.pointEl.offset().top+this.pointEl.height()/2;i=this.placeEl.parent(),f?(a=e(n.createElement(d.listNodeName)).addClass(d.listClass),a.append(this.placeEl),this.pointEl.replaceWith(a)):h?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),i.children().length||this.unsetParent(i.parent()),this.dragRootEl.find(d.itemNodeName).length||this.dragRootEl.append('<div class="'+d.emptyClass+'"/>'),g&&(this.dragRootEl=m,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},e.fn.nestable=function(t){var n=this,o=this;return n.each(function(){var n=e(this).data("nestable");n?"string"==typeof t&&"function"==typeof n[t]&&(o=n[t]()):(e(this).data("nestable",new a(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),o||n}}(window.jQuery||window.Zepto,window,document);