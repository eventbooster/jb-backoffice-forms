!function(e){"use strict";angular.module("jb.backofficeForms",["jb.formComponents"])}(),function(){"use strict";angular.module("jb.formComponents",["jb.fileDropComponent","jb.apiWrapper","pascalprecht.translate","jb.formEvents"])}(),function(){function e(e,t,n){this.registeredComponents=[],this.scope=n,this.optionsDataHandlers=[],this.getDataHandlers=[],this.$q=e,this.formEvents=t,this.unregistrationHandlers=[]}var t=angular.module("jb.formEvents",[]);t.provider("jbFormEvents",function(){var e={registerComponent:"jb.backoffice-form-event.registerComponent"};this.setEventKey=function(t,n){e[t]=n},this.hasEventKeyAt=function(t){return angular.isDefined(e[t])},this.getEventKeyAt=function(t){return e[t]},this.removeEventKey=function(t){delete e[t]},this.$get=[function(){return Object.freeze(e)}]}),e.prototype.listen=function(){return this.scope.$on(this.formEvents.registerComponent,function(e,t,n){console.log("REGISTRATION OF:",t),t!==this&&(e.stopPropagation(),n.$on("$destroy",function(){this.unregisterComponent(t)}.bind(this)),this.registerComponent(t))}.bind(this)),this},e.prototype.registerComponent=function(e){this.registeredComponents.push(e),e.registerAt(this)},e.prototype.onUnregistration=function(e){this.unregistrationHandlers.push(e)},e.prototype.unregisterComponent=function(e){var t=this.registeredComponents.indexOf(e);t>=0&&(angular.isFunction(e.unregisterAt)?e.unregisterAt(this):console.warn("JBFormComponentsRegistry: Component %o does not know how to react to unlinking",e),this.registeredComponents.splice(t,1),this.unregistrationHandlers.forEach(function(n){n(e,t)}))},e.prototype.getSaveCalls=function(){return this.registeredComponents.reduce(function(e,t){var n=t.getSaveCalls();return e.concat(n)},[])},e.prototype.isValid=function(){for(var e=0;e<this.registeredComponents.length;e++)if(this.registeredComponents[e].isValid()===!1)return!1;return!0},e.prototype.afterSaveTasks=function(e){return this.getAfterSaveTasks(e)},e.prototype.getAfterSaveTasks=function(e){console.log("JBFormComponentsRegistry: Registered components for afterSaveTasks are %o",this.registeredComponents);var t=this.registeredComponents.filter(function(e){return angular.isFunction(e.afterSaveTasks)}).map(function(t){return t.afterSaveTasks(e)});return console.log("JBFormComponentsRegistry: afterSaveTasks are %o, $q is %o",t,this.$q),this.$q.all(t).then(function(){return console.log("JBFormComponentsRegistry: Done"),e})},e.prototype.beforeSaveTasks=function(e){return this.getBeforeSaveTasks(e)},e.prototype.getBeforeSaveTasks=function(e){var t=this.registeredComponents.reduce(function(t,n){return angular.isFunction(n.beforeSaveTasks)&&t.push(n.beforeSaveTasks(e)),t},[]);return this.$q.all(t).then(function(){return e})},e.prototype.getSelectFields=function(){return console.log("JBFormComponentsRegistry: get select fields for registered component %o",this.registeredComponents),this.registeredComponents.reduce(function(e,t){return console.log("JBFormComponentsRegistry: get select fields for component %o",t),angular.isFunction(t.getSelectFields)?e.concat(t.getSelectFields()):angular.isDefined(t.select)?e.concat(t.select):e},[])},e.prototype.optionsDataHandler=function(e){return this.$q.all(this.optionsDataHandlers.map(function(t){return this.$q.when(t(e))},this)).then(function(){return e})},e.prototype.registerOptionsDataHandler=function(e){this.optionsDataHandlers.push(e)},e.prototype.registerGetDataHandler=function(e){this.getDataHandlers.push(e)},e.prototype.unregisterGetDataHandler=function(e){this.getDataHandlers.splice(this.getDataHandlers.indexOf(e),1)},e.prototype.unregisterOptionsDataHandler=function(e){this.optionsDataHandlers.splice(this.optionsDataHandlers.indexOf(e),1)},e.prototype.getDataHandler=function(e){console.log("JBFormComponentsRegistry: Send data to %o handlers, are %o",this.getDataHandlers.length,this.getDataHandlers),this.getDataHandlers.forEach(function(t){t(e)})},e.prototype.distributeIndexed=function(e){return this.distributeIndexedFrom(e,0)},e.prototype.distributeIndexedFrom=function(e,t){for(var n=t;n<this.getDataHandlers.length;n++)this.getDataHandlers[n](e,n)},e.prototype.componentAt=function(e){return this.registeredComponents[e]},e.prototype.registerYourself=function(e,t){var n=e||this.scope,i=t===!0?n:n.$parent;i.$emit(this.formEvents.registerComponent,this,i)},e.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.optionsDataHandler.bind(this)),e.registerGetDataHandler(this.getDataHandler.bind(this))},e.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.optionsDataHandler),e.unregisterGetDataHandler(this.getDataHandler)},t.factory("JBFormComponentsService",["$q","$parse","jbFormEvents",function(t,n,i){return{registryFor:function(n){var o=new e(t,i,n);return o},registerComponent:function(e,t,n){var o=n===!0?e:e.$parent;o.$emit(i.registerComponent,t,e)}}}])}(),function(){"use strict";var e=angular.module("jb.formComponents");e.directive("jbFormImageComponent",[function(){return{controller:"jbFormImageComponentController",controllerAs:"backofficeImageComponent",bindToController:!0,require:"",link:function(e,t,n,i){i.init(e,t,n)},scope:{propertyName:"@for",pathField:"@",images:"=?imageModel",label:"@",serviceName:"@"},template:'<div class="row"><label jb-form-label-component data-label-identifier="{{backofficeImageComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-component" ><div data-file-drop-component data-supported-file-types="[\'image/jpeg\', \'image/png\']" data-model="backofficeImageComponent.images" data-error-handler="backofficeImageComponent.handleDropError(error)"><ol class="clearfix"><li data-ng-repeat="image in backofficeImageComponent.images"><a href="#" data-ng-click="backofficeImageComponent.openDetailView( $event, image )"><img data-ng-attr-src="{{image.url || image.fileData}}"/><button type="button" class="remove" data-ng-click="backofficeImageComponent.removeImage($event,image)">&times</button></a><span class="image-size-info" data-ng-if="!!image.width && !!image.height">{{image.width}}&times;{{image.height}} Pixels</span><span class="image-file-size-info" data-ng-if="!!image.fileSize">{{image.fileSize/1000/1000 | number: 1 }} MB</span><span class="focal-point-info" data-ng-if="!!image.focalPoint">Focal Point</span></li><li><button type="button" class="add-file-button" data-ng-click="backofficeImageComponent.uploadFile()">+</button></li></ol><input type="file" multiple/></div></div></div>'}}]),e.controller("jbFormImageComponentController",["$scope","$rootScope","$q","$state","APIWrapperService","JBFormComponentsService",function(e,t,n,i,o,r){function a(e){var t;try{e.focalPoint&&(t=JSON.parse(e.focalPoint))}catch(t){console.error("jbFormImageComponentController: Could not parse focalPoint JSON",e.focalPoint)}return{url:e[m.pathField],entityUrl:"/"+(m.serviceName?m.serviceName+".":"")+"image/"+e.id,focalPoint:t,width:e.width||"–",height:e.height||"–",fileSize:e.size||"–",mimeType:e.mimeType?e.mimeType.mimeType:"–",id:e.id}}function s(){if(console.log("jbFormImageComponent: Save single relation. Original %o, current %o",h,m.images),!h||!h.length||m.images&&m.images.length){if(h&&h.length||!m.images||!m.images.length){if(h&&h.length&&m.images&&m.images.length&&h[0].id!==m.images[m.images.length-1].id){var e={};return e[p]=m.images[m.images.length-1].id,[{data:e}]}return console.log("jbFormImageComponentController: No changes made to a single relation image"),[]}var t={};return t[p]=m.images[0].id,[{data:t}]}var n={};return n[p]=null,console.log("jbFormImageComponent: Image removed, store data %o",n),[{method:"DELETE",url:{path:(m.serviceName&&"legacy"!==m.serviceName?m.serviceName+".":"")+m.propertyName+"/"+h[0].id,mainEntity:"append"}}]}function l(){var e=[],t=[],n=[];return h&&angular.isArray(h)&&h.forEach(function(e){t.push(e.id)}),m.images.forEach(function(e){n.push(e.id)}),t.forEach(function(t){n.indexOf(t)===-1&&e.push({method:"DELETE",url:"/image/"+t})}),n.forEach(function(n){t.indexOf(n)===-1&&e.push({method:"POST",url:"image/"+n})}),console.log("jbFormImageComponentController: Calls to be made are %o",e),e}function c(e){return console.log("jbFormImageComponentController: Upload file %o to /image through a POST request",e),o.request({method:"POST",data:{image:e.file},url:`/${m.serviceName?m.serviceName+".":""}image`}).then(function(t){var n=m.images.indexOf(e),i=a(t);return m.images.splice(n,1,i),console.log("jbFormImageComponentController: Image uploaded, replace %o with %o",m.images[n],i),t})}var d,p,u,h,m=this;m.images=[],m.init=function(e,t,n,i){d=t,m.ensureSingleImageRelation(),r.registerComponent(e,m)},m.registerAt=function(e){e.registerOptionsDataHandler(m.updateOptionsData),e.registerGetDataHandler(m.updateData)},m.unregisterAt=function(e){e.unregisterOptionsDataHandler(m.updateOptionsData),e.unregisterGetDataHandler(m.updateData)},m.isValid=function(){return!0},m.ensureSingleImageRelation=function(){e.$watchCollection(function(){return m.images},function(){u&&m.images.length>1&&m.images.splice(0,m.images.length-1)})},m.updateData=function(e){m.images=[],e||(e={}),e.image||(e.image=[]),angular.isArray(e.image)||(e.image=[e.image]),h=e.image.slice(),e.image.forEach(function(e){m.images.push(a(e))})},m.selectSpec=function(e){var t,n=e&&e.relations?e.relations:[];if(n.length){t=n.reduce(function(e,t){return"image"===t.remote.resource&&e.push(t),e},[]);for(var i=0;i<t.length;i++){var o=t[i];if(o.name===this.propertyName)return o}}},m.updateOptionsData=function(e){var t=m.selectSpec(e);return t?(u="hasOne"===t.type,void(u&&(p=t.property))):console.error("jbFormImageComponentController: Missing data for %o",m.propertyName)},m.getSelectFields=function(){var e=(this.serviceName?this.serviceName+":":"")+m.propertyName;return[e+".*",e+"."+m.pathField]},m.getSaveCalls=function(){return u?s():l()},m.beforeSaveTasks=function(){var e=[];return m.images.forEach(function(t){t.file&&t.file instanceof File&&(console.log("jbFormImageComponentController: New file %o",t),e.push(c(t)))}),console.log("jbFormImageComponentController: Upload %o",e),n.all(e)},m.removeImage=function(e,t){e.preventDefault(),m.images.splice(m.images.indexOf(t),1)},m.openDetailView=function(e,t){e.preventDefault(),t.id&&i.go("app.detail",{entityName:"image",entityId:t.id})},m.handleDropError=function(n){e.$apply(function(){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.imageDropError",variables:{errorMessage:n}})})},m.uploadFile=function(){d.find("input[type='file']").click()}}])}(),function(e){"use strict";var t=angular.module("jb.formComponents");t.directive("jbFormImageDetailComponent",[function(){return{controller:"JBFormImageDetailComponentController",controllerAs:"backofficeImageDetailComponent",bindToController:!0,link:function(e,t,n,i){i.init(e,t,n)},template:'<label data-backoffice-label data-label-identifier="{{backofficeImageDetailComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-detail-component"><div class="image-container"><img data-ng-attr-src="{{backofficeImageDetailComponent.image[ backofficeImageDetailComponent.pathField ]}}" data-ng-click="backofficeImageDetailComponent.setFocalPointClickHandler($event)"/><div class="focal-point-indicator" data-ng-if="backofficeImageDetailComponent.getFocalPoint()" data-ng-attr-style="top:{{backofficeImageDetailComponent.getFocalPointInPercent().y}}%;left:{{backofficeImageDetailComponent.getFocalPointInPercent().x}}%"></div></div><div data-ng-if="!backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPointNotSet" | translate }}</div><div data-ng-if="backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPoint" | translate }}: {{ backofficeImageDetailComponent.getFocalPoint().x }} / {{backofficeImageDetailComponent.getFocalPoint().y}} </div></div>',scope:{pathField:"@",label:"@"}}}]),t.controller("JBFormImageDetailComponentController",["$scope","JBFormComponentsService",function(e,t){var n,i=this;i.image={},i.init=function(e,n,o){t.registerComponent(e,i)},i.isValid=function(){return!0},i.registerAt=function(e){e.registerGetDataHandler(i.updateData)},i.unregisterAt=function(e){e.unregisterGetDataHandler(i.updateData)},i.updateData=function(e){if(i.image=e,e.focalPoint)try{var t=JSON.parse(e.focalPoint);if(!t.x||!t.y)throw new Error("Property x or y missing on "+e.focalPoint);if(t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),isNaN(t.x)||isNaN(t.y))throw new Error("x or y property on focalPoint not an integer (or castable).");i.image.focalPoint=t}catch(t){console.error("JBFormImageDetailComponentController: Could not parse focalPoint "+e.focalPoint+": "+t.message)}n=angular.copy(e.focalPoint)},i.getSelectFields=function(){return"*,mimeType.*,"+i.pathField},i.getSaveCalls=function(){if(!n&&!i.image.focalPoint)return[];var e=n&&i.image.focalPoint&&n.x&&i.image.focalPoint.x&&i.image.focalPoint.x===n.x,t=n&&i.image.focalPoint&&n.y&&i.image.focalPoint.y&&i.image.focalPoint.y===n.y;if(e&&t)return!1;var o=[];return o.push({method:"PATCH",url:"",data:{focalPoint:JSON.stringify(i.image.focalPoint)}}),o},i.setFocalPointClickHandler=function(e){var t={x:Math.round(e.offsetX/e.target.width*i.image.width),y:Math.round(e.offsetY/e.target.height*i.image.height)};console.log("JBFormImageDetailComponentController: Set focal point to ",JSON.stringify(t)),i.image.focalPoint=t},i.getFocalPoint=function(){return!(!i.image||!i.image.focalPoint)&&i.image.focalPoint},i.getFocalPointInPercent=function(){var e=i.getFocalPoint();return!!e&&{x:Math.round(e.x/i.image.width*100),y:Math.round(e.y/i.image.height*100)}}}])}(),function(e){"use strict";var t=angular.module("jb.formComponents");t.controller("jbFormLabelController",["$scope",function(e){this.$scope=e}]),t.directive("jbFormLabelComponent",["$templateCache","$compile",function(e,t){return{link:function(n,i,o,r){var a=angular.element(e.get("backofficeLabelTemplate.html"));i.replaceWith(a),t(a)(n)},scope:{labelIdentifier:"@",isRequired:"&",isValid:"&"}}}]),t.run(function(e){e.put("backofficeLabelTemplate.html",'<div class="col-md-3"><label class="control-label" data-ng-class="{invalid: !isValid()}"><span data-ng-if="isRequired()||required" class="required-indicator">*</span><span data-translate="{{labelIdentifier}}"></span></label></div>')})}(),function(e){"use strict";function t(e,t,n,i,o,r,a){this.$scope=e,this.api=i,this.$q=t,this.$timeout=n,this.componentsService=o,this.fieldDefinitions=null,this.fields=[];var s=[];(r.get("supported-languages","local")||[]).forEach(function(e){s[e.language.id]={id_language:e.language.id}}),this.locales=this.model||s,this.model=this.locales,this.originalLocales=JSON.parse(JSON.stringify(this.locales)),this.heightElement=null,this.heightElementInitialized=!1,this.boAPI=a,this.supportedLanguages=(r.get("supported-languages","local")||[]).map(function(e){var t=angular.copy(e.language);return t.selected=!1,t},this).sort(function(e,t){return this.languageOrder&&this.languageOrder.length&&this.languageOrder[e.code]&&this.languageOrder[t.code]?this.languageOrder[e.code]<this.languageOrder[t.code]?-1:1:0}.bind(this)),this.element=null}var n=angular.module("jb.formComponents");n.directive("jbFormLocaleComponent",function(){return{controller:"JBFormLocaleComponentController",controllerAs:"$ctrl",bindToController:!0,scope:{fieldsExclude:"<",languageOrder:"<",fieldOrder:"<",entityName:"@entity",relationName:"@relation",isReadonly:"<",model:"=?inputModel"},template:'<div class="locale-component container"><!-- LOCALE-COMPONENT: way too many divs in here --><div class="row"><div class="col-md-12"><ul class="nav nav-tabs col-md-12"><li ng-repeat="language in $ctrl.getSupportedLanguages()" ng-class="{active:$ctrl.isSelected(language)}"><a href="#" ng-click="$ctrl.toggleLanguage($event, language)">{{language.code|uppercase}}<span data-ng-if="$ctrl.checkForTranslation(language)" class="fa fa-check"></span></a></li></ul></div></div><div class="locale-content"><div class="locale-col locale-panel" ng-repeat="language in $ctrl.selectedLanguages" data-language-id="{{language.id}}"><p>{{ language.code | uppercase }}</p><ul ng-if="$ctrl.fieldDefinitions"><li ng-repeat="fieldName in $ctrl.fields"><label ng-attr-for="locale-{{language.code}}-{{fieldName}}" ng-class="{ \'invalid\' : !$ctrl.fieldIsValid($ctrl.locales[ language.id ], fieldName)}"><span data-translate="web.backoffice.{{$ctrl.entityName}}.{{fieldName}}"></span><span class="required-indicator" data-ng-show="fieldDefinitions[fieldName].required">*</span></label><textarea ng-model="$ctrl.locales[ language.id ][ fieldName ]" ng-attr-id="locale-{{language.code}}-{{fieldName}}"class="form-control" ng-disabled="$ctrl.isReadonly"ng-keyup="$ctrl.adjustHeight( $event )" ng-click="$ctrl.adjustHeight( $event )" /></textarea></li></ul></div></div></div>',link:{pre:function(e,t,n,i){i.preLink(e,t,n)},post:function(e,t,n,i){i.postLink(e,t,n)}}}}),t.prototype.preLink=function(){},t.prototype.postLink=function(e,t,n){this.componentsService.registerComponent(e,this),this.heightElement=angular.element("<div></div>"),this.heightElement=this.heightElement.attr("id","locale-height-container"),this.heightElement.css("position","absolute"),this.heightElement.css("left","-9999px"),this.heightElement.css("top","-9999px"),this.element=t,this.element.append(this.heightElement)},t.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},t.prototype.getSelectedLanguages=function(){for(var e=[],t=0;t<this.supportedLanguages.length;t++){var n=this.supportedLanguages[t];n.selected===!0&&e.push(n)}return e},t.prototype.getSupportedLanguages=function(){return this.supportedLanguages},t.prototype.fieldIsValid=function(e,t){var n=this.fieldDefinitions[t];return!e||(n.required!==!0||!this._localePropertyIsEmpty(e[t]))},t.prototype.adjustHeight=function(e){var t=angular.element(e.currentTarget);this.adjustElementHeight(t)},t.prototype.adjustElementHeight=function(e){var t,n=e[0].scrollHeight,i=e.val();this.heightElementInitialized||this.initializeHeightElement(e),e.height(n),t=e.width(),this.heightElement.width(t),i=i.replace(/(\n\r?)/g,"<br>").replace(/(\<br\>\s*)$/,"<br><br>"),""==i.trim()&&(i="empty"),this.heightElement.html(i),this.heightElement.width(t),e.height(this.heightElement.height())},t.prototype.adjustAllHeights=function(){this.element.find("textarea").each(function(e,t){this.adjustElementHeight(angular.element(t))}.bind(this))},t.prototype.initializeHeightElement=function(e){["font-size","font-family","font-weight","letter-spacing","line-height","padding-top","padding-left","padding-right","padding-bottom","border-radius","border"].forEach(function(t){this.heightElement.css(t,e.css(t))},this),this.heightElement.css("word-wrap","break-word"),this.heightElementInitialized=!0},t.prototype.toggleLanguage=function(e,t){e&&e.preventDefault();var n=this.getSelectedLanguages();if(t){if(t.selected&&1==n.length)return;t.selected=t.selected!==!0}this.reassignLanguages().then(this.adjustAllHeights.bind(this))},t.prototype.reassignLanguages=function(){return this.selectedLanguages=this.getSelectedLanguages(),this.$timeout()},t.prototype.isSelected=function(e){return e.selected===!0},t.prototype.checkForTranslation=function(e){return!(!this.locales||!angular.isDefined(this.locales[e.id]))},t.prototype.translationIsEmpty=function(e){return this.fields.reduce(function(t,n){return t&&!e[n]&&""!==e[n].trim()},!0)},t.prototype.selectSpec=function(e){var t=e&&e.relations?e.relations:[];if(t.length)for(var n=0;n<t.length;n++){var i=t[n];if("hasManyAndBelongsToMany"===i.type){if(this.entityName===i.remote.resource)return i;if(this.relationName===i.name)return i}}},t.prototype.handleOptionsData=function(e){var t=this.selectSpec(e);return this.remoteName=t.via.resource,this.remoteService=t.via.service,this.languageName=t.remote.resource,this.languageService=t.remote.service,this.remoteName?this.loadFields().then(function(e){this.fieldDefinitions=this.filterFields(e);var t=Object.keys(this.fieldDefinitions);return this.fields=this.sortFields(t),this.ensureLanguageIsSelected()}.bind(this),function(e){console.error(e)}):console.error("Could not get remote table's name in locale component.")},t.prototype.loadFields=function(){var e="/"+(this.remoteService?this.remoteService+".":"")+this.getLocaleProperty();return this.api.getOptions(e).then(function(e){return e.properties}.bind(this),function(e){console.error(e)})},t.prototype.sortFields=function(e){if(!this.fieldOrder||!this.fieldOrder.length)return e;var t=[],n=this.fieldOrder.length;return e.forEach(function(e){var i=this.fieldOrder.indexOf(e)>-1?this.fieldOrder.indexOf(e):n++;t[i]=e}.bind(this)),t},t.prototype.filterFields=function(e){return e?e.reduce(function(e,t){return this.fieldsExclude&&this.fieldsExclude.indexOf(t.name)!=-1||t.isPrimary===!0||(e[t.name]=t),e}.bind(this),{}):{}},t.prototype._localeIsEmpty=function(e){return this.fields.every(function(t){return this._localePropertyIsEmpty(e[t])},this)},t.prototype._localePropertyIsEmpty=function(e){return angular.isUndefined(e)||""==e.trim()},t.prototype._localeGetChanges=function(e,t){return angular.isDefined(t)?this.fields.reduce(function(n,i){return e[i]!=t[i]&&n.push(i),n}.bind(this),[]):this._localeIsEmpty(e)?[]:this.fields},t.prototype.getSaveCalls=function(){var e=[];return this.isReadonly?e:(this.locales.forEach(function(t,n){var i=this.originalLocales[n],o=!1;if(i&&(o=Object.keys(i).some(e=>{return this.fields.indexOf(e)>-1})),t){var r=this._localeGetChanges(t,i),a=o?"PATCH":"POST";if(r.length>0){var s={};s.data=r.reduce(function(e,n){return e[n]=t[n],e},{}),s.url={},s.url.path=(this.languageService&&"legacy"!==this.languageService?this.languageService+".":"")+this.languageName+"/"+n,s.url.mainEntity="prepend",s.method=a,e.push(s)}}},this),e)},t.prototype.getLocaleProperty=function(){return this.remoteName},t.prototype.handleGetData=function(e){var t=e?e[this.getLocaleProperty()]:e;t&&(this.originalLocales=this.normalizeModel(t),this.locales=angular.copy(this.originalLocales),this.model=this.locales),this.ensureLanguageIsSelected().then(this.adjustAllHeights.bind(this))},t.prototype.ensureLanguageIsSelected=function(){return this.selectedLanguages||(this.selectedLanguages=[]),0===this.selectedLanguages.length?this.toggleLanguage(null,this.supportedLanguages[0]):this.$timeout()},t.prototype.getFields=function(){return this.fieldDefinitions?this.fields.map(function(e){return this.fieldDefinitions[e]},this):[]},t.prototype.normalizeModel=function(e){return e.reduce(function(e,t){return e[t.language.id]=t,e},[])},t.prototype.getLocales=function(){return this.locales},t.prototype.getSelectFields=function(){var e=this.getLocaleProperty(),t=[e,this.languageService?this.languageService+":"+this.languageName:this.languageName,"*"].join("."),n=[];return n.push([e,"*"].join(".")),n.push(t),n},t.prototype.isValid=function(){return!!this.isReadonly||this.locales.reduce(function(e,t,n){return angular.isUndefined(t)?e:angular.isUndefined(this.originalLocales[n])&&this._localeIsEmpty(t)?e:e&&this.fields.reduce(function(e,n){return e&&this.fieldIsValid(t,n)}.bind(this),!0)}.bind(this),!0)},n.controller("JBFormLocaleComponentController",["$scope","$q","$timeout","APIWrapperService","JBFormComponentsService","SessionService","BackofficeAPIWrapperService",t])}(),function(e){"use strict";function t(e){return function(){return{controller:e,controllerAs:"$ctrl",bindToController:!0,link:{pre:function(e,t,n,i){i.preLink(e,t,n)},post:function(e,t,n,i){i.hasLabel=n.hasOwnProperty("label"),i.hasModel=n.hasOwnProperty("relationInputModel"),i.enableFulltext=n.hasOwnProperty("relationEnableFulltextSearch"),i.postLink(e,t,n)}},scope:{propertyName:"@for",entityName:"@entity",relationName:"@relation",defaultValue:"@",serviceName:"@",label:"@?",showLabel:"<?",suggestion:"@suggestionTemplate",searchField:"@",changeHandler:"&",filters:"<",isInteractive:"<?relationIsInteractive",disableRemoveButton:"<?relationDisableRemoveButton",disableNewButton:"<?relationDisableNewButton",disableEditButton:"<?relationDisableEditButton",currentData:"=?relationModel",isReadonly:"<?relationIsReadonly",enableFulltextSearch:"<?relationEnableFulltextSearch",resultCount:"<?relationResultCount"}}}}function n(e,t,n,i,o,r,a){this.subcomponentsService=o,this.options=null,this.originalData=[],this.suggestion="",this.relationService=r,this.$scope=e,this.$compile=n,this.$templateCache=i,this.element=null,this.currentData=[],this.referencedPropertyName=null,this.relationTypes=["hasOne"],this.rendered=!1,this.isWatchingForCallback=!1,this.isMultiSelect=!1,this.parentOptions=null,this._api=a,e.$watch(function(){return this.defaultValue}.bind(this),function(){this.defaultValue&&this.getDefaultValue()}.bind(this))}function i(e,t,i,o,r,a,s){n.call(this,e,t,i,o,r,a,s),this.relationTypes=["hasMany","hasManyAndBelongsToMany"],this.isMultiSelect=!0}var o=angular.module("jb.formComponents");o.directive("jbFormReferenceComponent",[t("JBFormReferenceController")]),o.directive("jbFormRelationComponent",[t("JBFormRelationController")]),n.prototype.preLink=function(){},n.prototype.postLink=function(e,t){angular.isUndefined(this.showLabel)&&(this.showLabel=!0),this.subcomponentsService.registerComponent(e,this),this.element=t},n.prototype.getEntityUrl=function(){var e=this.serviceName&&"legacy"!==this.serviceName?this.serviceName+".":"";return e+=this.entityName},n.prototype.getDefaultValue=function(){if(!this.currentData||!this.currentData.length){var e=this;return console.log("JBFormReferenceController: Get default value from entity %o, filter %o",e.entityName,e.defaultValue),this._api.request({url:e.serviceName?e.serviceName+"."+e.entityName:e.entityName,headers:{filter:e.defaultValue}}).then(function(t){return t&&t.length?void(e.currentData&&e.currentData.length||(console.log("JBFormReferenceController: Update model with default value %o",t),e.defaultValueData=t,e.isWatchingForCallback&&(this.currentData=this.defaultValueData))):void console.log("JBFormReferenceController: Could not get default value for entity %o, filter %o",e.entityName,e.defaultValue)})}},n.prototype.displayLabel=function(){return this.hasLabel&&this.showLabel!==!1},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},n.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},n.prototype.handleGetData=function(e){var t=e.isDummy;if(t=t||!e||!e[this.relationName],t=t||Array.isArray(e[this.relationName])&&!e[this.relationName].length,this.currentData=[],!t){var n=e[this.relationName];angular.isArray(n)||(n=[n]),this.currentData=n}this.originalData=angular.copy(this.currentData),t&&this.defaultValueData&&(this.currentData=this.defaultValueData),this.isWatchingForCallback||(this.$scope.$watch(function(){return this.currentData}.bind(this),function(e,t){this.changeHandler&&this.changeHandler({newValue:e,oldValue:t})}.bind(this)),this.isWatchingForCallback=!0),console.log("BackofficeReferenceComponentController: Model updated (updateData) to %o",this.currentData)},n.prototype.getSpec=function(e){var t,n=e&&e.relations?e.relations:[];if(n.length)for(var i=0;i<n.length;i++)if(t=n[i],this.relationTypes.indexOf(t.type)!==-1){if(t.property&&this.propertyName===t.property)return t;if(t.name&&this.relationName===t.name)return t;if(t.remote.resource&&this.entityName===t.name)return t}},n.prototype.handleOptionsData=function(e){if(this.rendered!==!0){var t=this.getSpec(e);return angular.isDefined(t)?(this.parentOptions=e,this.adaptToSpec(t)?this.renderComponent():void 0):console.error("JBFormRelationComponent: No options data found for name %o referencing entity %o or relation %o in data %o.",this.propertyName,this.entityName,this.relationName,e)}},n.prototype.adaptToSpec=function(e){return this.propertyName=e.property,this.entityName=e.remote.resource,this.relationName=e.name,this.referencedPropertyName=e.remote.property,this.options=e,!0},n.prototype.renderComponent=function(){var e=angular.element(this.$templateCache.get("referenceComponentTemplate.html"));this.$compile(e)(this.$scope),this.element.prepend(e),this.rendered=!0},n.prototype.addModelTransformations=function(e){return e.attr("sanitize-model",!0)},n.prototype.isInteractive=function(){return console.info(this.interactive),!angular.isDefined(this.interactive)||this.interactive},n.prototype.isDeletable=function(){return this.options&&!this.isRequired()&&this.options.permissions&&(this.options.permissions.deleteRelation===!0||this.options.permissions.deleteOneRelation===!0)},n.prototype.isCreatable=function(){return!this.options||!this.options.permissions||this.options.permissions.createRelation===!0},n.prototype.getLabel=function(){return this.label?this.label:this.propertyName},n.prototype.getSelectFields=function(){var e,t=this.relationService.extractSelectFields(this.getSuggestionTemplate());return e=t.map(function(e){var t="";return this.serviceName&&(t+=this.serviceName+":"),t+=this.relationName+"."+e},this),this.propertyName&&e.unshift(this.propertyName),e},n.prototype.isRequired=function(){const t=this.parentOptions&&this.parentOptions.properties?this.parentOptions.properties.find(e=>e.name===this.propertyName):e;return!!t&&t.nullable!==!0},n.prototype.getSuggestionTemplate=function(){return this.suggestion},n.prototype.getSearchField=function(){return this.searchField},n.prototype.isValid=function(){return!this.isRequired()||this.currentData.length>0},n.prototype.getSaveCalls=function(){var e,t,n=this.currentData[0],i=this.originalData[0];if(n&&(e=n[this.referencedPropertyName]),i&&(t=i[this.referencedPropertyName]),console.log("JBFormReferenceController: current model is %o, original %o; currentProperty %o, originalProperty %o",n,i,e,t),t!==e){var o={data:{}};return o.data[this.propertyName]=angular.isDefined(e)?e:"",[o]}return[]},i.prototype=Object.create(n.prototype),i.prototype.constructor=i,i.prototype.getSaveCalls=function(){var e,t=this.mapProperties(this.currentData,this.propertyName);return e=this.originalData.reduce(function(e,n){var i=n[this.propertyName];return angular.isDefined(t[i])?delete t[i]:e.push({method:"DELETE",url:{path:(this.serviceName&&"legacy"!==this.serviceName?this.serviceName+".":"")+[this.relationName,i].join("/"),mainEntity:"append"}}),e}.bind(this),[]),Object.keys(t).forEach(function(t){e.push({method:"POST",url:{path:(this.serviceName&&"legacy"!==this.serviceName?this.serviceName+".":"")+this.relationName+"/"+t,mainEntity:"append"}})},this),e},i.prototype.mapProperties=function(e,t){return e.reduce(function(e,n){return e[n[t]]=n,e},{})},i.prototype.rateSpec=function(e){var t=0;return this.relationTypes.indexOf(e.type)===-1?t:(e.name&&this.relationName===e.name&&t++,e.remote.resource&&this.entityName===e.remote.resource&&t++,t)},i.prototype.getSpec=function(e){var t,n=e&&e.relations?e.relations:[],i=0;if(n.length&&(t=n.reduce(function(e,t){var n=this.rateSpec(t);return e[n]||(e[n]=[]),e[n].push(t),i=Math.max(i,n),e}.bind(this),{}),0!==i))return t[i]},i.prototype.adaptToSpec=function(e){return 1!==e.length?(console.error("JBFormRelationController: the relation to entity %o using accessor (relation) %o does not seem to be unique and has multiple possible relations %o",this.entityName,this.relationName,e),!1):n.prototype.adaptToSpec.call(this,e[0])},i.prototype.isRequired=function(e){return!1},o.controller("JBFormReferenceController",["$scope","$attrs","$compile","$templateCache","JBFormComponentsService","RelationInputService","APIWrapperService",n]),o.controller("JBFormRelationController",["$scope","$attrs","$compile","$templateCache","JBFormComponentsService","RelationInputService","APIWrapperService",i]),
o.run(["$templateCache",function(e){e.put("referenceComponentTemplate.html",'<div class="form-group"><label jb-form-label-component label-identifier="{{$ctrl.getLabel()}}" is-required="$ctrl.isRequired()" is-valid="$ctrl.isValid()" ng-if="$ctrl.displayLabel()"></label><div class="relation-select" relation-input ng-class="{ \'col-md-9\' : $ctrl.displayLabel() , \'col-md-12\' : !$ctrl.displayLabel() }" ng-model="$ctrl.currentData" relation-entity-endpoint="{{$ctrl.getEntityUrl()}}" relation-suggestion-template="{{$ctrl.suggestion}}" relation-search-field="{{$ctrl.searchField}}" relation-disable-remove-button="$ctrl.disableRemoveButton" relation-disable-new-button="$ctrl.disableNewButton" relation-disable-edit-button="$ctrl.disableEditButton" relation-is-deletable="$ctrl.isDeletable()" relation-is-creatable="$ctrl.isCreatable()" relation-enable-fulltext-search="$ctrl.enableFulltext" relation-result-count="$ctrl.resultCount " relation-is-readonly="$ctrl.isReadonly" relation-is-multi-select="$ctrl.isMultiSelect" relation-filter="$ctrl.filters" relation-is-interactive="$ctrl.isInteractive"> </div></div>')}])}(),function(e){"use strict";function t(t,n,i,o,r){this.componentsService=t,this.componentsRegistry=null,this.$compile=n,this.$scope=i,this.type="JBFormRepeating",this.optionData=null,this.$timeout=o,this.$q=r,this.entities=[e]}var n=angular.module("jb.formComponents");t.prototype.preLink=function(e){this.componentsRegistry=this.componentsService.registryFor(e),this.componentsRegistry.listen(),e.$on("removeElement",function(e,t){e.stopPropagation(),this.isReadonly!==!0&&this.removeElement(t)}.bind(this))},t.prototype.postLink=function(e){this.componentsService.registerComponent(e,this)},t.prototype.getSelectFields=function(){return this.componentsRegistry.getSelectFields()},t.prototype.getSaveCalls=function(){return this.isReadonly===!0?[]:this.componentsRegistry.getSaveCalls()},t.prototype.afterSaveTasks=function(e){if(this.isReadonly!==!0)return this.componentsRegistry.afterSaveTasks(e)},t.prototype.beforeSaveTasks=function(e){if(this.isReadonly!==!0)return this.componentsRegistry.beforeSaveTasks(e)},t.prototype.isValid=function(){return this.isReadonly===!0||this.componentsRegistry.isValid()},t.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},t.prototype.handleOptionsData=function(e){return this.optionData=e,this.$timeout(function(){return this.componentsRegistry.optionsDataHandler(e)}.bind(this))},t.prototype.handleGetData=function(e){return this.$timeout(function(){e&&e[this.entityName]?this.entities=e[this.entityName]:this.entities=[],this.data=e}.bind(this)).then(function(){this.distributeOptionsAndData(this.optionData,e,0)}.bind(this))},t.prototype.addElement=function(e){if(!this.isReadonly){this.entities.push({isDummy:!0}),console.log("JBFormRepeatingViewController: Added element, entities are %o",this.entities);var t={};return t[this.entityName]=this.entities,this.distributeOptionsAndData(this.optionData,t,this.entities.length-1)}},t.prototype.distributeOptionsAndData=function(e,t,n){return this.$timeout(function(){this.componentsRegistry.optionsDataHandler(e).then(function(e){return this.componentsRegistry.distributeIndexedFrom(t,n)}.bind(this),function(e){console.error(e)})}.bind(this))},t.prototype.removeElement=function(e){if(!this.isReadonly){var t=(this.componentsRegistry.componentAt(e),this.$q.when()),n=this;return t.then(function(t){n.entities.splice(e,1)}).then(function(e){return n.$timeout(function(){return n.componentsRegistry.optionsDataHandler(n.optionData)})}.bind(this)).catch(function(e){console.error(e)})}},n.controller("JBFormRepeatingViewController",["JBFormComponentsService","$compile","$scope","$timeout","$q",t]),n.directive("jbFormRepeatingView",["$compile","$parse",function(e,t){return{scope:!0,bindToController:!0,controllerAs:"$ctrl",controller:"JBFormRepeatingViewController",link:{pre:function(e,t,n,i){i.preLink(e)},post:function(e,n,i,o){var r,a=i.hasOwnProperty("isReadonly");a&&(r=t(i.isReadonly),e.$watch(function(){return r(e.$parent)},function(e){o.isReadonly=e===!0})),i.$observe("entityName",function(e){o.entityName=e}),i.$observe("buttonText",function(t){o.buttonText=t,e.buttonText=t}),o.postLink(e),e.addElement=function(e,t){return console.log("jbFormRepeatingView: Add element"),e&&e.preventDefault(),o.addElement(t)},e.removeElement=function(e,t){return e&&e.preventDefault(),o.removeElement(t)}}}}}])}(),function(e){"use strict";function t(e,t){var n=e.primaryKeys,i=n[0];if(1!==n.length)throw Error("The entity used in a form view needs to have a single field primary key");return t[i]}function n(e,t,n,i){this.formView=e,this.optionsData=null,this.initialId=null,this.parentOptionsData=null,this.isDeleted=!1,this.$q=t,this.parentId=null,this.setupListeners(i)}function i(e,t,n,i){this.formView=e,this.optionsData=null,this.initialParentId=null,this.parentId=null,this.parentOptionsData=null,this.itemIndex=0,this.isDeleted=!1,this.$q=t,this.api=n,this.hadData=!1,this.initialize(e),this.setupListeners(i)}function o(e,t,n,i){this.formView=e,this.optionsData=null,this.initialParentId=null,this.parentId=null,this.parentOptionsData=null,this.rootEntity=null,this.itemIndex=0,this.$q=t,this.api=n,this.hadData=!1,this.setupListeners(i)}function r(e,t,n,i){this.optionsData=null,this.$q=e,this.formView=t,this.strategy=null,this.api=n,this.scope=i}var a=angular.module("jb.formComponents");n.prototype.setupListeners=function(e){e.$on("removedDetailView",function(e){e.stopPropagation()})},n.prototype.handleOptionsData=function(e){return this.parentOptionsData=e,this.optionsData=this.formView.getSpecFromOptionsData(e),this.formView.getOptionsData()},n.prototype.beforeSaveTasks=function(){return this.formView.makeSaveRequest()},n.prototype.afterSaveTasks=function(e){return e},n.prototype.getReferencingFieldName=function(){return this.optionsData.property},n.prototype.handleGetData=function(e){var n,i;return e&&(n=e[this.getReferencingFieldName()],i=e[this.formView.getEntityName()],this.parentId=t(this.parentOptionsData,e)),this.initialId=n,this.formView.setEntityId(n),this.formView.distributeData(i)},n.prototype.getSelectFields=function(){var e=this.formView.getSelectParameters().map(function(e){return[this.formView.getEntityName(),e].join(".")}.bind(this));return[this.getReferencingFieldName()].concat(e)},n.prototype.isValid=function(){return this.formView.isValid()},n.prototype.getSaveCalls=function(){var e=this.formView.generateSaveCalls(),t={};return this.initialId==this.formView.getEntityId()?e:(t.data={},t.data[this.getReferencingFieldName()]=this.formView.getEntityId(),[t].concat(e))},n.prototype.deleteRelation=function(){if(!this.formView.isNew()&&this.parentId){var e=[this.optionsData.name,this.formView.getEntityId(),this.parentOptionsData.resource,this.initialParentId].join("/");return this.api.delete(e)}},i.prototype.setupListeners=function(e){e.$on("deletedDetailView",function(e){var t=e.currentScope;e.stopPropagation(),t.$parent.$emit("removeElement",this.itemIndex)}.bind(this))},i.prototype.initialize=function(e){var t=this;e.registerComponent({registerAt:function(e){},unregisterAt:function(e){},isValid:function(){},getSaveCalls:function(){var e={data:{}};return t.initialParentId==t.parentId&&angular.isDefined(t.formView.getEntityId())?[]:(e.data[t.getReferencingFieldName()]=t.parentId,[e])}})},i.prototype.handleOptionsData=function(e){return this.optionsData=this.formView.getSpecFromOptionsData(e),this.parentOptionsData=e,this.formView.getOptionsData()},i.prototype.afterSaveTasks=function(e){return this.parentId=e,this.formView.makeSaveRequest().then(function(){return e})},i.prototype.beforeSaveTasks=function(){},i.prototype.getReferencingFieldName=function(){return this.optionsData.remote.property},i.prototype.handleGetData=function(e,n){var i,o,r=e?e[this.formView.getEntityName()]:e;return angular.isDefined(n)&&(this.itemIndex=n),r&&(r.length&&(r=this.getEntityFromData(r)),this.hadData=r.isDummy!==!0,o=t(this.parentOptionsData,e),i=this.formView.getOwnId(r)),this.initialParentId=o,this.formView.setEntityId(i),this.formView.distributeData(r)},i.prototype.getEntityFromData=function(e){return e[this.itemIndex]},i.prototype.getSelectFields=function(){var e=this.formView.getSelectParameters().map(function(e){return[this.formView.getEntityName(),e].join(".")}.bind(this));return e},i.prototype.isValid=function(){return this.formView.isValid()},i.prototype.getSaveCalls=function(){return[]},i.prototype.getEndpoint=function(e){return[this.optionsData.name,this.formView.getEntityId(),this.parentOptionsData.resource,e].join("/")},o.prototype.setupListeners=function(e){e.$on("deletedDetailView",function(e){var t=e.currentScope;e.stopPropagation(),this.deleteRelation().then(function(){t.$parent.$emit("removeElement",this.itemIndex)}.bind(this),function(e){console.error(e)})}.bind(this))},o.prototype.handleOptionsData=function(e){return this.optionsData=this.formView.getSpecFromOptionsData(e),this.parentOptionsData=e,this.rootEntity=e.resource,this.formView.getOptionsData()},o.prototype.handleGetData=function(e,n){var i,o,r=e?e[this.formView.getEntityName()]:e;return angular.isDefined(n)&&(this.itemIndex=n),r&&(r.length&&(r=this.getEntityFromData(r)),this.hadData=r.isDummy!==!0,o=t(this.parentOptionsData,e),i=this.formView.getOwnId(r)),this.initialParentId=o,this.formView.setEntityId(i),this.formView.distributeData(r)},o.prototype.getEntityFromData=function(e){return e[this.itemIndex]},o.prototype.isValid=function(){return this.formView.isValid()},o.prototype.getSelectFields=function(){return this.formView.getSelectParameters().map(function(e){return[this.optionsData.name,e].join(".")}.bind(this))},o.prototype.afterSaveTasks=function(e){return this.parentId=e,this.formView.makeSaveRequest().then(function(){return this.createRelation(e)}.bind(this)).then(function(){return e})},o.prototype.createRelation=function(e){return this.hadData?this.$q.when():this.api.post(this.getEndpoint(e))},o.prototype.getEndpoint=function(e){return[this.optionsData.name,this.formView.getEntityId(),this.parentOptionsData.resource,e].join("/")},o.prototype.beforeSaveTasks=function(){},o.prototype.getSaveCalls=function(){return[]},o.prototype.deleteRelation=function(){return this.initialParentId&&!this.formView.isNew()&&this.hadData?this.api.delete(this.getEndpoint(this.initialParentId)):this.$q.when()},r.prototype.getSaveCalls=function(){return this.strategy.getSaveCalls()},r.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},r.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.handleGetData)},r.prototype.handleOptionsData=function(e){var t=this.formView.getSpecFromOptionsData(e);return t?(this.strategy=this.createViewAdapterStrategy(t),this.strategy.handleOptionsData(e)):console.error("No options data found for form-view %o in %o",this.formView.entityName,this.formView)},r.prototype.createViewAdapterStrategy=function(e){switch(e.type){case"hasManyAndBelongsToMany":return new o(this.formView,this.$q,this.api,this.scope);case"hasMany":return new i(this.formView,this.$q,this.api,this.scope);case"hasOne":default:return new n(this.formView,this.$q,this.api,this.scope)}},r.prototype.handleGetData=function(e,t){return this.strategy.handleGetData(e,t)},r.prototype.beforeSaveTasks=function(){return this.strategy.beforeSaveTasks()},r.prototype.afterSaveTasks=function(e){return this.strategy?this.strategy.afterSaveTasks(e):[]},r.prototype.getSelectFields=function(){return this.strategy?this.strategy.getSelectFields():[]},r.prototype.isValid=function(){return this.formView.isReadonly||this.strategy&&this.strategy.isValid()},a.factory("JBFormViewAdapterService",["$q","APIWrapperService",function(e,t){return{getAdapter:function(n,i){return new r(e,n,t,i)}}}])}(),angular.module("jb.formComponents").controller("JBFormViewLoaderController",["$scope","$location","$http","$q","$compile",function(e,t,n,i,o){var r=this,a=t.path(),s=a.split("/");if(!s.length)return void alert("no path provided");var l=s[1],c=s[2];console.log("DetailViewLoader: entity name is %o, id %o",l,c),r.getControllerAndTemplate=function(e,t){if(!e)return!1;var n,i,o=e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),r="src/app/"+o+"/";return t?"new"!==t&&isNaN(parseInt(t,10))?console.error("unknown entity id: %o",t):n=r+o+"-detail.tpl.html":(i="backoffice"+e.substring(0,1).toUpperCase()+e.substring(1)+"ListController",n=r+o+"-list.tpl.html"),{controllerName:i,templateUrl:n}},r.getTemplate=function(e){return n({method:"GET",url:e,headers:{accept:"text/html"}}).then(function(e){return console.log("DetailViewLoader: got template %o",e),e.data},function(e){return i.reject(e)})},r.renderTemplate=function(t,n){var i=$("[ng-view], [data-ng-view]"),r=$("<div></div>");n&&r.attr("data-ng-controller",n),r.html(t),console.log("DetailViewLoader: render Template %o with controller %o",r,n),i.empty().append(r),o(r)(e)},r.init=function(){var e=r.getControllerAndTemplate(l,c);if(!e)return void r.renderTemplate("404 – Page could not be found",!1);var t=e.templateUrl,n=e.controllerName;r.getTemplate(t).then(function(e){r.renderTemplate(e,n)},function(e){var n=$("[ng-view], [data-ng-view]");n.text("Template "+t+" not found. Entity can't be edited")})},r.init()}]),function(e){"use strict";var t=angular.module("jb.formComponents");t.directive("jbFormView",["$compile",function(e){return{link:{pre:function(e,t,n,i){angular.isFunction(i.preLink)&&i.preLink(e,t,n)},post:function(e,t,n,i,o){angular.element('<h1 ng-if="$ctrl.error">{{$ctrl.error}}</h1>');t.addClass("jb-form-view"),i.init(e,t,n)}},controller:"DetailViewController",bindToController:!0,controllerAs:"$ctrl",scope:!0}}]),t.controller("DetailViewController",["$scope","$rootScope","$q","$attrs","$filter","$state","APIWrapperService","JBFormComponentsService","BackofficeAPIWrapperService","JBFormViewAdapterService","$parse",function(t,n,i,o,r,a,s,l,c,d,p){var u=this;u.componentsService=l,u.componentsRegistry=null,u.adapterService=d,u.index=0,u.initialized=!1,u.optionData=null,t.$watchGroup(["$ctrl.entityName","$ctrl.entityId"],function(){u.setTitle()}),u.preLink=function(e,t,n){u.componentsRegistry=u.componentsService.registryFor(e),u.componentsRegistry.listen()},u.parseUrl=function(){return{name:a.params.entityName,id:!(!a.params.entityId||"new"===a.params.entityId)&&a.params.entityId,isNew:"new"===a.params.entityId}},u.getEntityId=function(){return t.entityId},u.getEntityName=function(){return t.entityName},u.getEntityUrl=function(){var e=u.serviceName?"/"+u.serviceName+".":"/";return e+=u.getEntityName(),u.getEntityId()&&(e+="/"+u.getEntityId()),e},u.setTitle=function(){var e=u.getEntityName(),n=r("translate")("web.backoffice.create");u.isNew()||(n=r("translate")("web.backoffice.edit"),e=e+" #"+u.entityId),t.title=[n,e].join(": ")},u.init=function(n,o,r){var a,s=[],l=o;if(u.setEntityId(e),u.isRoot=r.hasOwnProperty("isRoot"),u.restrictDelete=r.hasOwnProperty("restrictDelete"),u.hasEntityName=r.hasOwnProperty("entityName"),u.hasEntityId=r.hasOwnProperty("entityId"),u.hasReadonlyFlag=r.hasOwnProperty("isReadonly"),u.hasServiceName=r.hasOwnProperty("serviceName"),r.hasOwnProperty("nonInteractive")&&(u.isNonInteractive=!0),u.hasServiceName){var c=i.defer();s.push(c.promise),r.$observe("serviceName",function(e){e&&(u.serviceName=e,t.serviceName=e,c.resolve())})}if(u.hasEntityName){var d=i.defer();s.push(d.promise),r.$observe("entityName",function(e){e&&(u.setEntityName(e),d.resolve())})}if(u.hasEntityId){var h=i.defer();s.push(h.promise),r.$observe("entityId",function(t){console.log("jbFormView: Entity ID changed to %o",t),t&&(u.setEntityId("new"===t?e:t),u.initialized&&(console.log("jbFormView: Entity ID changed, controller was initialized"),u.getData()),h.resolve())})}if(!u.hasEntityName&&!u.hasEntityId){var m=u.parseUrl();u.setEntityName(m.name),u.setEntityId(m.id)}u.hasReadonlyFlag&&(a=p(r.isReadonly),n.$watch(function(){return a(n.$parent)},function(e){e!==!0&&e!==!1||(u.isReadonly=e,e===!0&&l.addClass("jb-form-readonly"))})),u.isRoot||(u.adapter=u.adapterService.getAdapter(this,n),u.componentsService.registerComponent(n,u.adapter)),i.all(s).then(function(){u.initialized=!0,u.isRoot&&u.getOptionData().then(u.checkAccessRights).then(u.getData).catch(function(e){console.error(e)})})},u.isNew=function(){return!this.getEntityId()&&0!==this.getEntityId()},u.checkAccessRights=function(e){return e},u.setEntityName=function(e){u.entityName=e,t.entityName=e},u.setEntityId=function(e){u.entityId=e,t.entityId=e},u.internallyHandleOptionsData=function(e){return u.optionData=e,(e.properties||[]).forEach(function(t){t.readonly=!(e.permissions.update!==!1&&!u.isReadonly)}),u.componentsRegistry.optionsDataHandler(e)},u.getOptionsData=function(){return u.getOptionData()},u.getSpecFromOptionsData=function(e){for(var t=e&&e.relations&&e.relations.length?e.relations:[],n=0;n<t.length;n++){var i=t[n];if(i.remote.resource===this.entityName)return i}},u.getOptionData=function(){console.log("DetailView: Make OPTIONS call for %o",u.getEntityName());var e=u.serviceName?"/"+u.serviceName+".":"/";return e+=u.getEntityName(),u.makeOptionRequest(e).then(u.internallyHandleOptionsData,function(e){n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.optionsLoadingError",variables:{errorMessage:e}})})},u.makeOptionRequest=function(e){return s.getOptions(e)},u.register=function(e){throw new Error("DEPRECATED")},u.registerComponent=function(e){this.componentsRegistry.registerComponent(e)},u.getSelectParameters=function(){return console.log("jbFormView: getSelectParameters for %o",u.componentsRegistry),[this.getOwnIdField()].concat(u.componentsRegistry.getSelectFields())},u.distributeData=function(e){console.log("jbFormView: Distribute data %o",e),e||(e={isDummy:!0}),u.componentsRegistry.getDataHandler(e)},u.getData=function(){return u.makeGetRequest().then(u.distributeData,function(e){u.error="Unable to load!!",n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})})},u.updateData=function(){return u.getData()},u.makeGetRequest=function(){var e=u.getEntityUrl(),t=u.getSelectParameters(),n=u.concatSelectParameters(t);return console.log("DetailView: Get Data from %o with select %o",e,t),u.isNew()?i.when():s.request({url:e,headers:{select:n},method:"GET"}).then(function(e){return e}.bind(this),function(e){return i.reject(e)})},u.concatSelectParameters=function(e){var t=(e||[]).reduce(function(e,t){return t&&(e[t]=!0),e},{});return Object.keys(t)},t.edit=function(){a.go("app.detail",{entityName:u.getEntityName(),entityId:u.isNew()?"new":u.getEntityId()})},t.save=function(e,t,o){if(e&&angular.isFunction(e.preventDefault)&&(e.preventDefault(),e.stopPropagation()),!u.isReadonly)return u.makeSaveRequest().then(function(e){return u.parseUrl().isNew&&!t&&a.go("app.detail",{entityName:u.getEntityName(),entityId:u.getEntityId()}),t?console.log("DetailViewController: Don't show any message or redirect"):(console.log("DetailViewController: Show success message on %o",n),n.$broadcast("notification",{type:"success",message:"web.backoffice.detail.saveSuccess"})),u.updateData(),o&&o(),e||null}).catch(function(e){return n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.saveError",variables:{errorMessage:e.message}}),i.reject(e)})},u.isValid=function(){return u.componentsRegistry&&u.componentsRegistry.isValid()},u.makeSaveRequest=function(e){return u.isValid()?u.isReadonly&&e!==!0?i.when(u.getEntityId()):u.executePreSaveTasks().then(function(e){return u.makeMainSaveCall()}).then(function(e){return u.executePostSaveTasks(e)}):i.reject(new Error("Not all required fields filled out."))},u.executePreSaveTasks=function(){var e={};return e.meta={},u.componentsRegistry.getBeforeSaveTasks(e)},u.beforeSaveTasks=function(e){var t=u.makeSaveRequest();return t},u.executePostSaveTasks=function(e){return u.componentsRegistry.getAfterSaveTasks(e)},u.getIdFieldFrom=function(e){return e&&e.primaryKeys?e.primaryKeys[0]:null},u.getOwnIdField=function(){return this.getIdFieldFrom(this.optionData)},u.getOwnId=function(e){var t;return e?(t=this.getOwnIdField(),t?e[t]:null):null},u.makeMainSaveCall=function(){var e=u.generateSaveCalls();console.log("DetailView: Save calls for %o are %o",this.entityName,e);for(var t,n,o=[],r=0;r<e.length;r++){var a="/"+(u.serviceName?u.serviceName+".":"");a+=u.getEntityName(),angular.isObject(e[r].url)||e[r].url&&0!==e[r].url.indexOf(a)?o.push(e[r]):t=e[r]}t||u.getEntityId()||(t={method:"POST",url:(u.serviceName?"/"+u.serviceName+".":"/")+u.getEntityName()}),console.log("DetailView: Main save call is %o, other calls are %o",t,o);var s=null;return u.executeSaveRequest(t).then(function(e){n=e,console.log("DetailView: Made main save call; got back %o",n),s=u.getOwnId(n),s&&(console.log("DetailView: Entity id is %o",s),u.setEntityId(s));var t=[];return o.forEach(function(e){t.push(u.executeSaveRequest(e))}),i.all(t)}).then(function(){return u.getEntityId()})},u.addCall=function(e,t){e.url||(e.url=u.getEntityUrl()),e.method||(/\/\d*\/?$/.test(e.url)?e.method="PATCH":e.method="POST");var n=this.getSaveCall(t,e.method,e.url);if(e.hasOwnProperty("headers")&&(n=!1),n){if(e.data)for(var i in e.data)n.data[i]=e.data[i]}else n={method:e.method,url:e.url,data:e.data,headers:e.headers||{}},t.push(n)},u.getSaveCall=function(e,t,n){var i=!1;return e.some(function(e){var o=e.url===n||!e.url&&!n,r=e.method.toLowerCase()===t.toLowerCase();if("object"==typeof e.url&&"object"==typeof n&&(o=e.url.mainEntity.toLowerCase()===n.mainEntity.toLowerCase()&&e.url.path.toLowerCase()===n.path.toLowerCase()),r&&o)return i=e,!0}),i},u.executeSaveRequest=function(e){if(!e)return console.log("DetailView: No call to be made"),i.when(e);var t;if(angular.isObject(e.url)){if(!e.url.path)return console.error("DetailViewController: url property is missing on path on %o",e),i.reject("Got invalid call data, path property missing on url for "+JSON.stringify(e));var n=u.getEntityId()?u.getEntityName()+"/"+u.getEntityId():u.getEntityName(),o=e.url.path.replace(/^\/*/,"").replace(/\/*$/,"");t="prepend"===e.url.mainEntity?"/"+n+"/"+o:"append"===e.url.mainEntity?"/"+o+"/"+n:e.url.path}else e.url&&0===e.url.indexOf("/")?t=e.url:(t="/"+u.getEntityName(),u.getEntityId()&&(t+="/"+u.getEntityId()),e.url&&(t+="/"+e.url));return console.log("DetailView: Make %s call to %s with %o. Call is %o, entityName is %o.",e.method,t,e.data,e,u.getEntityName()),e.data||(e.data={}),s.request({url:t,data:e.data,method:e.method,headers:e.headers})},u.generateSaveCalls=function(){if(u.isReadonly)return[];var e=u.componentsRegistry.getSaveCalls().reduce(function(e,t){return u.addCall(t,e),e},[]);return e},u.unlink=function(){return t.$destroy()},t.$on("reloadViewData",function(e){u.isRoot&&(console.info("reloadView"),e&&e.stopPropagation&&e.stopPropagation(),u.getData())}),t.delete=function(e,n,o){e&&(e.preventDefault(),e.stopPropagation()),console.log("DetailView: Delete");var s=!1,l=!(angular.isDefined(u.isNonInteractive)?u.isNonInteractive:n),c=r("translate")("web.backoffice.detail.confirmDeletion");return u.restrictDelete&&!u.isRoot?t.$emit("deletedDetailView",u):(c+="\n"+u.getEntityName()+"("+u.getEntityId()+")",(s=confirm(c))?u.isNew()&&!u.isRoot?t.$emit("deletedDetailView",u):u.makeDeleteRequest().then(function(e){return u.isRoot||t.$emit("deletedDetailView",u),t.$emit("notification",{type:"success",message:"web.backoffice.detail.deleteSuccess"}),l?a.go("app.list",{entityName:u.getEntityName()}):void(o&&t.$emit("reloadViewData"))},function(e){return t.$emit("notification",{type:"error",message:"web.backoffice.detail.deleteError",variables:{errorMessage:e}}),i.reject(e)}):void 0)},u.makeDeleteRequest=function(){return u.isReadonly?i.when():(console.log("DetailView: Make DELETE request"),s.request({url:u.getEntityUrl(),method:"DELETE"}))}}])}(),function(){"use strict";function e(e,t,n,i,o){this.$scope=e,this.$attrs=t,this.$compile=n,this.fieldTypes=i,this.name=t.for,this.label=this.name,this.subcomponentsService=o,this.registry=null}var t="jb.formAutoInputTypes",n=angular.module("jb.formComponents");n.value(t,{text:"text",number:"text",integer:"text",decimal:"text",interval:"text",string:"text",boolean:"checkbox",datetime:"date-time",date:"date-time",time:"date-time"}),n.directive("jbFormAutoInput",["$compile","$parse",function(e,t){return{restrict:"E",link:{post:function(e,n,i,o){var r,a,s,l;o.hasModel=i.hasOwnProperty("inputModel"),o.hasModel&&(l=t(i.inputModel),e.$watch(function(){return l(e.$parent)},function(e){o.inputModel=e}),e.$watch(function(){return o.inputModel.value})),o.hasLabel=i.hasOwnProperty("label"),o.hasLabel&&i.$observe("label",function(e){o.label=e}),i.$observe("for",function(e){o.name=e}),i.hasOwnProperty("showLabel")&&(a=t(i.showLabel),e.$watch(function(){return a(e.$parent)},function(e){o.showLabel=e})),i.hasOwnProperty("inputHidden")&&(s=t(i.inputHidden),e.$watch(function(){return s(e.$parent)},function(e){o.inputHidden=e})),i.hasOwnProperty("isReadonly")&&(r=t(i.isReadonly),e.$watch(function(){return r(e.$parent)},function(e){o.isReadonly=e})),o.init(e,n,i)},pre:function(e,t,n,i){i.preLink(e,t,n)}},controller:"JBFormAutoInputController",scope:!0}}]),e.prototype.preLink=function(e,t,n){this.registry=this.subcomponentsService.registryFor(e),this.registry.listen()},e.prototype.init=function(e,t,n){this.element=t,this.registry.registerOptionsDataHandler(this.updateElement.bind(this)),this.registry.registerYourself()},e.prototype.selectOptions=function(e){var t=e?e.properties:e;if(t&&t.length)for(var n=0;n<t.length;n++)if(t[n].name==this.name)return t[n]},e.prototype.updateElement=function(e){var t,n,i,o,r=this.selectOptions(e);return r&&r.type?(t=this.fieldTypes[r.type])?(console.log("AutoFormElement: Create new %s from %o",t,e),n=t.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),i="jb-form-"+n+"-input",o=angular.element("<div>"),o.attr(i,""),o.attr("for",this.$attrs.for),o.attr("is-readonly",this.$attrs.isReadonly),o.attr("ng-hide",this.$attrs.inputHidden),this.hasLabel&&o.attr("label",this.$attrs.label),this.hasModel&&o.attr("input-model",this.$attrs.inputModel),this.registry.unregisterOptionsDataHandler(this.updateElement),this.element.replaceWith(o),this.$compile(o)(this.$scope),this.registry.optionsDataHandler(e)):void console.error("AutoFormElement: Unknown type %o element %o",e,this.element):void console.error("AutoFormElement: fieldSpec %o has no type for field %o, elementSpec is %o",e,this.name,r)},n.controller("JBFormAutoInputController",["$scope","$attrs","$compile",t,"JBFormComponentsService",e])}(),function(e){"use strict";var t=function(e){this.subcomponentsService=e};t.prototype.updateData=function(e){this.setValue(e[this.name]),this.originalData=this.getValue()},t.prototype.setValue=function(e){this.hasModel||(this.model={}),this.model.value=e},t.prototype.getValue=function(){return(this.model||{}).value},t.prototype.getSelectFields=function(){return[this.name]},t.prototype.getSaveCalls=function(){if(this.originalData===this.getValue()||this.isReadonly)return[];var e={};return e[this.name]=this.getValue()===!0,[{data:e}]},t.prototype.preLink=function(e,t,n){},t.prototype.isValid=function(){return!0},t.prototype.isRequired=function(){return!1},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterGetDataHandler(this.updateData)},t.prototype.init=function(e,t,n){this.subcomponentsService.registerComponent(e,this),angular.isUndefined(this.showLabel)&&(this.showLabel=!0)},t.prototype.displayLabel=function(){return this.hasLabel&&this.showLabel!==!1};var n=angular.module("jb.formComponents");n.directive("jbFormCheckboxInput",[function(){return{scope:{name:"@for",isReadonly:"<?",label:"@?",showLabel:"<?",model:"=?inputModel"},controller:"JBFormCheckboxInputController",bindToController:!0,controllerAs:"$ctrl",link:{pre:function(e,t,n,i){i.preLink(e,t,n,i)},post:function(e,t,n,i){i.hasLabel=n.hasOwnProperty("label"),i.hasModel=n.hasOwnProperty("inputModel"),i.init(e,t,n)}},template:'<div class="form-group"><label ng-if="$ctrl.displayLabel()" jb-form-label-component label-identifier="{{$ctrl.label}}" is-valid="$ctrl.isValid()" is-required="$ctr.isRequired()"></label><div ng-class="{ \'col-md-9\' : $ctrl.displayLabel(), \'col-md-12\' : !$ctrl.displayLabel() }"><div class="checkbox"><input type="checkbox" data-ng-model="$ctrl.model.value"/></div></div></div>'}}]),n.controller("JBFormCheckboxInputController",["JBFormComponentsService",t])}(),function(e){"use strict";function t(e){return e<10?"0"+e:e}function n(t){this.subcomponentsService=t,this.originalData=e,this.required=!0,this.spec=null}n.prototype.getSelectFields=function(){return[this.name]},n.prototype.isRequired=function(){return this.required===!0},n.prototype.isValid=function(){var e=this.getValue();return!(this.isRequired()&&!this.isReadonly)||!!e&&!isNaN(e.getTime())},n.prototype.setValue=function(e){this.model||(this.model={}),this.model.value=e},n.prototype.getValue=function(){return(this.model||{}).value},n.prototype.updateData=function(e){var t=this.normalizeValue(e[this.name]);this.setValue(t),this.originalData=this.getValue()},n.prototype.normalizeValue=function(e){if(!e)return e;if(this.isTimeOnly()){var t=e.split(":"),n=new Date;return n.setMilliseconds(0),n.setSeconds(0),n.setHours(t[0]),n.setMinutes(t[1]),n}return new Date(e)},n.prototype.isTimeOnly=function(){return this.spec&&"time"===this.spec.type},n.prototype.getSaveCalls=function(){var e=this.getValue(),n=this.originalData,i={data:{}},o="",r="";return e||n?e&&n&&e.getTime()==n.getTime()?[]:(e&&(this.isTimeOnly()||(o=[e.getFullYear(),t(e.getMonth()+1),t(e.getDate())].join("-")),r=[t(e.getHours()),t(e.getMinutes()),t(e.getSeconds())].join(":")),i.data[this.name]=o+" "+r,[i]):[]},n.prototype.init=function(e){this.subcomponentsService.registerComponent(e,this)},n.prototype.displayLabel=function(){return this.hasLabel&&this.showLabel!==!1},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.updateData.bind(this))},n.prototype.unregisterAt=function(e){e.unregisterOptionsDataHandler(this.handleOptionsData),e.unregisterGetDataHandler(this.updateData)},n.prototype.selectSpec=function(e){var t=e&&e.properties?e.properties:[];if(t.length)for(var n=0;n<t.length;n++){var i=t[n];if(i.name===this.name)return i}},n.prototype.handleOptionsData=function(e){var t=this.selectSpec(e);return t?(this.spec=t,this.required=t.nullable===!1,this.isReadonly=this.isReadonly===!0||t.readonly===!0,this.showDate="time"!==t.type,void(this.showTime="datetime"===t.type||"time"===t.type)):console.error("JBFormDateTimeInputController: No field spec for %o",this.name)};var i=angular.module("jb.formComponents");i.directive("jbFormDateTimeInput",[function(){return{scope:{name:"@for",label:"@?",showLabel:"<?",isReadonly:"<?",isUtc:"=",model:"=?inputModel"},controller:"JBFormDateTimeInputController",bindToController:!0,controllerAs:"$ctrl",link:function(e,t,n,i){i.hasLabel=n.hasOwnProperty("label"),i.hasModel=n.hasOwnProperty("inputModel"),i.init(e,t,n)},template:'<div class="form-group form-group-sm jb-form-date-time-input" ng-class="{\'invalid\' : !$ctrl.isValid()}"><label ng-if="$ctrl.displayLabel()" jb-form-label-component label-identifier="{{$ctrl.label}}" is-required="$ctrl.isRequired()" is-valid="$ctrl.isValid()"></label><div ng-class="{\'col-md-9\' : $ctrl.displayLabel(), \'col-md-12\': !ctrl.displayLabel() }"><div class="row"><div ng-if="$ctrl.showDate" ng-class="{ \'col-md-6\': $ctrl.showTime, \'col-md-12\': !$ctrl.showTime }"><input type="date" class="form-control input-sm input-date" data-ng-model="$ctrl.model.value" ng-disabled="$ctrl.isReadonly"></div><div ng-if="$ctrl.showTime" ng-class="{ \'col-md-6\': $ctrl.showDate, \'col-md-12\': !$ctrl.showDate }"><input type="time" class="form-control input-sm input-time" data-ng-model="$ctrl.model.value" ng-disabled="$ctrl.isReadonly"/></div></div></div></div>'
}}]),i.controller("JBFormDateTimeInputController",["JBFormComponentsService",n])}(),function(e){"use strict";angular.module("jb.backofficeHiddenInput",[]).directive("hiddenInput",[function(){return{controller:"HiddenInputController",link:function(e,t,n,i){i.init(e,t,n,i)},scope:!0}}]).controller("HiddenInputController",["$scope","$attrs","JBFormComponentsService",function(e,t,n){var i,o=this;o.init=function(e,t,r){i=t,n.registerComponent(e,o)},o.isValid=function(){return!0},o.registerAt=function(e){},console.log("HiddenInput: for is %o, read %o (hasProperty %o) evals to %o",t.for,t.read,t.hasOwnProperty("read"),e.$parent.$eval(t.read)),o.getSelectFields=function(){return!t.hasOwnProperty("read")||e.$parent.$eval(t.read)?[t.for]:[]},o.getSaveCalls=function(){var n=!t.hasOwnProperty("write")||e.$parent.$eval(t.write);if(console.log("HiddenInput: Get save calls; $attrs.data is %o, writeData is %o, data-write is %o and evals to %o",t.data,n,t.write,e.$parent.$eval(t.write)),n&&t.data){var i=t.for&&t.for.indexOf(".")>-1;if(i){var o=t.for.substring(0,t.for.lastIndexOf(".")),r=o+"/"+t.data;return console.log("HiddenInput: Store relation %o",r),{url:r,method:"POST"}}var a={};return a[t.for]=t.data,console.log("HiddenInput: Store data %o",a),{data:a}}return[]}}])}(),function(e){"use strict";var t=function(t,n,i,o){this.$scope=t,this.$attrs=n,this.$q=i,this.componentsService=o,this.originalData=e,this.required=!0};t.prototype.isRequired=function(){return this.required===!0},t.prototype.isValid=function(){return!(this.isRequired()&&!this.isReadonly)||!!this.getValue()},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this)),e.registerOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterGetDataHandler(this.updateData.bind(this)),e.unregisterOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.selectOptions=function(e){var t=e?e.properties:e;if(t&&t.length)return t.filter(function(e){return e.name===this.name}.bind(this))[0]},t.prototype.handleOptionsData=function(e){var t=this.selectOptions(e);return angular.isDefined(t)?(this.options=t,this.required=t.nullable===!1,void(this.isReadonly=this.isReadonly===!0||t.readonly===!0)):console.error("No options data available for interval field %o",this.name)},t.prototype.getValue=function(){return(this.model||{}).value},t.prototype.setValue=function(e){this.model||(this.model={}),this.model.value=e},t.prototype.init=function(e,t,n){this.componentsService.registerComponent(e,this),angular.isUndefined(this.showLabel)&&(this.showLabel=!0)},t.prototype.preLink=function(e){},t.prototype.getSelectFields=function(){return[this.name]},t.prototype.updateData=function(e){this.originalData=this.getValue();var t=e[this.name];if(!t)return void this.setValue("");var n=Object.keys(t).reduce(function(e,n){return e+t[n]+" "+n+" "},"").trim();this.setValue(n)},t.prototype.displayLabel=function(){return this.hasLabel&&this.showLabel!==!1},t.prototype.getSaveCalls=function(){if(this.originalData===e&&!this.getValue())return[];if(this.originalData===this.getValue()||this.isReadonly)return[];var t={};return t[this.name]=this.getValue(),[{data:t}]};var n=angular.module("jb.formComponents");n.controller("JBFormIntervalInputController",["$scope","$attrs","$q","JBFormComponentsService",t]),n.directive("jbFormIntervalInput",[function(){return{scope:{name:"@for",label:"@?",isReadonly:"<?",showLabel:"<?",model:"=?inputModel"},controllerAs:"$ctrl",bindToController:!0,link:{post:function(e,t,n,i){i.model={},i.hasInputModel=n.hasOwnProperty("inputModel"),i.hasLabel=n.hasOwnProperty("label"),i.init(e,t,n)},pre:function(e,t,n,i){i.preLink(e,t,n)}},controller:"JBFormIntervalInputController",template:'<div class="form-group form-group-sm"> <label ng-if="$ctrl.displayLabel()" jb-form-label-component label-identifier="{{$ctrl.label}}" is-valid="$ctrl.isValid()" is-required="$ctrl.isRequired()"></label> <div ng-class="{ \'col-md-9\' : $ctrl.displayLabel(), \'col-md-12\' : !$ctrl.displayLabel() }" > <input type="text" ng-attr-id="$ctrl.name" ng-attrs-required="$ctrl.isRequired()" ng-model="$ctrl.model.value" ng-disabled="$ctrl.isReadonly" class="form-control input-sm" /></div> </div> '}}])}(),function(e){"use strict";var t=function(t,n,i,o){this.$scope=t,this.$attrs=n,this.$q=i,this.componentsService=o,this.originalData=e,this.required=!0,this.options};t.prototype.isRequired=function(){return this.required===!0},t.prototype.isValid=function(){return!(this.isRequired()&&!this.isReadonly)||!!this.getValue()},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this)),e.registerOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.unregisterAt=function(e){e.unregisterGetDataHandler(this.updateData.bind(this)),e.unregisterOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.selectOptions=function(e){var t=e?e.properties:e;if(t&&t.length)for(var n=0;n<t.length;n++)if(t[n].name==this.name)return t[n]},t.prototype.handleOptionsData=function(e){var t=this.selectOptions(e);return angular.isDefined(t)?(this.options=t,this.required=t.nullable===!1,void(this.isReadonly=this.isReadonly===!0||t.readonly===!0)):console.error("No options data available for text-field %o",this.name)},t.prototype.getValue=function(){return(this.model||{}).value},t.prototype.setValue=function(e){this.model||(this.model={}),this.model.value=e},t.prototype.init=function(e,t,n){this.componentsService.registerComponent(e,this),angular.isUndefined(this.showLabel)&&(this.showLabel=!0)},t.prototype.preLink=function(e){},t.prototype.getSelectFields=function(){return[this.name]},t.prototype.updateData=function(e){this.originalData=this.getValue(),this.setValue(e?e[this.name]:e)},t.prototype.displayLabel=function(){return this.hasLabel&&this.showLabel!==!1},t.prototype.getSaveCalls=function(){if(this.originalData===this.getValue()||this.isReadonly)return[];var e={};return e[this.name]=this.getValue(),[{data:e}]};var n=angular.module("jb.formComponents");n.controller("JBFormTextInputController",["$scope","$attrs","$q","JBFormComponentsService",t]),n.directive("jbFormTextInput",[function(){return{scope:{name:"@for",label:"@?",isReadonly:"<?",showLabel:"<?",model:"=?inputModel"},controllerAs:"$ctrl",bindToController:!0,link:{post:function(e,t,n,i){i.model={},i.hasInputModel=n.hasOwnProperty("inputModel"),i.hasLabel=n.hasOwnProperty("label"),i.init(e,t,n)},pre:function(e,t,n,i){i.preLink(e,t,n)}},controller:"JBFormTextInputController",template:'<div class="form-group form-group-sm"> <label ng-if="$ctrl.displayLabel()" jb-form-label-component label-identifier="{{$ctrl.label}}" is-valid="$ctrl.isValid()" is-required="$ctrl.isRequired()"></label> <div ng-class="{ \'col-md-9\' : $ctrl.displayLabel(), \'col-md-12\' : !$ctrl.displayLabel() }" > <input type="text" ng-attr-id="$ctrl.name" ng-attrs-required="$ctrl.isRequired()" ng-model="$ctrl.model.value" ng-disabled="$ctrl.isReadonly" class="form-control input-sm" /></div> </div> '}}])}(),angular.module("jb.fileDropComponent",[]).directive("fileDropComponent",[function(){return{require:["fileDropComponent"],controller:"FileDropComponentController",controllerAs:"fileDropComponent",bindToController:!0,link:function(e,t,n,i){i[0].init(t)},scope:{supportedFileTypes:"=",files:"=model",errorHandler:"&",maxFileCount:"@"}}}]).controller("FileDropComponentController",["$scope",function(e){function t(e){p.errorHandler&&angular.isFunction(p.errorHandler)&&p.errorHandler({error:e})}function n(){d.bind("drop",o).bind("dragover",i).bind("dragenter",i).bind("dragleave",r)}function i(e){return e.preventDefault(),e.originalEvent.dataTransfer.effectAllowed="copy",!1}function o(e){e.preventDefault();var t=e.originalEvent.dataTransfer.files;return s(t),!1}function r(e){}function a(){d.find("input[type='file']").change(function(e){return e.target.files&&e.target.files.length?void s(e.target.files):void console.log("BackofficeImageComponentController: files field on ev.target missing: %o",e.target)})}function s(e){for(var n=[],i=0;i<e.length;i++){var o=e[i];l(o)?c(o):n.push(o.name)}n.length&&(console.warn("FileDropComponentController: Invalid file ",JSON.stringify(n)),t(new Error("Tried to upload files with invalid file type: "+n.join(", ")+". Allowed are "+p.supportedFileTypes.join(", "))+"."))}function l(e){return!p.supportedFileTypes||!angular.isArray(p.supportedFileTypes)||p.supportedFileTypes.indexOf(e.type)>-1}function c(t){var n=new FileReader;n.onload=function(i){var o={file:t,fileSize:t.size,mimeType:t.type,height:void 0,width:void 0,fileData:i.target.result};try{var r=new Image;r.src=n.result,r.onload=function(){var t=this;e.$apply(function(){o.width=t.width,o.height=t.height})}}catch(e){console.error("FileDropComponentController: Error reading file: %o",e)}e.$apply(function(){p.files.push(o)})},n.readAsDataURL(t)}var d,p=this;p.files=[],p.state="undefined",p.init=function(e,t){d=e,n(),a()}}]),function(){"use strict";angular.module("jb.formComponents").directive("jbFormDataComponent",[function(){return{require:["backofficeDataComponent","^detailView"],controller:"JBFormDataComponentController",controllerAs:"backofficeDataComponent",bindToController:!0,templateUrl:"backofficeDataComponentTemplate.html",link:function(e,t,n,i){i[0].init(t,i[1])},scope:{propertyName:"@for",fields:"="}}}]).controller("JBFormDataComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,i){var o,r,a=this,s={};a.init=function(e,t){o=e,r=t,r.registerOptionsDataHandler(a.updateOptionsData),r.registerGetDataHandler(a.updateData)},a.checkFields=function(){if(!angular.isArray(a.fields))throw new Error("JBFormDataComponentController: fields passed is not an array: "+JSON.stringify(a.fields));return a.fields.forEach(function(e){if(!angular.isObject(e))throw new Error("JBFormDataComponentController: field passed is not an object: "+JSON.stringify(e));if(!e.name)throw new Error("JBFormDataComponentController: field is missing name property: "+JSON.stringify(e))}),!0},a.updateData=function(e){if(a.checkFields()){if(e[a.propertyName])try{angular.isString(e[a.propertyName])?s=JSON.parse(e[a.propertyName]):angular.isObject(e[a.propertyName])?s=angular.copy(e[a.propertyName]):e[a.propertyName]||(s={})}catch(t){console.error("JBFormDataComponentController: Could not parse data "+e[a.propertyName])}a.fields.forEach(function(e){e.values.indexOf(void 0)===-1&&e.values.push(void 0),s[e.name]&&(e.selected=s[e.name])})}},a.updateOptionsData=function(e){return e[a.propertyName]?void r.register(a):void console.error("JBFormDataComponentController: Missing OPTIONS data for %o in %o",a.propertyName,e)},a.getSelectFields=function(){return[a.propertyName]},a.getSaveCalls=function(){var e=!1;if(a.fields.forEach(function(t){s[t.name]!==t.selected&&(e=!0)}),!e)return console.log("JBFormDataComponentController: No changes made."),!1;var t=s?angular.copy(s):{};return a.fields.forEach(function(e){void 0===e.selected&&t[e.name]?delete t[e.name]:void 0!==e.selected&&(t[e.name]=e.selected)}),console.log("JBFormDataComponentController: Store changes %o",t),{data:{data:JSON.stringify(t)}}}}]).run(["$templateCache",function(e){e.put("backofficeDataComponentTemplate.html","<div class='form-group form-group-sm' data-ng-repeat=\"field in backofficeDataComponent.fields\"><label data-backoffice-label data-label-identifier='{{field.name}}' data-is-required='false' data-is-valid='true'></label><div class='col-md-8'><select class='form-control' data-ng-options='value for value in field.values' data-ng-model='field.selected'></select></div><div class='col-md-1'></div></div>")}])}(),function(){"use strict";angular.module("jb.formComponents").directive("jbFormMediaGroupComponent",[function(){return{controller:"JBFormMediaGroupComponentController",controllerAs:"backofficeMediaGroupComponent",bindToController:!0,templateUrl:"backofficeMediaGroupComponentTemplate.html",link:function(e,t,n,i){i.init(t)},scope:{propertyName:"@for",serviceName:"@"}}}]).controller("JBFormMediaGroupComponentController",["$scope","$rootScope","$q","APIWrapperService","JBFormComponentsService",function(e,t,n,i,o){function r(e,t){var n=e.group_medium[0].sortOrder,i=t.group_medium[0].sortOrder;return n<i?-1:1}function a(){var e=-1;return l.media.forEach(function(t){t.group_medium&&t.group_medium.length&&(e=Math.max(e,t.group_medium[0].sortOrder))}),e}var s,l=this,c=o,d=[],p=["*","video.*","video.videoType.*","image.*","group_medium.*","group.*"];l.media=[],l.addMediumModel=[],l.init=function(t){s=t,c.registerComponent(e,this),l.setupAddMediumModelWatcher(),l.setupOrderChangeListener()},l.registerAt=function(e){e.registerOptionsDataHandler(l.updateOptionsData.bind(l)),e.registerGetDataHandler(l.updateData.bind(l))},l.updateData=function(e){if(e[l.propertyName]){var t=e[l.propertyName]||[];try{l.media=t.sort(r)}catch(e){console.error("JBFormMediaGroupComponentController: Properties group_medium, it's items or sortOrder missing"),l.media=t}d=angular.copy(l.media)}},l.setupOrderChangeListener=function(){s[0].addEventListener("orderChange",function(e){l.media.splice(e.detail.newOrder,0,l.media.splice(e.detail.oldOrder,1)[0])})},l.setupAddMediumModelWatcher=function(){e.$watch(function(){return l.addMediumModel},function(e){1===l.addMediumModel.length&&(l.addMedium(e[0].id),l.addMediumModel=[])},!0)},l.addMedium=function(e){return l.media.filter(function(t){return t.id===e}).length>0?void console.error("JBFormMediaGroupComponentController: Trying to add duplicate with id",e):void i.request({url:"/"+(l.serviceName?l.serviceName+".":"")+l.propertyName+"/"+e,method:"GET",headers:{select:"*,video.*,video.videoType.*,image.*,group.*,group_medium.*"}}).then(function(e){l.media.push(e)},function(n){console.error("JBFormMediaGroupComponentController: Could not get data for medium with id %o: %o",e,n),t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:n}})})},l.updateOptionsData=function(e){},l.getSelectFields=function(){return p.map(function(e){return(l.serviceName?l.serviceName+":":"")+l.propertyName+"."+e})},l.getSaveCalls=function(){console.log("JBFormMediaGroupComponentController: Original data was %o, is now %o",d,l.media);var e=d.map(function(e){return e.id}),t=l.media.map(function(e){return e.id}),n=[],i=[];t.forEach(function(t){e.indexOf(t)===-1&&n.push(t)}),e.forEach(function(e){t.indexOf(e)===-1&&i.push(e)});var o=[];return i.forEach(function(e){o.push({method:"DELETE",url:(l.serviceName?l.serviceName+".":"")+l.propertyName+"/"+e})}),n.forEach(function(e){o.push({method:"POST",url:(l.serviceName?l.serviceName+".":"")+l.propertyName+"/"+e})}),o},l.afterSaveTasks=function(e){var t=a(),o=[];return l.media.forEach(function(r){console.log("JBFormMediaGroupComponentController: Create call for %o",r),o.push(n(function(n){var o={url:"/media.group/"+e+"/media.medium/"+r.id,method:"PATCH",data:{sortOrder:++t}};console.log("JBFormMediaGroupComponentController: Executing request %o",o),i.request(o).then(n)}))}),console.log("JBFormMediaGroupComponentController: after save tasks are %o, media are %o",o,l.media),n.all(o)},l.isValid=function(){return!0},l.isRequired=function(){return!1},l.removeMedium=function(e){l.media.splice(l.media.indexOf(e),1)}}]).run(["$templateCache",function(e){e.put("backofficeMediaGroupComponentTemplate.html","<div class='backoffice-media-group-component'><div class='row'><div class='col-md-12'><ol class='clearfix' data-drag-drop-list><li data-ng-repeat='medium in backofficeMediaGroupComponent.media' draggable='true'><div data-ng-if='medium.image'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='/b-{{medium.id_image}}/crop/auto/100'><div>ID: {{medium.id}}</div></div><div data-ng-if='medium.video && medium.video.videoType.identifier === \"youtube\"'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='http://img.youtube.com/vi/{{medium.video.uri}}/0.jpg'><div>ID: {{medium.id}}</div></div></li></ol></div></div><div class='row'><div class='col-md-12'><p>Add Medium:</p><div class=\"relation-select\" data-relation-input data-ng-attr-data-relation-entity-endpoint=\"{{backofficeMediaGroupComponent.serviceName}}.{{backofficeMediaGroupComponent.propertyName}}\" data-relation-interactive=\"false\" relation-is-deletable=\"false\" relation-is-readonly=\"false\"relation-is-creatable=\"true\"data-relation-search-field=\"id\" data-relation-suggestion-template=\"ID: [[id]]<br/><small>[[title]]</small><img src='/b-[[id_image]]/crop/auto/100'/>\" data-ng-model=\"backofficeMediaGroupComponent.addMediumModel\" data-multi-select=\"true\"></div></div></div></div>")}])}(),angular.module("jb.formComponents").directive("jbFormTreeComponent",[function(){return{controller:"JBFormTreeComponentController",link:function(e,t,n,i){i.init(e,t)},templateUrl:"treeTemplate.html",scope:{labelName:"@treeComponentLabel",entityName:"@for",maxDepth:"@"},bindToController:!0,controllerAs:"treeComponentController"}}]).controller("JBFormTreeComponentController",["$scope","$rootScope","$attrs","$location","$q","APIWrapperService","JBFormComponentsService",function(e,t,n,i,o,r,a){var s,l=this;n.maxDepth||10;l.dataTree=void 0,l.labelName&&l.entityName||console.warn("JBFormTreeComponentController: labelName or entityName (for) attribute missing"),l.editEntity=function(e,t){e.preventDefault(),i.path("/"+n.for+"/"+t)},l.init=function(e,t,n){s=t,a.registerComponent(e,l)},l.registerAt=function(e){e.registerGetDataHandler(l.handleGetData)},l.handleGetData=function(e){l.data=e,l.getData(e&&e.id?e.id:void 0)},l.isValid=function(){return!0},l.getData=function(e){if(e){var n={range:"0-1000"};console.log("JBFormTreeComponentController: filter items for menuId %o",e),n.filter="id_menu="+e,r.request({method:"GET",url:"/"+l.entityName,headers:n}).then(function(e){l.updateData(e)},function(e){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})})}},l.updateData=function(e){console.log("JBFormTreeComponentController: data is %o",e),l.dataTree=c(e),console.log("JBFormTreeComponentController: dataTree is %o",l.dataTree),setTimeout(function(){s.addClass("dd"),s.nestable({dragClass:"dd-dragelement",placeClass:"dd-placeholder",maxDepth:l.maxDepth})},500)},l.getSaveCalls=function(){if(!l.data||!l.data.id)return[];var e=s.nestable("serialize");console.log("JBFormTreeComponentController: Store data %o",e);var t=l.cleanTreeData(e,l.data.id);return console.log("JBFormTreeComponentController: Cleaned data %o, got %o",e,t),{method:"POST",headers:{"Content-Type":"application/json"},url:"/"+l.entityName,data:t}},l.cleanTreeData=function(e,t,n){n||(n=[]);for(var i in e){var o=e[i],r={};if(r.id=o.id,r.id_menu=t,l.filter)for(var a in l.filter)r[a]=l.filter[a];o.children&&(r.children=[],l.cleanTreeData(o.children,t,r.children)),n.push(r)}return n};var c=function(e){var t={};return e.sort(function(e,t){return e.left-t.left}),d(t,e),t.children},d=function(e,t){var n,i="right",o=0,r=[];e.children||(e.children=[]),t.forEach(function(t){t[i]>o?(o=t[i],r=[],e.children.push(t),n=t):t[i]+1===o?(r.push(t),d(n,r)):r.push(t)})}}]).run(function(e){e.put("treeBranchTemplate.html","<div class='dd-handle'><span data-ng-if='branch[ treeComponentController.labelName ]'>{{ branch[ treeComponentController.labelName ] }}</span><span data-ng-if='!branch[ treeComponentController.labelName ]'>N/A</span></div><button class='fa fa-pencil btn btn-link edit' data-ng-click='treeComponentController.editEntity($event,branch.id)'></button><ol data-ng-if='branch.children' class='dd-list'><li data-ng-repeat='branch in branch.children' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>"),e.put("treeTemplate.html","<ol class='dd-list'><li data-ng-repeat='branch in treeComponentController.dataTree' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>")}),function(e){"use strict";function t(e){this.api=e,this.fieldTypeMapping={string:"text",decimal:"number",integer:"number",boolean:"boolean",json:"json",datetime:"datetime",date:"datetime"}}var n=angular.module("jb.backofficeAPIWrapper",["jb.apiWrapper"]);t.prototype.request=function(e,t,n){var i=n!==!1&&e?angular.copy(t):t;return i.method=e,this.api.request(i)},t.prototype.getOptions=function(e,t){var n=angular.copy(t)||{};return n.url=e,this.request("OPTIONS",n,!1).then(this.normalizeOptions.bind(this))},t.prototype.normalizeMappings=function(e,t){Object.keys(e).forEach(function(n){var i=e[n],o={};o.type="relation",o.entity=i.modelName,o.relationKey=i.key,o.relatedKey=i.primaryKey,o.relation=i.hasAlias?i.name:i.modelName,o.alias=!!i.hasAlias&&i.name,o.relationType="multiple",o.originalRelation="hasMany",o.tableName=i.table.name,"language"===o.entity&&(o.type="language"),"image"===o.entity&&(o.type="image"),t[n]=o,t.internalMappings=t.internalMappings||{},t.internalMappings[o.relation]=o})},t.prototype.normalizeReferences=function(e,t){Object.keys(e).forEach(function(n){var i=e[n],o={};o.type="relation",o.entity=i.referencedModelName,o.relation=i.hasAlias?i.name:i.referencedModelName,o.alias=!!i.hasAlias&&i.name,o.relationType="single",o.required=i.nullable===!1,o.originalRelation="hasOne",o.relationKey=i.key,o.relatedKey=i.referencedColumn,t[n]=o,t.internalReferences=t.internalReferences||{},t.internalReferences[o.relationKey]=o,"image"==o.entity&&(o.type="image")})},t.prototype.normalizeInverseReferences=function(e,t){Object.keys(e).forEach(function(n){var i=e[n];t[n]={type:"relation",entity:i.modelName,relation:i.hasAlias?i.name:i.modelName,relatedKey:i.referencedColumn,relationKey:i.targetColumn,alias:!!i.hasAlias&&i.name,relationType:"multiple",required:!1,originalRelation:"belongsTo"}})},t.prototype.normalizeFields=function(e,t){Object.keys(e).forEach(function(n){var i=e[n];if(i.name&&i.type){var o=this.fieldTypeMapping[i.type];if(angular.isDefined(o)){var r={type:o,required:!i.nullable,isPrimary:i.name===e.primaryKey,name:i.name};"datetime"==o&&(r.time="datetime"===i.type),t[n]=r,angular.isUndefined(t.internalFields)&&(t.internalFields={}),t.internalFields[i.name]=r}else console.error("DetailViewController: unknown field type %o",i.type)}},this),angular.isUndefined(t.internalFields[e.primaryKey])&&(t.internalFields[e.primaryKey]={type:"",required:!0,isPrimary:!0,name:e.primaryKey})},t.prototype.normalizeOptions=function(e){var t={},n=angular.copy(e),i=n.hasMany,o=n.belongsTo,r=n.hasOne;return delete n.hasMany,delete n.belongsTo,delete n.hasOne,this.normalizeReferences(r,t),this.normalizeInverseReferences(o,t),this.normalizeMappings(i,t),this.normalizeFields(n,t),console.log("BackofficeAPIWrapperService: parsed options are %o",t),t},n.service("BackofficeAPIWrapperService",["APIWrapperService",t])}(),function(){"use strict";angular.module("jb.formComponents").directive("dragDropList",[function(){return{link:function(t,n,i,o){var r,a=new MutationObserver(function(t){var i=0;[].forEach.call(t,function(e){e.addedNodes&&e.addedNodes.length&&(i+=e.addedNodes.length)}),i>0&&(r.destroy(),r=new e(n[0].querySelectorAll('[draggable="true"]')))});a.observe(n[0],{childList:!0}),t.$on("$destroy",function(){a.disconnect()}),r=new e(n[0].querySelectorAll('[draggable="true"]'))},scope:{}}}]);var e;!function(){function t(e){e.removeEventListener("dragstart",i)}function n(e){e.addEventListener("dragstart",i),e.addEventListener("dragenter",o),e.addEventListener("dragover",a),e.addEventListener("dragleave",r),e.addEventListener("drop",s),e.addEventListener("dragend",c)}function i(e){e.currentTarget.style.opacity="0.4",p=e.currentTarget,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.currentTarget.outerHTML)}function o(e){e.target.classList.add("drag-over")}function r(e){e.target.classList.remove("drag-over")}function a(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}function s(e){e.stopPropagation&&e.stopPropagation();var t=l(p);if(p!==e.currentTarget){console.log("dragDropList: Drop: %o after %o",p,e.currentTarget),angular.element(e.currentTarget).after(p);var n=new CustomEvent("orderChange",{bubbles:!0,detail:{oldOrder:t,newOrder:l(e.currentTarget)+1}});e.currentTarget.dispatchEvent(n)}return!1}function l(e){for(var t=e.parentNode.childNodes,n=0,i=0;i<t.length;i++){if(e===t[i])return n;1===t[i].nodeType&&n++}return-1}function c(e){p.style.opacity="1",p=void 0,[].forEach.call(d,function(e){e.classList.remove("drag-over")})}var d,p;e=function(e){d=e,console.log("DragDropList: Initialize for elements %o",e),[].forEach.call(e,function(e){e.setAttribute("draggable",!0),n(e)})},e.prototype.destroy=function(){console.log("DragDropList: Destroy event handlers on %o elements",d.length),[].forEach.call(d,function(e){t(e)})}}()}(),function(e,t,n,i){function o(t,i){this.w=e(n),this.el=e(t),this.options=e.extend({},s,i),this.init()}var r="ontouchstart"in n,a=function(){var e=n.createElement("div"),i=n.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",i.appendChild(e);var o=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return i.removeChild(e),!!o}(),s={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};o.prototype={init:function(){var n=this;n.reset(),n.el.data("nestable-group",this.options.group),n.placeEl=e('<div class="'+n.options.placeClass+'"/>'),e.each(this.el.find(n.options.itemNodeName),function(t,i){n.setParent(e(i))}),n.el.on("click","button",function(t){if(!n.dragEl){var i=e(t.currentTarget),o=i.data("action"),r=i.parent(n.options.itemNodeName);"collapse"===o&&n.collapseItem(r),"expand"===o&&n.expandItem(r)}});var i=function(t){var i=e(t.target);if(!i.hasClass(n.options.handleClass)){if(i.closest("."+n.options.noDragClass).length)return;i=i.closest("."+n.options.handleClass)}i.length&&!n.dragEl&&(n.isTouch=/^touch/.test(t.type),n.isTouch&&1!==t.touches.length||(t.preventDefault(),n.dragStart(t.touches?t.touches[0]:t)))},o=function(e){n.dragEl&&(e.preventDefault(),n.dragMove(e.touches?e.touches[0]:e))},a=function(e){n.dragEl&&(e.preventDefault(),n.dragStop(e.touches?e.touches[0]:e))};r&&(n.el[0].addEventListener("touchstart",i,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",a,!1),t.addEventListener("touchcancel",a,!1)),n.el.on("mousedown",i),n.w.on("mousemove",o),n.w.on("mouseup",a)},serialize:function(){var t,n=0,i=this,o=function(t,n){var r=[],a=t.children(i.options.itemNodeName);return a.each(function(){var t=e(this),a=e.extend({},t.data()),s=t.children(i.options.listNodeName);s.length&&(a.children=o(s,n+1)),r.push(a)}),r};return t=o(i.el.find(i.options.listNodeName).first(),n)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var o=this.mouse,r=e(t.target),a=r.closest(this.options.itemNodeName);this.placeEl.css("height",a.height()),o.offsetX=t.offsetX!==i?t.offsetX:t.pageX-r.offset().left,o.offsetY=t.offsetY!==i?t.offsetY:t.pageY-r.offset().top,o.startX=o.lastX=t.pageX,o.startY=o.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=e(n.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",a.width()),a.after(this.placeEl),a[0].parentNode.removeChild(a[0]),a.appendTo(this.dragEl),e(n.body).append(this.dragEl),this.dragEl.css({left:t.pageX-o.offsetX,top:t.pageY-o.offsetY});var s,l,c=this.dragEl.find(this.options.itemNodeName);for(s=0;s<c.length;s++)l=e(c[s]).parents(this.options.listNodeName).length,l>this.dragDepth&&(this.dragDepth=l)},dragStop:function(e){var t=this.dragEl.children(this.options.itemNodeName).first();t[0].parentNode.removeChild(t[0]),this.placeEl.replaceWith(t),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(i){var o,r,s,l,c,d=this.options,p=this.mouse;this.dragEl.css({left:i.pageX-p.offsetX,top:i.pageY-p.offsetY}),p.lastX=p.nowX,p.lastY=p.nowY,p.nowX=i.pageX,p.nowY=i.pageY,p.distX=p.nowX-p.lastX,p.distY=p.nowY-p.lastY,p.lastDirX=p.dirX,p.lastDirY=p.dirY,p.dirX=0===p.distX?0:p.distX>0?1:-1,p.dirY=0===p.distY?0:p.distY>0?1:-1;var u=Math.abs(p.distX)>Math.abs(p.distY)?1:0;if(!p.moving)return p.dirAx=u,void(p.moving=!0);p.dirAx!==u?(p.distAxX=0,p.distAxY=0):(p.distAxX+=Math.abs(p.distX),0!==p.dirX&&p.dirX!==p.lastDirX&&(p.distAxX=0),p.distAxY+=Math.abs(p.distY),0!==p.dirY&&p.dirY!==p.lastDirY&&(p.distAxY=0)),p.dirAx=u,p.dirAx&&p.distAxX>=d.threshold&&(p.distAxX=0,s=this.placeEl.prev(d.itemNodeName),p.distX>0&&s.length&&!s.hasClass(d.collapsedClass)&&(o=s.find(d.listNodeName).last(),c=this.placeEl.parents(d.listNodeName).length,c+this.dragDepth<=d.maxDepth&&(o.length?(o=s.children(d.listNodeName).last(),o.append(this.placeEl)):(o=e("<"+d.listNodeName+"/>").addClass(d.listClass),o.append(this.placeEl),s.append(o),this.setParent(s)))),p.distX<0&&(l=this.placeEl.next(d.itemNodeName),l.length||(r=this.placeEl.parent(),this.placeEl.closest(d.itemNodeName).after(this.placeEl),r.children().length||this.unsetParent(r.parent()))));var h=!1;if(a||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(n.elementFromPoint(i.pageX-n.body.scrollLeft,i.pageY-(t.pageYOffset||n.documentElement.scrollTop))),a||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(d.handleClass)&&(this.pointEl=this.pointEl.parent(d.itemNodeName)),this.pointEl.hasClass(d.emptyClass))h=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(d.itemClass))return;var m=this.pointEl.closest("."+d.rootClass),f=this.dragRootEl.data("nestable-id")!==m.data("nestable-id");if(!p.dirAx||f||h){if(f&&d.group!==m.data("nestable-group"))return;if(c=this.dragDepth-1+this.pointEl.parents(d.listNodeName).length,c>d.maxDepth)return;var g=i.pageY<this.pointEl.offset().top+this.pointEl.height()/2;r=this.placeEl.parent(),h?(o=e(n.createElement(d.listNodeName)).addClass(d.listClass),o.append(this.placeEl),this.pointEl.replaceWith(o)):g?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),r.children().length||this.unsetParent(r.parent()),this.dragRootEl.find(d.itemNodeName).length||this.dragRootEl.append('<div class="'+d.emptyClass+'"/>'),
f&&(this.dragRootEl=m,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},e.fn.nestable=function(t){var n=this,i=this;return n.each(function(){var n=e(this).data("nestable");n?"string"==typeof t&&"function"==typeof n[t]&&(i=n[t]()):(e(this).data("nestable",new o(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),i||n}}(window.jQuery||window.Zepto,window,document);