!function(e){"use strict";angular.module("jb.backofficeForms",["jb.formComponents"])}(),function(){"use strict";angular.module("jb.formComponents",["jb.fileDropComponent","ui.router","jb.apiWrapper","pascalprecht.translate","jb.formEvents","jb.backofficeAPIWrapper"])}(),function(){function e(e,t,n){this.registeredComponents=[],this.scope=n,this.optionsDataHandlers=[],this.getDataHandlers=[],this.$q=e,this.formEvents=t}var t=angular.module("jb.formEvents",[]);t.provider("jbFormEvents",function(){var e={registerComponent:"jb.backoffice-form-event.registerComponent"};this.setEventKey=function(t,n){e[t]=n},this.hasEventKeyAt=function(t){return angular.isDefined(e[t])},this.getEventKeyAt=function(t){return e[t]},this.removeEventKey=function(t){delete e[t]},this.$get=[function(){return Object.freeze(e)}]}),e.prototype.listen=function(){return this.scope.$on(this.formEvents.registerComponent,function(e,t){console.log("REGISTRATION OF:",t),t!==this&&(e.stopPropagation(),this.registerComponent(t))}.bind(this)),this},e.prototype.registerComponent=function(e){this.registeredComponents.push(e),e.registerAt(this)},e.prototype.getSaveCalls=function(){return this.registeredComponents.reduce(function(e,t){t.getSaveCalls();return e.concat(t.getSaveCalls())},[])},e.prototype.isValid=function(){for(var e=0;e<this.registeredComponents.length;e++)if(this.registeredComponents[e].isValid()===!1)return!1;return!0},e.prototype.getAfterSaveTasks=function(e){var t=this.registeredComponents.reduce(function(e,t){return angular.isFunction(t.afterSaveTasks)?e.concat(t.afterSaveTasks()):e},[this.$q.when(e)]);return this.$q.all(t)},e.prototype.getBeforeSaveTasks=function(e){var t=this.registeredComponents.reduce(function(t,n){return angular.isFunction(n.beforeSaveTasks)&&t.push(n.beforeSaveTasks(e)),t},[]);return this.$q.all(t)},e.prototype.getSelectFields=function(){return this.registeredComponents.reduce(function(e,t){return angular.isFunction(t.getSelectFields)?e.concat(t.getSelectFields()):angular.isDefined(t.select)?e.concat(t.select):e},[])},e.prototype.optionsDataHandler=function(e){return this.$q.all(this.optionsDataHandlers.map(function(t){return this.$q.when(t(e))},this))},e.prototype.registerOptionsDataHandler=function(e){this.optionsDataHandlers.push(e)},e.prototype.registerGetDataHandler=function(e){this.getDataHandlers.push(e)},e.prototype.unregisterGetDataHandler=function(e){this.getDataHandlers.splice(this.getDataHandlers.indexOf(e),1)},e.prototype.unregisterOptionsDataHandler=function(e){this.optionsDataHandlers.splice(this.optionsDataHandlers.indexOf(e),1)},e.prototype.getDataHandler=function(e){this.getDataHandlers.forEach(function(t){t(e)})},e.prototype.registerYourself=function(e){(e||this.scope).$parent.$emit(this.formEvents.registerComponent,this)},e.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.optionsDataHandler.bind(this)),e.registerGetDataHandler(this.getDataHandler.bind(this))},t.factory("JBFormComponentsService",["$q","jbFormEvents",function(t,n){return{registryFor:function(i){var o=new e(t,n,i);return o},registerComponent:function(e,t){e.$parent.$emit(n.registerComponent,t)}}}])}(),function(){"use strict";var e=angular.module("jb.formComponents");e.directive("jbFormImageComponent",[function(){return{controller:"jbFormImageComponentController",controllerAs:"backofficeImageComponent",bindToController:!0,require:"",link:function(e,t,n,i){i.init(e,t,n)},scope:{propertyName:"@for",pathField:"@",imageModel:"=model",label:"@"},template:'<div class="row"><label jb-form-label-component data-label-identifier="{{backofficeImageComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-component" ><div data-file-drop-component data-supported-file-types="[\'image/jpeg\']" data-model="backofficeImageComponent.images" data-error-handler="backofficeImageComponent.handleDropError(error)"><ol class="clearfix"><li data-ng-repeat="image in backofficeImageComponent.images"><a href="#" data-ng-click="backofficeImageComponent.openDetailView( $event, image )"><img data-ng-attr-src="{{image.url || image.fileData}}"/><button class="remove" data-ng-click="backofficeImageComponent.removeImage($event,image)">&times</button></a><span class="image-size-info" data-ng-if="!!image.width && !!image.height">{{image.width}}&times;{{image.height}} Pixels</span><span class="image-file-size-info" data-ng-if="!!image.fileSize">{{image.fileSize/1000/1000 | number: 1 }} MB</span><span class="focal-point-info" data-ng-if="!!image.focalPoint">Focal Point</span></li><li><button class="add-file-button" data-ng-click="backofficeImageComponent.uploadFile()">+</button></li></ol><input type="file" multiple/></div></div></div>'}}]),e.controller("jbFormImageComponentController",["$scope","$rootScope","$q","$state","APIWrapperService","JBFormComponentsService",function(e,t,n,i,o,a){function r(e){var t;try{t=JSON.parse(e.focalPoint)}catch(n){console.error("jbFormImageComponentController: Could not parse focalPoint JSON",e.focalPoint)}return{url:e[f.pathField],entityUrl:"/image/"+e.id,focalPoint:t,width:e.width,height:e.height,fileSize:e.size,mimeType:e.mimeType.mimeType,id:e.id}}function l(){if(!m||!m.length||f.images&&f.images.length){if(m&&m.length||!f.images||!f.images.length){if(m&&m.length&&f.images&&f.images.length&&m[0].id!==f.images[f.images.length-1].id){var e={};return e[u]=f.images[f.images.length-1].id,[{data:e}]}return console.log("jbFormImageComponentController: No changes made to a single relation image"),[]}var t={};return t[u]=f.images[0].id,[{data:t}]}var n={};return n[u]=null,[{data:n}]}function s(){var e=[],t=[],n=[];return m&&angular.isArray(m)&&m.forEach(function(e){t.push(e.id)}),f.images.forEach(function(e){n.push(e.id)}),t.forEach(function(t){n.indexOf(t)===-1&&e.push({method:"DELETE",url:"/image/"+t})}),n.forEach(function(n){t.indexOf(n)===-1&&e.push({method:"POST",url:"image/"+n})}),console.log("jbFormImageComponentController: Calls to be made are %o",e),e}function c(e){return console.log("jbFormImageComponentController: Upload file %o to /image through a POST request",e),o.request({method:"POST",data:{image:e.file},url:"/image"}).then(function(t){var n=f.images.indexOf(e),i=r(t);return f.images.splice(n,1,i),console.log("jbFormImageComponentController: Image uploaded, replace %o with %o",f.images[n],i),t})}var d,u,p,m,f=this;f.images=[],f.init=function(e,t,n,i){d=t,f.ensureSingleImageRelation(),a.registerComponent(e,f)},f.registerAt=function(e){e.registerOptionsDataHandler(f.updateOptionsData),e.registerGetDataHandler(f.updateData)},f.isValid=function(){return!0},f.ensureSingleImageRelation=function(){e.$watchCollection(function(){return f.images},function(){p&&f.images.length>1&&f.images.splice(0,f.images.length-1)})},f.updateData=function(e){f.images=[],e.image||(e.image=[]),angular.isArray(e.image)||(e.image=[e.image]),m=e.image.slice(),e.image.forEach(function(e){f.images.push(r(e))})},f.updateOptionsData=function(e){return e[f.propertyName]&&angular.isObject(e[f.propertyName])?void(e[f.propertyName].relationKey?(u=e[f.propertyName].relationKey,p=!0):p=!1):void console.error("jbFormImageComponentController: Missing data for %o",f.propertyName)},f.getSelectFields=function(){return[f.propertyName+".*",f.propertyName+"."+f.pathField,f.propertyName+".mimeType.*"]},f.getSaveCalls=function(){return p?l():s()},f.beforeSaveTasks=function(){var e=[];return f.images.forEach(function(t){t.file&&t.file instanceof File&&(console.log("jbFormImageComponentController: New file %o",t),e.push(c(t)))}),console.log("jbFormImageComponentController: Upload %o",e),n.all(e)},f.removeImage=function(e,t){e.preventDefault(),f.images.splice(f.images.indexOf(t),1)},f.openDetailView=function(e,t){e.preventDefault(),t.id&&i.go("app.detail",{entityName:"image",entityId:t.id})},f.handleDropError=function(n){e.$apply(function(){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.imageDropError",variables:{errorMessage:n}})})},f.uploadFile=function(){d.find("input[type='file']").click()}}])}(),function(e){"use strict";var t=angular.module("jb.formComponents");t.directive("jbFormImageDetailComponent",[function(){return{controller:"JBFormImageDetailComponentController",controllerAs:"backofficeImageDetailComponent",bindToController:!0,link:function(e,t,n,i){i.init(e,t,n)},template:'<label data-backoffice-label data-label-identifier="{{backofficeImageDetailComponent.label}}" data-is-required="false" data-is-valid="true"></label><div class="col-md-9 backoffice-image-detail-component"><div class="image-container"><img data-ng-attr-src="{{backofficeImageDetailComponent.image[ backofficeImageDetailComponent.pathField ]}}" data-ng-click="backofficeImageDetailComponent.setFocalPointClickHandler($event)"/><div class="focal-point-indicator" data-ng-if="backofficeImageDetailComponent.getFocalPoint()" data-ng-attr-style="top:{{backofficeImageDetailComponent.getFocalPointInPercent().y}}%;left:{{backofficeImageDetailComponent.getFocalPointInPercent().x}}%"></div></div><div data-ng-if="!backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPointNotSet" | translate }}</div><div data-ng-if="backofficeImageDetailComponent.getFocalPoint()">{{ "web.backoffice.image.focalPoint" | translate }}: {{ backofficeImageDetailComponent.getFocalPoint().x }} / {{backofficeImageDetailComponent.getFocalPoint().y}} </div></div>',scope:{pathField:"@",label:"@"}}}]),t.controller("JBFormImageDetailComponentController",["$scope","JBFormComponentsService",function(e,t){var n,i=this;i.image={},i.init=function(e,n,o){t.registerComponent(e,i)},i.registerAt=function(e){e.registerGetDataHandler(i.updateData)},i.updateData=function(e){if(i.image=e,e.focalPoint)try{var t=JSON.parse(e.focalPoint);if(!t.x||!t.y)throw new Error("Property x or y missing on "+e.focalPoint);if(t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),isNaN(t.x)||isNaN(t.y))throw new Error("x or y property on focalPoint not an integer (or castable).");i.image.focalPoint=t}catch(o){console.error("JBFormImageDetailComponentController: Could not parse focalPoint "+e.focalPoint+": "+o.message)}n=angular.copy(e.focalPoint)},i.getSelectFields=function(){return"*,mimeType.*,"+i.pathField},i.getSaveCalls=function(){if(!n&&!i.image.focalPoint)return!1;var e=n&&i.image.focalPoint&&n.x&&i.image.focalPoint.x&&i.image.focalPoint.x===n.x,t=n&&i.image.focalPoint&&n.y&&i.image.focalPoint.y&&i.image.focalPoint.y===n.y;if(e&&t)return!1;var o=[];return o.push({method:"PATCH",url:"",data:{focalPoint:JSON.stringify(i.image.focalPoint)}}),o},i.setFocalPointClickHandler=function(e){var t={x:Math.round(e.offsetX/e.target.width*i.image.width),y:Math.round(e.offsetY/e.target.height*i.image.height)};console.log("JBFormImageDetailComponentController: Set focal point to ",JSON.stringify(t)),i.image.focalPoint=t},i.getFocalPoint=function(){return!(!i.image||!i.image.focalPoint)&&i.image.focalPoint},i.getFocalPointInPercent=function(){var e=i.getFocalPoint();return!!e&&{x:Math.round(e.x/i.image.width*100),y:Math.round(e.y/i.image.height*100)}}}])}(),function(e){"use strict";var t=angular.module("jb.formComponents");t.controller("jbFormLabelController",["$scope",function(e){this.$scope=e}]),t.directive("jbFormLabelComponent",["$templateCache","$compile",function(e,t){return{link:function(n,i,o,a){var r=angular.element(e.get("backofficeLabelTemplate.html"));i.replaceWith(r),t(r)(n)},scope:{labelIdentifier:"@",isRequired:"&",isValid:"&"}}}]),t.run(function(e){e.put("backofficeLabelTemplate.html",'<div class="col-md-3"><label class="control-label" data-ng-class="{invalid: !isValid()}"><span data-ng-if="isRequired()||required" class="required-indicator">*</span><span data-translate="{{labelIdentifier}}"></span></label></div>')})}(),function(e){"use strict";function t(e,t,n,i,o,a,r){this.$scope=e,this.api=i,this.$q=t,this.$timeout=n,this.componentsService=o,this.options=null,this.fieldDefinitions=null,this.fields=[],this.selectedLanguages=[],this.locales=[],this.originalLocales=[],this.heightElement=null,this.heightElementInitialized=!1,this.boAPI=r,this.supportedLanguages=(a.get("supported-languages","local")||[]).map(function(e,t){var n=angular.copy(e.language);return n.selected=!1,n},this),this.element=null}var n=angular.module("jb.formComponents");n.directive("jbFormLocaleComponent",function(){return{controller:"LocaleController",controllerAs:"$ctrl",bindToController:!0,scope:{fieldsExclude:"<",entityName:"@entity",relationName:"@relation"},template:'<div class="locale-component container"><!-- LOCALE-COMPONENT: way too many divs in here --><div class="row"><div class="col-md-12"><ul class="nav nav-tabs col-md-12"><li ng-repeat="language in $ctrl.getSupportedLanguages()" ng-class="{active:$ctrl.isSelected(language)}"><a href="#" ng-click="$ctrl.toggleLanguage($event, language)">{{language.code|uppercase}}<span data-ng-if="$ctrl.checkForTranslation(language)" class="fa fa-check"></span></a></li></ul></div></div><div class="locale-content"><div class="locale-col" ng-repeat="language in $ctrl.getSelectedLanguages()"><p>{{ language.code | uppercase }}</p><ul><li ng-repeat="field in $ctrl.getFields()"><label ng-attr-for="locale-{{language.code}}-{{field.name}}" ng-class="{ \'invalid\' : !$ctrl.fieldIsValid($ctrl.locales[ language.id ], field.name)}"><span data-translate="web.backoffice.{{$ctrl.entityName}}.{{field.name}}"></span><span class="required-indicator" data-ng-show="field.required">*</span></label><textarea ng-model="$ctrl.locales[ language.id ][ field.name ]" ng-attr-id="locale-{{language.code}}-{{field.name}}"class="form-control" ng-keyup="$ctrl.adjustHeight( $event )" ng-click="$ctrl.adjustHeight( $event )" /></textarea></li></ul></div></div></div>',link:{pre:function(e,t,n,i){i.preLink(e,t,n)},post:function(e,t,n,i){i.postLink(e,t,n)}}}}),t.prototype.preLink=function(){},t.prototype.postLink=function(e,t,n){this.componentsService.registerComponent(e,this),this.heightElement=angular.element("<div></div>"),this.heightElement=this.heightElement.attr("id","locale-height-container"),this.heightElement.css("position","absolute"),this.heightElement.css("left","-9999px"),this.heightElement.css("top","-9999px"),this.element=t,this.element.append(this.heightElement)},t.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},t.prototype.getSelectedLanguages=function(){for(var e=[],t=0;t<this.supportedLanguages.length;t++){var n=this.supportedLanguages[t];n.selected===!0&&e.push(n)}return e},t.prototype.getSupportedLanguages=function(){return this.supportedLanguages},t.prototype.fieldIsValid=function(e,t){var n=this.fieldDefinitions[t];return!e||(n.required!==!0||!this._localePropertyIsEmpty(e[t]))},t.prototype.adjustHeight=function(e){var t=angular.element(e.currentTarget);this.adjustElementHeight(t)},t.prototype.adjustElementHeight=function(e){var t,n=e[0].scrollHeight,i=e.val();this.heightElementInitialized||this.initializeHeightElement(e),e.height(n),t=e.width(),this.heightElement.width(t),i=i.replace(/(\n\r?)/g,"<br>").replace(/(\<br\>\s*)$/,"<br><br>"),""==i.trim()&&(i="empty"),this.heightElement.html(i),this.heightElement.width(t),e.height(this.heightElement.height())},t.prototype.adjustAllHeights=function(){this.element.find("textarea").each(function(e,t){this.adjustElementHeight(angular.element(t))}.bind(this))},t.prototype.initializeHeightElement=function(e){["font-size","font-family","font-weight","letter-spacing","line-height","padding-top","padding-left","padding-right","padding-bottom","border-radius","border"].forEach(function(t){this.heightElement.css(t,e.css(t))},this),this.heightElement.css("word-wrap","break-word"),this.heightElementInitialized=!0},t.prototype.toggleLanguage=function(e,t){e&&e.preventDefault();var n=this.getSelectedLanguages();t.selected&&1==n.length||(t.selected=t.selected!==!0,this.$timeout(this.adjustAllHeights.bind(this)))},t.prototype.isSelected=function(e){return e.selected===!0},t.prototype.checkForTranslation=function(e){return!(!this.locales||!angular.isDefined(this.locales[e.id]))},t.prototype.translationIsEmpty=function(e){return this.fields.reduce(function(t,n){return t&&!e[n]&&""!==e[n].trim()},!0)},t.prototype.handleOptionsData=function(e){var t;return e&&angular.isDefined(e[this.relationName])?(t=e[this.relationName],this.options=t,void this.loadFields().then(function(e){this.$timeout(function(){this.fieldDefinitions=this.filterFields(e),this.fields=Object.keys(this.fieldDefinitions)}.bind(this))}.bind(this),function(e){console.error(e)})):console.error("No OPTIONS data found in locale component.")},t.prototype.loadFields=function(){var e="/"+this.options.tableName;return this.fieldDefinitions?this.$q.when(this.fieldDefinitions):this.boAPI.getOptions(e).then(function(e){return e.internalFields}.bind(this),function(e){console.error(e)})},t.prototype.filterFields=function(e){return Object.keys(e).reduce(function(t,n){return this.fieldsExclude&&this.fieldsExclude.indexOf(n)!=-1||(t[n]=e[n]),t}.bind(this),{})},t.prototype._localeIsEmpty=function(e){return this.fields.every(function(t){return this._localePropertyIsEmpty(e[t])},this)},t.prototype._localePropertyIsEmpty=function(e){return angular.isUndefined(e)||""==e.trim()},t.prototype._localeGetChanges=function(e,t){return angular.isDefined(t)?this.fields.reduce(function(n,i){return e[i]!=t[i]&&n.push(i),n}.bind(this),[]):this._localeIsEmpty(e)?[]:this.fields},t.prototype.getSaveCalls=function(){var e=[];return this.locales.forEach(function(t,n){var i=this.originalLocales[n],o=angular.isDefined(i);if(t){var a=this._localeGetChanges(t,i),r=o?"PATCH":"POST";if(a.length>0){var l={};l.data=a.reduce(function(e,n){return e[n]=t[n],e},{}),l.url={},l.url.path="language/"+n,l.url.mainEntity="prepend",l.method=r,e.push(l)}}},this),e},t.prototype.handleGetData=function(e){var t=e[this.options.tableName];return t&&(this.originalLocales=this.normalizeModel(t),this.locales=angular.copy(this.originalLocales)),0===this.getSelectedLanguages().length?this.$timeout(function(){this.toggleLanguage(null,this.supportedLanguages[0])}.bind(this)):void this.$timeout(this.adjustAllHeights.bind(this))},t.prototype.getFields=function(){return this.fieldDefinitions?this.fields.map(function(e){return this.fieldDefinitions[e]},this):[]},t.prototype.normalizeModel=function(e){return e.reduce(function(e,t){return e[t.language.id]=t,e},[])},t.prototype.getLocales=function(){return this.locales},t.prototype.getSelectFields=function(){var e=this.options.tableName,t=[e,"language","*"].join("."),n=[];return n.push([e,"*"].join(".")),n.push(t),n},t.prototype.isValid=function(){return this.locales.reduce(function(e,t,n){return angular.isUndefined(t)?e:angular.isUndefined(this.originalLocales[n])&&this._localeIsEmpty(t)?e:e&&this.fields.reduce(function(e,n){return e&&this.fieldIsValid(t,n)}.bind(this),!0)}.bind(this),!0)},n.controller("LocaleController",["$scope","$q","$timeout","APIWrapperService","JBFormComponentsService","SessionService","BackofficeAPIWrapperService",t])}(),function(e){"use strict";function t(e){return function(){return{controller:e,controllerAs:"$ctrl",bindToController:!0,link:{pre:function(e,t,n,i){i.preLink(e,t,n)},post:function(e,t,n,i){i.postLink(e,t,n)}},scope:{propertyName:"@for",entityName:"@entity",relationName:"@relation",label:"@",suggestion:"@suggestionTemplate",searchField:"@",changeHandler:"&"}}}}function n(e,t,n,i,o,a){this.subcomponentsService=o,this.options=null,this.originalData=[],this.suggestion="",this.relationService=a,this.$scope=e,this.$compile=n,this.$templateCache=i,this.element=null,this.currentData=[],this.referencedPropertyName=null,this.entities=[]}function i(e,t,i,o,a,r){n.call(this,e,t,i,o,a,r)}var o=angular.module("jb.formComponents");o.directive("jbFormReferenceComponent",[t("JBFormReferenceController")]),o.directive("jbFormRelationComponent",[t("JBFormRelationController")]),n.prototype.preLink=function(){},n.prototype.postLink=function(e,t,n){this.subcomponentsService.registerComponent(e,this),this.element=t},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.handleGetData.bind(this))},n.prototype.getEndpoint=function(){return this.relationName},n.prototype.handleGetData=function(e){if(this.currentData=[],e&&e[this.relationName]){var t=e[this.relationName];angular.isArray(t)||(t=[t]),this.currentData=t}this.originalData=angular.copy(this.currentData),this.$scope.$watch(function(){return this.currentData}.bind(this),function(e,t){this.changeHandler&&this.changeHandler({newValue:e,oldValue:t})}.bind(this)),console.log("BackofficeReferenceComponentController: Model updated (updateData) to %o",this.currentData)},n.prototype.getSpec=function(e){var t,n;if(!e)return t;if(n=angular.isDefined(e.internalReferences),this.propertyName&&n)return e.internalReferences[this.propertyName];if(this.entityName&&n){for(var i=Object.keys(e.internalReferences),o=0;o<i.length;o++){var a=i[o];if(e.internalReferences[a].entity==this.entityName)return e.internalReferences[a]}return t}return this.relationName?e[this.relationName]:t},n.prototype.handleOptionsData=function(e){var t=this.getSpec(e);return angular.isDefined(t)?(this.propertyName=t.relationKey,this.entityName=t.entity,this.relationName=t.relation,this.referencedPropertyName=t.relatedKey,this.options=t,void this.renderComponent()):console.error("JBFormReferenceController: No options data found for name %o referencing entity %o.",this.propertyName,this.entityName)},n.prototype.isMultiSelect=function(){return!1},n.prototype.renderComponent=function(){var e=angular.element(this.$templateCache.get("referenceComponentTemplate.html"));e.find("[relation-input]").attr("relation-entity-endpoint",this.getEndpoint()).attr("relation-interactive",this.isInteractive()).attr("deletable","$ctrl.isDeletable()").attr("relation-entity-search-field",this.getSearchField()).attr("relation-suggestion-template",this.getSuggestionTemplate()).attr("multi-select",this.isMultiSelect()).attr("ng-model","$ctrl.currentData"),this.$compile(e)(this.$scope),this.element.prepend(e)},n.prototype.addModelTransformations=function(e){return e.attr("sanitize-model",!0)},n.prototype.isInteractive=function(){return!0},n.prototype.isDeletable=function(){return!0},n.prototype.getLabel=function(){return this.label?this.label:this.propertyName},n.prototype.getSelectFields=function(){var e=this.relationService.extractSelectFields(this.getSuggestionTemplate()),t=e.map(function(e){return[this.relationName,e].join(".")},this);return this.propertyName&&t.unshift(this.propertyName),t},n.prototype.isRequired=function(){return!this.options||this.options.required===!0},n.prototype.isMultiSelect=function(){return!1},n.prototype.getSuggestionTemplate=function(){return this.suggestion},n.prototype.getSearchField=function(){return this.searchField},n.prototype.isValid=function(){return!this.isRequired()||this.currentData.length>0},n.prototype.getSaveCalls=function(){var e,t,n=this.currentData[0],i=this.originalData[0];if(n&&(e=n[this.referencedPropertyName]),i&&(t=i[this.referencedPropertyName]),t!==e){var o={data:{}};return o.data[this.propertyName]=angular.isDefined(e)?e:"",[o]}return[]},i.prototype=Object.create(n.prototype),i.prototype.constructor=i,i.prototype.isMultiSelect=function(){return!0},i.prototype.getSpec=function(e){if(e)return this.relationName?e[this.relationName]:e[this.entityName]},i.prototype.getSaveCalls=function(){var e,t=this.mapProperties(this.currentData,this.referencedPropertyName);return e=this.originalData.reduce(function(e,n){var i=n[this.referencedPropertyName];return angular.isDefined(t[i])?delete t[i]:e.push({method:"DELETE",url:{path:[this.relationName,i].join("/"),mainEntity:"append"}}),e}.bind(this),[]),Object.keys(t).forEach(function(t){e.push({method:"POST",url:{path:[this.relationName,t].join("/"),mainEntity:"append"}})},this),e},i.prototype.mapProperties=function(e,t){return e.reduce(function(e,n){return e[n[t]]=n,e},{})},o.controller("JBFormReferenceController",["$scope","$attrs","$compile","$templateCache","JBFormComponentsService","RelationInputService",n]),o.controller("JBFormRelationController",["$scope","$attrs","$compile","$templateCache","JBFormComponentsService","RelationInputService",i]),o.run(["$templateCache",function(e){e.put("referenceComponentTemplate.html",'<div class="form-group"><label jb-form-label-component label-identifier="{{$ctrl.getLabel()}}" is-required="$ctrl.isRequired()" is-valid="$ctrl.isValid()"></label><div relation-input class="relation-select col-md-9"></div></div>')}])}(),angular.module("jb.formComponents").controller("JBFormViewLoaderController",["$scope","$location","$http","$q","$compile",function(e,t,n,i,o){var a=this,r=t.path(),l=r.split("/");if(!l.length)return void alert("no path provided");var s=l[1],c=l[2];console.log("DetailViewLoader: entity name is %o, id %o",s,c),a.getControllerAndTemplate=function(e,t){if(!e)return!1;var n,i,o=e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),a="src/app/"+o+"/";return t?"new"!==t&&isNaN(parseInt(t,10))?console.error("unknown entity id: %o",t):n=a+o+"-detail.tpl.html":(i="backoffice"+e.substring(0,1).toUpperCase()+e.substring(1)+"ListController",n=a+o+"-list.tpl.html"),{controllerName:i,templateUrl:n}},a.getTemplate=function(e){return n({method:"GET",url:e,headers:{accept:"text/html"}}).then(function(e){return console.log("DetailViewLoader: got template %o",e),e.data},function(e){return i.reject(e)})},a.renderTemplate=function(t,n){var i=$("[ng-view], [data-ng-view]"),a=$("<div></div>");n&&a.attr("data-ng-controller",n),a.html(t),console.log("DetailViewLoader: render Template %o with controller %o",a,n),i.empty().append(a),o(a)(e)},a.init=function(){var e=a.getControllerAndTemplate(s,c);if(!e)return void a.renderTemplate("404 â€“ Page could not be found",!1);var t=e.templateUrl,n=e.controllerName;a.getTemplate(t).then(function(e){a.renderTemplate(e,n)},function(e){var n=$("[ng-view], [data-ng-view]");n.text("Template "+t+" not found. Entity can't be edited")})},a.init()}]),function(e){"use strict";function t(e,t,n,i,o,a,r,l){this.$scope=e,this.$rootScope=t,this.$q=n,this.$filter=i,this.$state=o,this.api=a,this.boAPI=l,this.componentsService=r,this.componentsRegistry=null}var n=angular.module("jb.formComponents");n.directive("jbFormView",[function(){return{link:{pre:function(e,t,n,i){angular.isFunction(i.preLink)&&i.preLink(e,t,n)},post:function(e,t,n,i){t.addClass("jb-form-view"),i.init(e,t,n)}},controller:"DetailViewController",bindToController:!0,controllerAs:"$ctrl",scope:!0}}]),t.prototype.init=function(e,t,n){},n.controller("DetailViewController",["$scope","$rootScope","$q","$attrs","$filter","$state","APIWrapperService","JBFormComponentsService","BackofficeAPIWrapperService",function(t,n,i,o,a,r,l,s,c){var d,u=this;u.componentsService=s,u.componentsRegistry=null,u.optionData=null,u.parentOptionData=null,t.$watchGroup(["$ctrl.entityName","$ctrl.entityId"],function(){u.setTitle()}),u.preLink=function(e,t,n){u.componentsRegistry=u.componentsService.registryFor(e),u.componentsRegistry.listen()},u.parseUrl=function(){return{name:r.params.entityName,id:!(!r.params.entityId||"new"===r.params.entityId)&&r.params.entityId,isNew:"new"===r.params.entityId}},u.getEntityId=function(){return t.entityId},u.getEntityName=function(){return t.entityName},u.getEntityUrl=function(){var e="/"+u.getEntityName();return u.getEntityId()&&(e+="/"+u.getEntityId()),e},u.setTitle=function(){var e=u.getEntityName(),n=a("translate")("web.backoffice.create");u.entityId&&(n=a("translate")("web.backoffice.edit"),e=e+" #"+u.entityId),t.title=[n,e].join(": ")},u.init=function(e,t,n){var o=[];if(d=t,u.isRoot=n.hasOwnProperty("isRoot"),u.hasEntityName=n.hasOwnProperty("entityName"),u.hasEntityId=n.hasOwnProperty("entityId"),u.hasEntityName){var a=i.defer();o.push(a.promise),e.$watch(function(){return n.entityName},function(e){console.info(e),e&&(u.setEntityName(e),a.resolve())})}if(u.hasEntityId){var r=i.defer();o.push(r.promise),e.$watch(function(){return n.entityId},function(e){u.setEntityId(e),r.resolve()})}if(!u.hasEntityName&&!u.hasEntityId){var l=u.parseUrl();u.setEntityName(l.name),u.setEntityId(l.id)}u.componentsService.registerComponent(e,this),i.all(o).then(function(){u.isRoot&&u.getOptionData().then(u.getData)["catch"](function(e){console.error(e)})})},u.setEntityName=function(e){u.entityName=e,t.entityName=e},u.setEntityId=function(e){u.entityId=e,t.entityId=e},u.registerAt=function(e){e.registerOptionsDataHandler(u.handleOptionsData),e.registerGetDataHandler(u.handleGetData)},u.handleGetData=function(t){var n=t[u.entityName];if(angular.isDefined(n)||console.error("No data available for related %o",u.entityName),!u.entityId&&n){var i=u.parentOptionData.relatedKey;u.setEntityId(n[i])}u.entityId||n||u.setEntityId(e),u.distributeData(n)},u.getSaveCalls=function(){var e={};return e.data={},e.data[u.parentOptionData.relationKey]=u.getEntityId(),[e]},u.internallyHandleOptionsData=function(e){return u.optionData=e,u.componentsRegistry.optionsDataHandler(e)},u.handleOptionsData=function(e){var t=e[u.entityName];return u.parentOptionData=t,u.getOptionData()},u.getOptionData=function(){return console.log("DetailView: Make OPTIONS call for %o",u.getEntityName()),u.makeOptionRequest("/"+u.getEntityName()).then(u.internallyHandleOptionsData,function(e){n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.optionsLoadingError",variables:{errorMessage:e}})})},u.makeOptionRequest=function(e){return c.getOptions(e)},u.register=function(e){throw new Error("DEPRECATED")},u.getData=function(){u.makeGetRequest().then(u.distributeData,function(e){n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})})},u.getSelectParameters=function(){return u.componentsRegistry.getSelectFields()},u.getSelectFields=function(){return u.getSelectParameters().map(function(e){return[this.getEntityName(),e].join(".")}.bind(this))},u.distributeData=function(e){u.componentsRegistry.getDataHandler(e)},u.updateData=function(){return u.makeGetRequest().then(function(e){return u.distributeData(e),e},function(e){return n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.saveError",variables:{errorMessage:e}}),i.reject(e)})},u.makeGetRequest=function(){var e=u.getEntityUrl(),t=u.getSelectParameters();return console.log("DetailView: Get Data from %o with select %o",e,t),l.request({url:e,headers:{select:t},method:"GET"}).then(function(e){return e}.bind(this),function(e){return i.reject(e)})},t.save=function(e,t,o){return t&&angular.isFunction(t.preventDefault)&&t.preventDefault(),u.makeSaveRequest(u.registeredComponents,u.getEntityName()).then(function(t){return u.parseUrl().isNew&&!e&&r.go("app.detail",{entityName:u.getEntityName(),entityId:u.getEntityId()}),e?console.log("DetailViewController: Don't show any message or redirect"):(console.log("DetailViewController: Show success message on %o",n),n.$broadcast("notification",{type:"success",message:"web.backoffice.detail.saveSuccess"})),u.updateData(),t||null})["catch"](function(e){return n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.saveError",variables:{errorMessage:e.message}}),i.reject(e)})},u.isValid=function(){return u.componentsRegistry.isValid()},u.makeSaveRequest=function(){return u.isValid()?u.executePreSaveTasks().then(function(e){return u.makeMainSaveCall()}).then(function(){return u.executePostSaveTasks()}):i.reject(new Error("Not all required fields filled out."))},u.executePreSaveTasks=function(){var e={};return e.meta={},u.componentsRegistry.getBeforeSaveTasks(e)},u.beforeSaveTasks=function(e){var t=u.makeSaveRequest();return t},u.executePostSaveTasks=function(){return u.componentsRegistry.getAfterSaveTasks()},u.getOwnId=function(e){if(!e)return null;
for(var t=Object.keys(this.optionData.internalFields),n=0;n<t.length;n++){var i=this.optionData.internalFields[t[n]];if(i.isPrimary===!0)return e[t[n]]}return null},u.makeMainSaveCall=function(){var e=u.generateSaveCalls();console.log("DetailView: Save calls are %o",e);for(var t,n,o=[],a=0;a<e.length;a++)angular.isObject(e[a].url)||e[a].url&&0!==e[a].url.indexOf("/"+u.getEntityName())?o.push(e[a]):t=e[a];t||u.getEntityId()||(t={method:"POST",url:"/"+u.getEntityName()}),console.log("DetailView: Main save call is %o, other calls are %o",t,o);var r=null;return u.executeSaveRequest(t).then(function(e){n=e,console.log("DetailView: Made main save call; got back %o",n),r=u.getOwnId(n),u.setEntityId(r);var t=[];return o.forEach(function(e){t.push(u.executeSaveRequest(e))}),i.all(t)}).then(function(){return console.log("DetailView: Made call to the main entity; return it's id %o",r),r})},u.addCall=function(e,t){e.url||(e.url=u.getEntityUrl()),e.method||(/\/\d*\/?$/.test(e.url)?e.method="PATCH":e.method="POST");var n=this.getSaveCall(t,e.method,e.url);if(e.hasOwnProperty("headers")&&(n=!1),n){if(e.data)for(var i in e.data)n.data[i]=e.data[i]}else n={method:e.method,url:e.url,data:e.data,headers:e.headers||{}},t.push(n)},u.getSaveCall=function(e,t,n){var i=!1;return e.some(function(e){var o=e.url===n||!e.url&&!n,a=e.method.toLowerCase()===t.toLowerCase();if(a&&o)return i=e,!0}),i},u.executeSaveRequest=function(e){if(!e)return console.log("DetailView: No call to be made"),i.when(e);var t;if(angular.isObject(e.url)){if(!e.url.path)return console.error("DetailViewController: url property is missing on path on %o",e),i.reject("Got invalid call data, path property missing on url for "+JSON.stringify(e));var n=u.getEntityId()?u.getEntityName()+"/"+u.getEntityId():u.getEntityName(),o=e.url.path.replace(/^\/*/,"").replace(/\/*$/,"");t="prepend"===e.url.mainEntity?"/"+n+"/"+o:"append"===e.url.mainEntity?"/"+o+"/"+n:e.url.path}else e.url&&0===e.url.indexOf("/")?t=e.url:(t="/"+u.getEntityName(),u.getEntityId()&&(t+="/"+u.getEntityId()),e.url&&(t+="/"+e.url));return console.log("DetailView: Make %s call to %s with %o. Call is %o, entityName is %o.",e.method,t,e.data,e,u.getEntityName()),e.data||(e.data={}),l.request({url:t,data:e.data,method:e.method,headers:e.headers})},u.generateSaveCalls=function(){var e=u.componentsRegistry.getSaveCalls().reduce(function(e,t){return u.addCall(t,e),e},[]);return e},t["delete"]=function(e){console.log("DetailView: Delete");var t=confirm(a("translate")("web.backoffice.detail.confirmDeletion"));if(t)return u.makeDeleteRequest().then(function(t){return e||(r.go("app.list",{entityName:u.getEntityName()}),n.$broadcast("notification",{type:"success",message:"web.backoffice.detail.deleteSuccess"})),!0},function(t){return e||n.$broadcast("notification",{type:"error",message:"web.backoffice.detail.deleteError",variables:{errorMessage:t}}),i.reject(t)})},u.makeDeleteRequest=function(){return console.log("DetailView: Make DELETE request"),l.request({url:"/"+u.getEntityName()+"/"+u.getEntityId(),method:"DELETE"})}}])}(),function(){"use strict";function e(e,t,n,i,o,a){this.$scope=e,this.$attrs=t,this.$compile=n,this.$rootScope=i,this.fieldTypes=o,this.name=t["for"],this.label=this.name,this.$attrs.$observe("label",function(e){this.label=e}.bind(this)),this.subcomponentsService=a,this.registry=null}var t="jb.formAutoInputTypes",n=angular.module("jb.formComponents");n.value(t,{text:"text",number:"text","boolean":"checkbox",datetime:"date-time",date:"date-time"}),n.directive("jbFormAutoInput",["$compile",function(e){return{controllerAs:"$ctrl",bindToController:!0,link:{post:function(e,t,n,i){i.init(e,t,n)},pre:function(e,t,n,i){i.preLink(e,t,n)}},controller:"AutoInputController",scope:!0}}]),e.prototype.preLink=function(e,t,n){this.registry=this.subcomponentsService.registryFor(e),this.registry.listen()},e.prototype.init=function(e,t,n){this.element=t,this.registry.registerOptionsDataHandler(this.updateElement.bind(this)),this.registry.registerYourself()},e.prototype.updateElement=function(e){var t,n=e[this.name];if(!n||!n.type)return void console.error("AutoFormElement: fieldSpec %o is missing type for field %o",e,this.name);if(t=this.fieldTypes[n.type],!t)return console.error("AutoFormElement: Unknown type %o",e.type),void console.error("AutoFormElement: elementType missing for element %o",this.element);console.log("AutoFormElement: Create new %s from %o",t,e);var i=t.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),o=angular.element("<div jb-form-"+i+'-input for="'+this.name+'" label="'+this.label+'"></div>');this.element.replaceWith(o),this.registry.unregisterOptionsDataHandler(this.updateElement),this.$compile(o)(this.$scope),this.registry.optionsDataHandler(e)},n.controller("AutoInputController",["$scope","$attrs","$compile","$rootScope",t,"JBFormComponentsService",e])}(),function(e){"use strict";var t=function(e,t,n){this.$attrs=t,this.$scope=e,this.name=t["for"],this.label=this.name,t.$observe("label",function(e){this.label=e}.bind(this)),this.subcomponentsService=n};t.prototype.updateData=function(e){this.originalData=this.$scope.data.value=e[this.name]},t.prototype.getSelectFields=function(){return this.name},t.prototype.getSaveCalls=function(){if(this.originalData===this.$scope.data.value)return[];var e={};return e[this.$scope.data.name]=this.$scope.data.value===!0,[{data:e}]},t.prototype.preLink=function(t,n,i){t.data={value:e,name:this.name,valid:!0}},t.prototype.isValid=function(){return!0},t.prototype.isRequired=function(){return!1},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this))},t.prototype.init=function(e,t,n){this.subcomponentsService.registerComponent(e,this)};var n=angular.module("jb.formComponents");n.directive("jbFormCheckboxInput",[function(){return{scope:!0,controller:"JBFormCheckboxInputController",bindToController:!0,controllerAs:"$ctrl",link:{pre:function(e,t,n,i){i.preLink(e,t,n,i)},post:function(e,t,n,i){i.init(e,t,n)}},template:'<div class="form-group"><label jb-form-label-component data-label-identifier="{{$ctrl.label}}" data-is-valid="$ctrl.isValid()" data-is-required="$ctr.isRequired()"></label><div class="col-md-9"><div class="checkbox"><input type="checkbox" data-ng-model="data.value"/></div></div></div>'}}]),n.controller("JBFormCheckboxInputController",["$scope","$attrs","JBFormComponentsService",t])}(),function(e){"use strict";function t(e){return e<10?"0"+e:e}var n=function(t,n,i){this.$attrs=n,this.$scope=t,this.subcomponentsService=i,this.originalData=e,this.date=e,this.time=!1,this.required=!0};n.prototype.getSelectFields=function(){return[this.name]},n.prototype.isRequired=function(){return this.required===!0},n.prototype.isValid=function(){return!this.isRequired()||!!this.date},n.prototype.updateData=function(t){var n=t[this.name];this.date=n?new Date(n):e,this.originalData=this.date},n.prototype.getSaveCalls=function(){var e=this.date,n=this.originalData,i={data:{}},o="";return e||n?e&&n&&e.getTime()==n.getTime()?[]:(e&&(o=e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())),i.data[this.name]=o,[i]):[]},n.prototype.init=function(e){this.subcomponentsService.registerComponent(e,this)},n.prototype.registerAt=function(e){e.registerOptionsDataHandler(this.handleOptionsData.bind(this)),e.registerGetDataHandler(this.updateData.bind(this))},n.prototype.handleOptionsData=function(e){var t=e[this.name];return t?(this.required=t.required===!0,void(this.time=t.time===!0)):console.error("AutoDateTimeInput: No field spec for %o",this.name)},n.prototype.showTime=function(){return this.time};var i=angular.module("jb.formComponents");i.directive("jbFormDateTimeInput",[function(){return{scope:{label:"@",name:"@for"},controller:"AutoDateTimeInputController",bindToController:!0,controllerAs:"$ctrl",link:function(e,t,n,i){i.init(e,t,n)},template:'<div class="form-group form-group-sm"><label jb-form-label-component data-label-identifier="{{$ctrl.label}}" data-is-required="$ctrl.isRequired()" data-is-valid="$ctrl.isValid()"></label><div data-ng-class="{ \'col-md-9\': !$ctrl.showTime(), \'col-md-5\': $ctrl.showTime() }"><input type="date" class="form-control input-sm input-date" data-ng-model="$ctrl.date"></div><div class="col-md-4" data-ng-if="$ctrl.showTime()"><input type="time" class="form-control input-sm input-time" data-ng-model="$ctrl.date" /></div></div>'}}]),i.controller("AutoDateTimeInputController",["$scope","$attrs","JBFormComponentsService",n])}(),function(e){"use strict";angular.module("jb.backofficeHiddenInput",[]).directive("hiddenInput",[function(){return{controller:"HiddenInputController",link:function(e,t,n,i){i.init(e,t,n,i)},scope:!0}}]).controller("HiddenInputController",["$scope","$attrs","JBFormComponentsService",function(e,t,n){var i,o,a=this;a.init=function(e,t,o){i=t,n.registerComponent(e,a)},a.isValid=function(){return!0},a.registerAt=function(e){},console.log("HiddenInput: for is %o, read %o (hasProperty %o) evals to %o",t["for"],t.read,t.hasOwnProperty("read"),e.$parent.$eval(t.read)),a.getSelectFields=function(){return!t.hasOwnProperty("read")||e.$parent.$eval(t.read)?[t["for"]]:[]},a.getSaveCalls=function(){var n=!t.hasOwnProperty("write")||e.$parent.$eval(t.write);if(console.log("HiddenInput: Get save calls; $attrs.data is %o, writeData is %o, data-write is %o and evals to %o",t.data,n,t.write,e.$parent.$eval(t.write)),n&&t.data){var i=t["for"]&&t["for"].indexOf(".")>-1;if(i){var a=t["for"].substring(0,t["for"].lastIndexOf(".")),r=a+"/"+t.data;return console.log("HiddenInput: Store relation %o",r),{url:r,method:"POST"}}var l={};return l[t["for"]]=t.data,console.log("HiddenInput: Store data %o",l),{url:"",data:l,method:o.getEntityId()?"PATCH":"POST"}}return!1}}])}(),function(e){"use strict";var t=function(t,n,i,o){this.$scope=t,this.$attrs=n,this.name=n["for"],this.$q=i,this.label=this.name,this.select=this.name,this.componentsService=o,this.originalData=e,this.required=!0};t.prototype.isRequired=function(){return this.required===!0},t.prototype.isValid=function(){return!this.isRequired()||!!this.$scope.data.value},t.prototype.registerAt=function(e){e.registerGetDataHandler(this.updateData.bind(this)),e.registerOptionsDataHandler(this.handleOptionsData.bind(this))},t.prototype.handleOptionsData=function(e){var t=e[this.name];return angular.isDefined(t)?void(this.required=t.required===!0):console.error("No options data available for text-field %o",this.name)},t.prototype.init=function(e){this.componentsService.registerComponent(e,this)},t.prototype.preLink=function(t){t.data={name:this.name,value:e,valid:!1}},t.prototype.updateData=function(e){e&&(this.originalData=this.$scope.data.value=e[this.name])},t.prototype.getSaveCalls=function(){if(this.originalData===this.$scope.data.value)return[];var e={};return e[this.name]=this.$scope.data.value,[{data:e}]};var n=angular.module("jb.formComponents");n.controller("JBFormTextInputController",["$scope","$attrs","$q","JBFormComponentsService",t]),n.directive("jbFormTextInput",[function(){return{scope:{label:"@",name:"@for"},controllerAs:"$ctrl",bindToController:!0,link:{post:function(e,t,n,i){i.init(e,t,n)},pre:function(e,t,n,i){i.preLink(e,t,n)}},controller:"JBFormTextInputController",template:'<div class=\'form-group form-group-sm\'><label jb-form-label-component data-label-identifier="{{$ctrl.label}}" data-is-valid="$ctrl.isValid()" data-is-required="$ctrl.isRequired()"></label><div class="col-md-9"><input type="text" data-ng-attr-id="data.name" class="form-control input-sm" data-ng-attrs-required="$ctrl.isRequired()" data-ng-model="data.value"/></div></div>'}}])}(),angular.module("jb.fileDropComponent",[]).directive("fileDropComponent",[function(){return{require:["fileDropComponent"],controller:"FileDropComponentController",controllerAs:"fileDropComponent",bindToController:!0,link:function(e,t,n,i){i[0].init(t)},scope:{supportedFileTypes:"=",files:"=model",errorHandler:"&",maxFileCount:"@"}}}]).controller("FileDropComponentController",["$scope",function(e){function t(e){u.errorHandler&&angular.isFunction(u.errorHandler)&&u.errorHandler({error:e})}function n(){d.bind("drop",o).bind("dragover",i).bind("dragenter",i).bind("dragleave",a)}function i(e){return e.preventDefault(),e.originalEvent.dataTransfer.effectAllowed="copy",!1}function o(e){e.preventDefault();var t=e.originalEvent.dataTransfer.files;return l(t),!1}function a(e){}function r(){d.find("input[type='file']").change(function(e){return e.target.files&&e.target.files.length?void l(e.target.files):void console.log("BackofficeImageComponentController: files field on ev.target missing: %o",e.target)})}function l(e){for(var n=[],i=0;i<e.length;i++){var o=e[i];s(o)?c(o):n.push(o.name)}n.length&&(console.warn("FileDropComponentController: Invalid file ",JSON.stringify(n)),t(new Error("Tried to upload files with invalid file type: "+n.join(", ")+". Allowed are "+u.supportedFileTypes.join(", "))+"."))}function s(e){return!u.supportedFileTypes||!angular.isArray(u.supportedFileTypes)||u.supportedFileTypes.indexOf(e.type)>-1}function c(t){var n=new FileReader;n.onload=function(i){var o={file:t,fileSize:t.size,mimeType:t.type,height:void 0,width:void 0,fileData:i.target.result};try{var a=new Image;a.src=n.result,a.onload=function(){var t=this;e.$apply(function(){o.width=t.width,o.height=t.height})}}catch(r){console.error("FileDropComponentController: Error reading file: %o",r)}e.$apply(function(){u.files.push(o)})},n.readAsDataURL(t)}var d,u=this;u.files=[],u.state="undefined",u.init=function(e,t){d=e,n(),r()}}]),function(){"use strict";angular.module("jb.formComponents").directive("jbFormDataComponent",[function(){return{require:["backofficeDataComponent","^detailView"],controller:"JBFormDataComponentController",controllerAs:"backofficeDataComponent",bindToController:!0,templateUrl:"backofficeDataComponentTemplate.html",link:function(e,t,n,i){i[0].init(t,i[1])},scope:{propertyName:"@for",fields:"="}}}]).controller("JBFormDataComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,i){var o,a,r=this,l={};r.init=function(e,t){o=e,a=t,a.registerOptionsDataHandler(r.updateOptionsData),a.registerGetDataHandler(r.updateData)},r.checkFields=function(){if(!angular.isArray(r.fields))throw new Error("JBFormDataComponentController: fields passed is not an array: "+JSON.stringify(r.fields));return r.fields.forEach(function(e){if(!angular.isObject(e))throw new Error("JBFormDataComponentController: field passed is not an object: "+JSON.stringify(e));if(!e.name)throw new Error("JBFormDataComponentController: field is missing name property: "+JSON.stringify(e))}),!0},r.updateData=function(e){if(r.checkFields()){if(e[r.propertyName])try{angular.isString(e[r.propertyName])?l=JSON.parse(e[r.propertyName]):angular.isObject(e[r.propertyName])?l=angular.copy(e[r.propertyName]):e[r.propertyName]||(l={})}catch(t){console.error("JBFormDataComponentController: Could not parse data "+e[r.propertyName])}r.fields.forEach(function(e){e.values.indexOf(void 0)===-1&&e.values.push(void 0),l[e.name]&&(e.selected=l[e.name])})}},r.updateOptionsData=function(e){return e[r.propertyName]?void a.register(r):void console.error("JBFormDataComponentController: Missing OPTIONS data for %o in %o",r.propertyName,e)},r.getSelectFields=function(){return[r.propertyName]},r.getSaveCalls=function(){var e=!1;if(r.fields.forEach(function(t){l[t.name]!==t.selected&&(e=!0)}),!e)return console.log("JBFormDataComponentController: No changes made."),!1;var t=l?angular.copy(l):{};return r.fields.forEach(function(e){void 0===e.selected&&t[e.name]?delete t[e.name]:void 0!==e.selected&&(t[e.name]=e.selected)}),console.log("JBFormDataComponentController: Store changes %o",t),{data:{data:JSON.stringify(t)}}}}]).run(["$templateCache",function(e){e.put("backofficeDataComponentTemplate.html","<div class='form-group form-group-sm' data-ng-repeat=\"field in backofficeDataComponent.fields\"><label data-backoffice-label data-label-identifier='{{field.name}}' data-is-required='false' data-is-valid='true'></label><div class='col-md-8'><select class='form-control' data-ng-options='value for value in field.values' data-ng-model='field.selected'></select></div><div class='col-md-1'></div></div>")}])}(),function(){"use strict";angular.module("jb.formComponents").directive("jbFormMediaGroupComponent",[function(){return{require:["backofficeMediaGroupComponent","^detailView"],controller:"JBFormMediaGroupComponentController",controllerAs:"backofficeMediaGroupComponent",bindToController:!0,templateUrl:"backofficeMediaGroupComponentTemplate.html",link:function(e,t,n,i){i[0].init(t,i[1])},scope:{propertyName:"@for"}}}]).controller("JBFormMediaGroupComponentController",["$scope","$rootScope","$q","APIWrapperService",function(e,t,n,i){function o(e,t){var n=e.mediumGroup_medium[0].sortOrder,i=t.mediumGroup_medium[0].sortOrder;return n<i?-1:1}function a(){var e=-1;return s.media.forEach(function(t){t.mediumGroup_medium&&t.mediumGroup_medium.length&&(e=Math.max(e,t.mediumGroup_medium[0].sortOrder))}),e}var r,l,s=this,c=[],d=["*","video.*","video.videoType.*","image.*","mediumGroup_medium.*","mediumGroup.*"];s.media=[],s.addMediumModel=[],s.init=function(e,t){r=e,l=t,l.registerOptionsDataHandler(s.updateOptionsData),l.registerGetDataHandler(s.updateData),s.setupAddMediumModelWatcher(),s.setupOrderChangeListener()},s.updateData=function(e){if(e[s.propertyName]){var t=e[s.propertyName]||[];try{s.media=t.sort(o)}catch(n){console.error("JBFormMediaGroupComponentController: Properties mediumGroup_medium, it's items or sortOrder missing"),s.media=t}c=angular.copy(s.media)}},s.setupOrderChangeListener=function(){r[0].addEventListener("orderChange",function(e){s.media.splice(e.detail.newOrder,0,s.media.splice(e.detail.oldOrder,1)[0])})},s.setupAddMediumModelWatcher=function(){e.$watch(function(){return s.addMediumModel},function(e){1===s.addMediumModel.length&&(s.addMedium(e[0].id),s.addMediumModel=[])},!0)},s.addMedium=function(e){return s.media.filter(function(t){return t.id===e}).length>0?void console.error("JBFormMediaGroupComponentController: Trying to add duplicate with id",e):void i.request({url:"/"+s.propertyName+"/"+e,method:"GET",headers:{select:s.getSelectFields()}}).then(function(e){s.media.push(e)},function(n){console.error("JBFormMediaGroupComponentController: Could not get data for medium with id %o: %o",e,n),t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:n}})})},s.updateOptionsData=function(e){l.register(s)},s.getSelectFields=function(){return d.map(function(e){return s.propertyName+"."+e})},s.getSaveCalls=function(){console.error(c);var e=c.map(function(e){return e.id}),t=s.media.map(function(e){return e.id}),n=[],i=[];t.forEach(function(t){e.indexOf(t)===-1&&n.push(t)}),e.forEach(function(e){t.indexOf(e)===-1&&i.push(e)});var o=[];return i.forEach(function(e){o.push({method:"DELETE",url:s.propertyName+"/"+e})}),n.forEach(function(e){o.push({method:"POST",url:s.propertyName+"/"+e})}),o},s.afterSaveTasks=function(){var e=a(),t=[];return s.media.forEach(function(n){t.push(i.request({url:"/mediumGroup/"+l.getEntityId()+"/medium/"+n.id,method:"PATCH",data:{sortOrder:++e}}))}),n.all(t)},s.isValid=function(){return!0},s.isRequired=function(){return!1},s.removeMedium=function(e){s.media.splice(s.media.indexOf(e),1)}}]).run(["$templateCache",function(e){e.put("backofficeMediaGroupComponentTemplate.html","<div class='backoffice-media-group-component'><div class='row'><div class='col-md-12'><ol class='clearfix' data-drag-drop-list><li data-ng-repeat='medium in backofficeMediaGroupComponent.media' draggable='true'><div data-ng-if='medium.image'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='{{medium.image.url}}'></div><div data-ng-if='medium.video && medium.video.videoType.identifier === \"youtube\"'><button data-ng-click='backofficeMediaGroupComponent.removeMedium(medium)'>&times;</button><img data-ng-attr-src='http://img.youtube.com/vi/{{medium.video.uri}}/0.jpg'></div></li></ol></div></div><div class='row'><div class='col-md-12'><div class=\"relation-select\" data-relation-input data-ng-attr-data-relation-entity-endpoint=\"{{backofficeMediaGroupComponent.propertyName}}\" data-relation-interactive=\"false\" data-deletable=\"false\" data-relation-entity-search-field=\"title\" data-relation-suggestion-template=\"[[title]] <img src='[[image.url]]'/>\" data-ng-model=\"backofficeMediaGroupComponent.addMediumModel\" data-multi-select=\"true\"></div></div></div></div>")}])}(),angular.module("jb.formComponents").directive("jbFormTreeComponent",[function(){return{require:["^detailView","backofficeTreeComponent"],controller:"JBFormJBFormTreeComponentController",link:function(e,t,n,i){i[1].init(t,i[0])},templateUrl:"treeTemplate.html",scope:{filter:"=treeComponentFilter",labelName:"@treeComponentLabel",entityName:"@for",maxDepth:"@"},bindToController:!0,controllerAs:"treeComponentController"}}]).controller("JBFormTreeComponentController",["$scope","$rootScope","$attrs","$location","$q","APIWrapperService",function(e,t,n,i,o,a){var r,l,s=this;n.maxDepth||10;s.dataTree=void 0,s.labelName&&s.entityName||console.warn("JBFormTreeComponentController: labelName or entityName (for) attribute missing"),s.editEntity=function(e,t){e.preventDefault(),i.path("/"+n["for"]+"/"+t)},s.init=function(e,t){r=e,l=t,l.register(s),s.getData()},s.getData=function(){var e={range:"0-0"};if(s.filter){var n="";for(var i in s.filter)n=i+"="+s.filter[i];e.filter=n}a.request({method:"GET",url:"/"+s.entityName,headers:e}).then(function(e){s.updateData(e)},function(e){t.$broadcast("notification",{type:"error",message:"web.backoffice.detail.loadingError",variables:{errorMessage:e}})})},s.updateData=function(e){s.dataTree=c(e),console.log("JBFormTreeComponentController: dataTree is %o",s.dataTree),setTimeout(function(){r.addClass("dd"),r.nestable({dragClass:"dd-dragelement",placeClass:"dd-placeholder",maxDepth:s.maxDepth})},500)},s.getSaveCalls=function(){var e=r.nestable("serialize");console.log("JBFormTreeComponentController: Store data %o",e);var t=s.cleanTreeData(e);return console.log("JBFormTreeComponentController: Cleaned data %o, got %o",e,t),{method:"POST",headers:{"Content-Type":"application/json"},url:"/"+s.entityName,data:t}},s.cleanTreeData=function(e,t){t||(t=[]);for(var n in e){var i=e[n],o={};if(o.id=i.id,s.filter)for(var a in s.filter)o[a]=s.filter[a];i.children&&(o.children=[],s.cleanTreeData(i.children,o.children)),t.push(o)}return t};var c=function(e){var t={};return e.sort(function(e,t){return e.left-t.left}),d(t,e),t.children},d=function(e,t){var n,i="right",o=0,a=[];e.children||(e.children=[]),t.forEach(function(t){t[i]>o?(o=t[i],a=[],e.children.push(t),n=t):t[i]+1===o?(a.push(t),d(n,a)):a.push(t)})}}]).run(function(e){e.put("treeBranchTemplate.html","<div class='dd-handle'><span data-ng-if='branch[ treeComponentController.labelName ]'>{{ branch[ treeComponentController.labelName ] }}</span><span data-ng-if='!branch[ treeComponentController.labelName ]'>N/A</span></div><button class='fa fa-pencil btn btn-link edit' data-ng-click='treeComponentController.editEntity($event,branch.id)'></button><ol data-ng-if='branch.children' class='dd-list'><li data-ng-repeat='branch in branch.children' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>"),e.put("treeTemplate.html","<ol><li data-ng-repeat='branch in treeComponentController.dataTree' data-ng-include='\"treeBranchTemplate.html\"' class='dd-item' data-id='{{ branch.id }}'></li></ol>")}),function(e){"use strict";function t(e){this.api=e,this.fieldTypeMapping={string:"text",decimal:"number",integer:"number","boolean":"boolean",json:"json",datetime:"datetime",date:"datetime"}}var n=angular.module("jb.backofficeAPIWrapper",["jb.apiWrapper"]);t.prototype.request=function(e,t,n){var i=n!==!1&&e?angular.copy(t):t;return i.method=e,this.api.request(i)},t.prototype.getOptions=function(e,t){var n=angular.copy(t)||{};return n.url=e,this.request("OPTIONS",n,!1).then(this.normalizeOptions.bind(this))},t.prototype.normalizeMappings=function(e,t){Object.keys(e).forEach(function(n){var i=e[n],o={};o.type="relation",o.entity=i.modelName,o.relationKey=i.key,o.relatedKey=i.primaryKey,o.relation=i.hasAlias?i.name:i.modelName,o.alias=!!i.hasAlias&&i.name,o.relationType="multiple",o.originalRelation="hasMany",o.tableName=i.table.name,"language"===o.entity&&(o.type="language"),"image"===o.entity&&(o.type="image"),t[n]=o,t.internalMappings=t.internalMappings||{},t.internalMappings[o.relation]=o})},t.prototype.normalizeReferences=function(e,t){Object.keys(e).forEach(function(n){var i=e[n],o={};o.type="relation",o.entity=i.referencedModelName,o.relation=i.hasAlias?i.name:i.referencedModelName,o.alias=!!i.hasAlias&&i.name,o.relationType="single",o.required=i.nullable===!1,o.originalRelation="hasOne",o.relationKey=i.key,o.relatedKey=i.referencedColumn,t[n]=o,t.internalReferences=t.internalReferences||{},t.internalReferences[o.relationKey]=o,"image"==o.entity&&(o.type="image")})},t.prototype.normalizeInverseReferences=function(e,t){Object.keys(e).forEach(function(n){var i=e[n];t[n]={type:"relation",entity:i.modelName,relation:i.hasAlias?i.name:i.modelName,relatedKey:i.referencedColumn,alias:!!i.hasAlias&&i.name,relationType:"multiple",required:!1,originalRelation:"belongsTo"}})},t.prototype.normalizeFields=function(e,t){Object.keys(e).forEach(function(n){var i=e[n];if(i.name&&i.type){var o=this.fieldTypeMapping[i.type];if(angular.isDefined(o)){var a={type:o,required:!i.nullable,isPrimary:i.name===e.primaryKey,name:i.name};"datetime"==o&&(a.time="datetime"===i.type),t[n]=a,angular.isUndefined(t.internalFields)&&(t.internalFields={}),t.internalFields[i.name]=a}else console.error("DetailViewController: unknown field type %o",i.type)}},this)},t.prototype.normalizeOptions=function(e){var t={},n=angular.copy(e),i=n.hasMany,o=n.belongsTo,a=n.hasOne;return delete n.hasMany,delete n.belongsTo,delete n.hasOne,this.normalizeReferences(a,t),this.normalizeInverseReferences(o,t),this.normalizeMappings(i,t),this.normalizeFields(n,t),console.log("BackofficeAPIWrapperService: parsed options are %o",t),t},n.service("BackofficeAPIWrapperService",["APIWrapperService",t])}(),function(){"use strict";angular.module("jb.formComponents").directive("dragDropList",[function(){return{link:function(t,n,i,o){var a,r=new MutationObserver(function(t){var i=0;[].forEach.call(t,function(e){e.addedNodes&&e.addedNodes.length&&(i+=e.addedNodes.length)}),i>0&&(a.destroy(),a=new e(n[0].querySelectorAll('[draggable="true"]')))});r.observe(n[0],{childList:!0}),t.$on("$destroy",function(){r.disconnect()}),a=new e(n[0].querySelectorAll('[draggable="true"]'))},scope:{}}}]);var e;!function(){function t(e){e.removeEventListener("dragstart",i)}function n(e){e.addEventListener("dragstart",i),e.addEventListener("dragenter",o),e.addEventListener("dragover",r),e.addEventListener("dragleave",a),e.addEventListener("drop",l),e.addEventListener("dragend",c)}function i(e){e.currentTarget.style.opacity="0.4",u=e.currentTarget,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.currentTarget.outerHTML)}function o(e){e.target.classList.add("drag-over")}function a(e){e.target.classList.remove("drag-over")}function r(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}function l(e){e.stopPropagation&&e.stopPropagation();var t=s(u);if(u!==e.currentTarget){console.log("dragDropList: Drop: %o after %o",u,e.currentTarget),angular.element(e.currentTarget).after(u);var n=new CustomEvent("orderChange",{bubbles:!0,detail:{oldOrder:t,newOrder:s(e.currentTarget)+1}});e.currentTarget.dispatchEvent(n)}return!1}function s(e){for(var t=e.parentNode.childNodes,n=0,i=0;i<t.length;i++){if(e===t[i])return n;1===t[i].nodeType&&n++}return-1}function c(e){u.style.opacity="1",u=void 0,[].forEach.call(d,function(e){e.classList.remove("drag-over")})}var d,u;e=function(e){d=e,console.log("DragDropList: Initialize for elements %o",e),[].forEach.call(e,function(e){e.setAttribute("draggable",!0),n(e)})},e.prototype.destroy=function(){console.log("DragDropList: Destroy event handlers on %o elements",d.length),[].forEach.call(d,function(e){t(e)})}}()}(),function(e,t,n,i){function o(t,i){this.w=e(n),this.el=e(t),this.options=e.extend({},l,i),this.init()}var a="ontouchstart"in n,r=function(){var e=n.createElement("div"),i=n.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",i.appendChild(e);var o=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return i.removeChild(e),!!o}(),l={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};o.prototype={init:function(){var n=this;n.reset(),n.el.data("nestable-group",this.options.group),n.placeEl=e('<div class="'+n.options.placeClass+'"/>'),e.each(this.el.find(n.options.itemNodeName),function(t,i){n.setParent(e(i))}),n.el.on("click","button",function(t){if(!n.dragEl){var i=e(t.currentTarget),o=i.data("action"),a=i.parent(n.options.itemNodeName);"collapse"===o&&n.collapseItem(a),"expand"===o&&n.expandItem(a)}});var i=function(t){var i=e(t.target);if(!i.hasClass(n.options.handleClass)){if(i.closest("."+n.options.noDragClass).length)return;i=i.closest("."+n.options.handleClass)}i.length&&!n.dragEl&&(n.isTouch=/^touch/.test(t.type),n.isTouch&&1!==t.touches.length||(t.preventDefault(),n.dragStart(t.touches?t.touches[0]:t)))},o=function(e){n.dragEl&&(e.preventDefault(),n.dragMove(e.touches?e.touches[0]:e))},r=function(e){n.dragEl&&(e.preventDefault(),n.dragStop(e.touches?e.touches[0]:e))};a&&(n.el[0].addEventListener("touchstart",i,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",r,!1),t.addEventListener("touchcancel",r,!1)),n.el.on("mousedown",i),n.w.on("mousemove",o),n.w.on("mouseup",r)},serialize:function(){var t,n=0,i=this,o=function(t,n){var a=[],r=t.children(i.options.itemNodeName);return r.each(function(){var t=e(this),r=e.extend({},t.data()),l=t.children(i.options.listNodeName);l.length&&(r.children=o(l,n+1)),a.push(r)}),a};return t=o(i.el.find(i.options.listNodeName).first(),n)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),
e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var o=this.mouse,a=e(t.target),r=a.closest(this.options.itemNodeName);this.placeEl.css("height",r.height()),o.offsetX=t.offsetX!==i?t.offsetX:t.pageX-a.offset().left,o.offsetY=t.offsetY!==i?t.offsetY:t.pageY-a.offset().top,o.startX=o.lastX=t.pageX,o.startY=o.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=e(n.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",r.width()),r.after(this.placeEl),r[0].parentNode.removeChild(r[0]),r.appendTo(this.dragEl),e(n.body).append(this.dragEl),this.dragEl.css({left:t.pageX-o.offsetX,top:t.pageY-o.offsetY});var l,s,c=this.dragEl.find(this.options.itemNodeName);for(l=0;l<c.length;l++)s=e(c[l]).parents(this.options.listNodeName).length,s>this.dragDepth&&(this.dragDepth=s)},dragStop:function(e){var t=this.dragEl.children(this.options.itemNodeName).first();t[0].parentNode.removeChild(t[0]),this.placeEl.replaceWith(t),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(i){var o,a,l,s,c,d=this.options,u=this.mouse;this.dragEl.css({left:i.pageX-u.offsetX,top:i.pageY-u.offsetY}),u.lastX=u.nowX,u.lastY=u.nowY,u.nowX=i.pageX,u.nowY=i.pageY,u.distX=u.nowX-u.lastX,u.distY=u.nowY-u.lastY,u.lastDirX=u.dirX,u.lastDirY=u.dirY,u.dirX=0===u.distX?0:u.distX>0?1:-1,u.dirY=0===u.distY?0:u.distY>0?1:-1;var p=Math.abs(u.distX)>Math.abs(u.distY)?1:0;if(!u.moving)return u.dirAx=p,void(u.moving=!0);u.dirAx!==p?(u.distAxX=0,u.distAxY=0):(u.distAxX+=Math.abs(u.distX),0!==u.dirX&&u.dirX!==u.lastDirX&&(u.distAxX=0),u.distAxY+=Math.abs(u.distY),0!==u.dirY&&u.dirY!==u.lastDirY&&(u.distAxY=0)),u.dirAx=p,u.dirAx&&u.distAxX>=d.threshold&&(u.distAxX=0,l=this.placeEl.prev(d.itemNodeName),u.distX>0&&l.length&&!l.hasClass(d.collapsedClass)&&(o=l.find(d.listNodeName).last(),c=this.placeEl.parents(d.listNodeName).length,c+this.dragDepth<=d.maxDepth&&(o.length?(o=l.children(d.listNodeName).last(),o.append(this.placeEl)):(o=e("<"+d.listNodeName+"/>").addClass(d.listClass),o.append(this.placeEl),l.append(o),this.setParent(l)))),u.distX<0&&(s=this.placeEl.next(d.itemNodeName),s.length||(a=this.placeEl.parent(),this.placeEl.closest(d.itemNodeName).after(this.placeEl),a.children().length||this.unsetParent(a.parent()))));var m=!1;if(r||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(n.elementFromPoint(i.pageX-n.body.scrollLeft,i.pageY-(t.pageYOffset||n.documentElement.scrollTop))),r||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(d.handleClass)&&(this.pointEl=this.pointEl.parent(d.itemNodeName)),this.pointEl.hasClass(d.emptyClass))m=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(d.itemClass))return;var f=this.pointEl.closest("."+d.rootClass),h=this.dragRootEl.data("nestable-id")!==f.data("nestable-id");if(!u.dirAx||h||m){if(h&&d.group!==f.data("nestable-group"))return;if(c=this.dragDepth-1+this.pointEl.parents(d.listNodeName).length,c>d.maxDepth)return;var g=i.pageY<this.pointEl.offset().top+this.pointEl.height()/2;a=this.placeEl.parent(),m?(o=e(n.createElement(d.listNodeName)).addClass(d.listClass),o.append(this.placeEl),this.pointEl.replaceWith(o)):g?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),a.children().length||this.unsetParent(a.parent()),this.dragRootEl.find(d.itemNodeName).length||this.dragRootEl.append('<div class="'+d.emptyClass+'"/>'),h&&(this.dragRootEl=f,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},e.fn.nestable=function(t){var n=this,i=this;return n.each(function(){var n=e(this).data("nestable");n?"string"==typeof t&&"function"==typeof n[t]&&(i=n[t]()):(e(this).data("nestable",new o(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),i||n}}(window.jQuery||window.Zepto,window,document);